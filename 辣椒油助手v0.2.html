<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#5662f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="format-detection" content="telephone=no">
    <title>è¾£æ¤’æ²¹åŠ©æ‰‹ - ä¸ªäººèŠå¤©</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/default.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/javascript.min.js"></script>
    <style>
        :root {
            --primary-color: #5662f6;
            --primary-dark: #4550d3;
            --text-color: #333;
            --text-secondary: #666;
            --bg-color: #f5f5f7;
            --card-color: #fff;
            --border-color: #e0e0e0;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --chat-user-bg: #5662f6;
            --chat-user-text: white;
            --chat-ai-bg: #fff;
            --chat-ai-text: #333;
            --error-color: #ff3860;
            --success-color: #23d160;
        }
        
        [data-theme="dark"] {
            --primary-color: #6c79ff;
            --primary-dark: #5662f6;
            --text-color: #f0f0f0;
            --text-secondary: #ccc;
            --bg-color: #1e1e2e;
            --card-color: #282a36;
            --border-color: #3d3d5c;
            --shadow-color: rgba(0, 0, 0, 0.3);
            --chat-user-bg: #6c79ff;
            --chat-user-text: white;
            --chat-ai-bg: #282a36;
            --chat-ai-text: #f0f0f0;
            --error-color: #ff5c7b;
            --success-color: #5cff7b;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s ease;
        }
        
        .header {
            background-color: var(--card-color);
            padding: 16px 24px;
            box-shadow: 0 1px 3px var(--shadow-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.3s ease;
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .logo-icon {
            font-size: 28px;
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .theme-toggle {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-color);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            transition: background-color 0.2s;
        }
        
        .theme-toggle:hover {
            background-color: var(--shadow-color);
        }
        
        .new-chat-btn, .export-btn, .import-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        
        .new-chat-btn:hover, .export-btn:hover, .import-btn:hover {
            background-color: var(--primary-dark);
        }
        
        .export-btn, .import-btn {
            background-color: transparent;
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }
        
        .export-btn:hover, .import-btn:hover {
            background-color: var(--bg-color);
        }
        
        .container {
            display: flex;
            height: calc(100vh - 68px);
        }
        
        .sidebar {
            width: 260px;
            background-color: var(--card-color);
            padding: 16px;
            overflow-y: auto;
            border-right: 1px solid var(--border-color);
            transition: background-color 0.3s ease;
        }
        
        .sidebar-header {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-color);
        }
        
        .chat-history {
            list-style-type: none;
        }
        
        .chat-item {
            padding: 10px 12px;
            margin-bottom: 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-item:hover {
            background-color: var(--bg-color);
        }
        
        .chat-item.active {
            background-color: rgba(86, 98, 246, 0.1);
            border-left: 3px solid var(--primary-color);
        }
        
        .chat-title {
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            flex: 1;
        }
        
        .delete-chat {
            opacity: 0;
            width: 16px;
            height: 16px;
            color: var(--text-secondary);
            cursor: pointer;
            margin-left: 8px;
            transition: opacity 0.2s, color 0.2s;
        }
        
        .chat-item:hover .delete-chat {
            opacity: 1;
        }
        
        .delete-chat:hover {
            color: var(--error-color);
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
        }
        
        .modal-content {
            background-color: var(--card-color);
            border-radius: 8px;
            padding: 24px;
            width: 400px;
            max-width: 90vw;
            text-align: center;
            box-shadow: 0 4px 12px var(--shadow-color);
        }
        
        .modal-title {
            font-size: 18px;
            margin-bottom: 16px;
            font-weight: 600;
            color: var(--text-color);
        }
        
        .modal-message {
            margin-bottom: 24px;
            color: var(--text-secondary);
        }
        
        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 12px;
        }
        
        .modal-btn {
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            border: none;
            min-width: 100px;
        }
        
        .cancel-btn {
            background-color: var(--bg-color);
            color: var(--text-color);
        }
        
        .delete-btn {
            background-color: var(--error-color);
            color: white;
        }
        
        .confirm-btn {
            background-color: var(--primary-color);
            color: white;
        }
        
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        .welcome {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 24px;
            text-align: center;
        }
        
        .welcome h1 {
            font-size: 32px;
            margin-bottom: 16px;
            color: var(--text-color);
        }
        
        .welcome p {
            font-size: 16px;
            color: var(--text-secondary);
            max-width: 600px;
            margin-bottom: 32px;
        }
        
        .suggestion-container {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
            max-width: 800px;
        }
        
        .suggestion {
            background-color: var(--card-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            width: 250px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .suggestion:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--shadow-color);
        }
        
        .suggestion h3 {
            font-size: 16px;
            margin-bottom: 8px;
            color: var(--text-color);
        }
        
        .suggestion p {
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .chat-container {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
            display: none;
            flex-direction: column;
        }
        
        .message {
            max-width: 80%;
            margin-bottom: 24px;
            display: flex;
            flex-direction: column;
        }
        
        .message.user {
            align-self: flex-end;
            margin-left: auto;
        }
        
        .message.ai {
            align-self: flex-start;
            margin-right: auto;
        }
        
        .message-header {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
        }
        
        .message-header .avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            margin-right: 8px;
            overflow: hidden;
        }
        
        .message-header .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .message-header .name {
            font-weight: 600;
            font-size: 14px;
            color: var(--text-color);
        }
        
        .message.user .message-header .avatar {
            background-color: var(--text-color);
        }
        
        .message-content {
            background-color: var(--chat-ai-bg);
            padding: 12px 16px;
            border-radius: 12px;
            box-shadow: 0 1px 2px var(--shadow-color);
            font-size: 15px;
            line-height: 1.5;
            color: var(--chat-ai-text);
            max-width: 100%;
            overflow-x: auto;
        }
        
        .message.user .message-content {
            background-color: var(--chat-user-bg);
            color: var(--chat-user-text);
        }
        
        .message.ai .message-content {
            background-color: var(--chat-ai-bg);
            border: 1px solid var(--border-color);
        }
        
        /* Code block styling */
        .message-content pre {
            background-color: #2d2d2d;
            border-radius: 4px;
            padding: 12px;
            margin: 8px 0 16px 0;
            overflow-x: auto;
            position: relative;
            max-width: 100%;
            white-space: pre;
            word-wrap: normal;
            display: block;
            clear: both;
        }
        
        .message-content pre code {
            font-family: monospace;
            font-size: 14px;
            line-height: 1.5;
            max-width: 100%;
            white-space: pre;
            word-wrap: normal;
            tab-size: 4;
            display: block;
        }
        
        .copy-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            background-color: rgba(255, 255, 255, 0.1);
            color: #ddd;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .copy-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .input-container {
            position: sticky;
            bottom: 0;
            padding: 16px 24px;
            background-color: var(--bg-color);
            display: flex;
            flex-direction: column;
            box-shadow: 0 -1px 3px var(--shadow-color);
            transition: background-color 0.3s ease;
        }
        
        .message-controls {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .token-counter {
            color: var(--text-secondary);
            font-size: 14px;
            margin-right: auto;
        }
        
        .token-counter.warning {
            color: #ff9800;
        }
        
        .token-counter.error {
            color: var(--error-color);
        }
        
        .input-wrapper {
            display: flex;
            align-items: flex-end;
        }
        
        .input-box {
            flex: 1;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 15px;
            background-color: var(--card-color);
            color: var(--text-color);
            resize: none;
            max-height: 200px;
            overflow-y: auto;
            transition: border-color 0.2s;
        }
        
        .input-box:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .send-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-left: 12px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.2s;
        }
        
        .send-btn:hover {
            background-color: var(--primary-dark);
        }
        
        .send-btn:disabled {
            background-color: var(--border-color);
            cursor: not-allowed;
        }
        
        .typing-indicator {
            display: inline-block;
            margin-top: 6px;
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .dot {
            display: inline-block;
            width: 5px;
            height: 5px;
            border-radius: 50%;
            margin-right: 3px;
            background-color: var(--text-secondary);
            animation: pulse 1.5s infinite ease-in-out;
        }
        
        .dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 0.4;
            }
            50% {
                opacity: 1;
            }
        }
        
        /* APIå¯†é’¥è®¾ç½®é¢æ¿ */
        .settings-btn {
            background: none;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            padding: 8px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        .settings-btn:hover {
            background-color: var(--bg-color);
        }
        
        .settings-content {
            background-color: var(--card-color);
            border-radius: 8px;
            padding: 24px;
            width: 400px;
            max-width: 90vw;
        }
        
        .settings-title {
            font-size: 20px;
            margin-bottom: 16px;
            font-weight: 600;
            color: var(--text-color);
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-color);
        }
        
        .form-group select, .form-group input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
            background-color: var(--card-color);
            color: var(--text-color);
        }
        
        .form-group select:focus, .form-group input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .settings-buttons {
            display: flex;
            justify-content: flex-end;
            margin-top: 24px;
            gap: 8px;
        }
        
        .settings-btn-save {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .settings-btn-cancel {
            background-color: var(--bg-color);
            color: var(--text-color);
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .small-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            font-size: 12px;
        }
        
        .input-with-button {
            display: flex;
            gap: 8px;
        }
        
        .input-with-button input {
            flex: 1;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
        }
        
        /* è‡ªå®šä¹‰æ–‡ä»¶ä¸Šä¼ æŒ‰é’® */
        .file-input {
            width: 0.1px;
            height: 0.1px;
            opacity: 0;
            overflow: hidden;
            position: absolute;
            z-index: -1;
        }
        
        .file-label {
            background-color: var(--bg-color);
            color: var(--text-color);
            display: inline-block;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            text-align: center;
            margin-top: 16px;
            transition: background-color 0.2s;
        }
        
        .file-label:hover {
            background-color: var(--border-color);
        }
        
        /* å¤´åƒä¸Šä¼ ç›¸å…³æ ·å¼ */
        .avatar-upload-container {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-top: 8px;
        }
        
        .avatar-preview {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            overflow: hidden;
            border: 2px solid var(--border-color);
        }
        
        .avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .avatar-controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .avatar-controls .file-label {
            margin-top: 0;
        }
        
        .avatar-large {
            font-size: 48px;
            width: 100px;
            height: 100px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 24px;
            overflow: hidden;
        }
        
        .avatar-large img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            padding: 12px 16px;
            border-radius: 4px;
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: translateY(100px);
            opacity: 0;
            transition: transform 0.3s, opacity 0.3s;
            z-index: 1100;
        }
        
        .toast.success {
            background-color: var(--success-color);
        }
        
        .toast.error {
            background-color: var(--error-color);
        }
        
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        /* ç½‘ç»œçŠ¶æ€æŒ‡ç¤ºå™¨ */
        .network-status {
            position: fixed;
            top: 16px;
            right: 16px;
            padding: 8px 12px;
            border-radius: 4px;
            background-color: var(--error-color);
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1100;
            display: none;
        }
        
        /* å“åº”å¼æ ·å¼ */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                max-height: 150px;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }
            
            .welcome {
                padding: 16px;
            }
            
            .welcome h1 {
                font-size: 24px;
            }
            
            .suggestion-container {
                gap: 8px;
            }
            
            .suggestion {
                width: 100%;
                padding: 12px;
            }
            
            .message {
                max-width: 90%;
            }
            
            .header-actions {
                gap: 6px;
            }
            
            .export-btn span, .import-btn span, .settings-btn span {
                display: none;
            }
            
            .input-container {
                padding: 12px;
            }
            
            /* æ¨¡æ€çª—å£æ”¹è¿› */
            .modal-content, .settings-content {
                max-width: 90vw;
            }
            
            /* è¡¨å•æ§ä»¶åœ¨ç§»åŠ¨ç«¯æ›´å®¹æ˜“è§¦æ‘¸ */
            .form-group select, .form-group input, .form-group textarea {
                font-size: 16px; /* é˜²æ­¢iOSä¸Šè‡ªåŠ¨æ”¾å¤§ */
                padding: 10px;
            }
            
            .settings-buttons, .modal-buttons {
                flex-direction: column;
                gap: 10px;
            }
            
            .modal-btn, .settings-btn-save, .settings-btn-cancel {
                width: 100%;
                padding: 12px;
            }
            
            /* å¤´åƒä¸Šä¼ æ§ä»¶ä¼˜åŒ– */
            .avatar-upload-container {
                flex-direction: column;
                align-items: center;
                gap: 12px;
            }
            
            .avatar-controls {
                width: 100%;
                align-items: center;
            }
            
            .file-label {
                width: 100%;
                text-align: center;
            }
        }

        /* å¢å¼ºçš„ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 480px) {
            .header {
                padding: 12px 16px;
            }
            
            .logo {
                font-size: 20px;
            }
            
            .logo-icon {
                font-size: 24px;
            }
            
            .new-chat-btn {
                padding: 6px 12px;
                font-size: 14px;
            }
            
            .theme-toggle, .export-btn, .import-btn, .settings-btn {
                width: 32px;
                height: 32px;
                padding: 4px;
                display: flex;
                justify-content: center;
                align-items: center;
            }
            
            .sidebar {
                max-height: 120px;
                padding: 12px;
                overflow-y: auto;
                width: 100%; /* ç¡®ä¿å®½åº¦ä¸º100% */
                height: auto; /* è‡ªé€‚åº”é«˜åº¦ */
                display: block; /* ç¡®ä¿æ˜¾ç¤º */
            }
            
            .sidebar-header {
                margin-bottom: 8px;
                font-size: 14px;
            }
            
            .chat-item {
                padding: 8px;
                margin-bottom: 6px;
                font-size: 14px;
            }
            
            .welcome h1 {
                font-size: 22px;
                margin-bottom: 12px;
            }
            
            .welcome p {
                font-size: 14px;
                margin-bottom: 24px;
            }
            
            .avatar-large {
                width: 80px;
                height: 80px;
                font-size: 36px;
                margin-bottom: 16px;
            }
            
            .message-header .avatar {
                width: 24px;
                height: 24px;
            }
            
            .message-content {
                padding: 10px 12px;
                font-size: 14px;
            }
            
            .message-content pre {
                padding: 8px;
                font-size: 13px;
            }
            
            .input-container {
                padding: 8px;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                z-index: 100;
                background-color: var(--bg-color); /* ç¡®ä¿åº•è‰²æ­£ç¡® */
            }
            
            .input-box {
                padding: 10px 12px;
                font-size: 16px; /* é˜²æ­¢iOSç¼©æ”¾ */
                appearance: none;
                -webkit-appearance: none;
                min-height: 44px;
                border-radius: 20px;
            }
            
            .send-btn {
                width: 44px;
                height: 44px;
            }
            
            /* ä¸ºå›ºå®šçš„è¾“å…¥æ¡†æ·»åŠ åº•éƒ¨ç©ºé—´ */
            .main {
                padding-bottom: 80px;
            }
            
            /* åœ¨ç‰¹å°å±å¹•ä¸Šè°ƒæ•´æ¨¡æ€çª—å£ */
            .modal-content, .settings-content {
                width: 90%;
                padding: 16px;
                max-height: 90vh; /* é™åˆ¶æœ€å¤§é«˜åº¦ */
                overflow-y: auto; /* å†…å®¹è¿‡å¤šæ—¶å…è®¸æ»šåŠ¨ */
            }
            
            .modal-title, .settings-title {
                font-size: 18px;
                margin-bottom: 12px;
                position: sticky; /* æ ‡é¢˜ä¿æŒåœ¨é¡¶éƒ¨ */
                top: 0;
                background-color: var(--card-color);
                z-index: 10;
                padding: 8px 0;
            }
            
            .form-group {
                margin-bottom: 12px;
            }
            
            .form-group label {
                font-size: 14px;
                margin-bottom: 6px;
            }
            
            /* è§£å†³è®¾ç½®æŒ‰é’®æ¶ˆå¤±é—®é¢˜ */
            .settings-buttons {
                display: flex;
                flex-direction: column;
                gap: 10px;
                position: sticky;
                bottom: 0;
                background-color: var(--card-color);
                padding: 8px 0;
                z-index: 10;
            }
            
            .settings-btn-save, .settings-btn-cancel {
                width: 100%;
                padding: 12px;
                font-size: 16px;
            }
        }
        
        /* é€‚é…æ¨ªå±æ¨¡å¼ */
        @media (max-height: 500px) and (orientation: landscape) {
            .header {
                padding: 8px 16px;
            }
            
            .container {
                height: calc(100vh - 52px);
            }
            
            .sidebar {
                padding: 8px;
                max-height: none;
                width: 200px;
                display: block;
                overflow-y: auto;
            }
            
            .welcome {
                padding: 12px;
            }
            
            .avatar-large {
                width: 60px;
                height: 60px;
                margin-bottom: 12px;
            }
            
            .chat-container {
                padding: 12px;
            }
            
            .message {
                margin-bottom: 16px;
            }
            
            .input-container {
                padding: 8px;
            }
            
            /* ç¡®ä¿è®¾ç½®æŒ‰é’®åœ¨æ¨ªå±æ¨¡å¼ä¸‹å¯è§ */
            .settings-buttons {
                position: sticky;
                bottom: 0;
                background-color: var(--card-color);
                padding: 8px 0;
                z-index: 10;
            }
        }
        
        /* æ·»åŠ ä¾§è¾¹æ åˆ‡æ¢åŠŸèƒ½çš„æ ·å¼ */
        .sidebar-toggle {
            display: none;
        }
        
        @media (max-width: 768px) {
            .sidebar-toggle {
                display: block;
                position: fixed;
                left: 10px;
                bottom: 10px;
                background-color: var(--primary-color);
                color: white;
                width: 40px;
                height: 40px;
                border-radius: 50%;
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 100;
                box-shadow: 0 2px 5px var(--shadow-color);
                border: none;
                cursor: pointer;
            }
            
            .sidebar.collapsed {
                max-height: 0;
                padding-top: 0;
                padding-bottom: 0;
                overflow: hidden;
                transition: max-height 0.3s ease, padding 0.3s ease;
            }
            
            /* ç¡®ä¿å†å²å¯¹è¯å§‹ç»ˆå¯è§ */
            .chat-history {
                min-height: 30px;
                overflow-y: auto;
                max-height: 100px;
            }
        }
        
        /* å…³é”®ç§»åŠ¨ç«¯ä¼˜åŒ–ï¼Œè§£å†³å¸¸è§é—®é¢˜ */
        @media (max-width: 768px) {
            /* ç¡®ä¿è®¾ç½®æ¨¡æ€æ¡†åœ¨ç§»åŠ¨ç«¯èƒ½æ­£ç¡®æ˜¾ç¤º */
            .settings-content {
                overflow-y: auto;
                max-height: 80vh;
                padding-bottom: 60px; /* ä¸ºåº•éƒ¨æŒ‰é’®é¢„ç•™ç©ºé—´ */
            }
            
            /* ç§»åŠ¨ç«¯å†å²è®°å½•é¡¹ä¼˜åŒ– */
            .chat-item {
                display: flex;
                justify-content: space-between;
                padding: 10px 8px;
            }
            
            .chat-item .delete-chat {
                opacity: 0.7; /* åœ¨ç§»åŠ¨ç«¯å§‹ç»ˆæ˜¾ç¤ºåˆ é™¤æŒ‰é’® */
            }
            
            /* è§£å†³é»˜è®¤å¤´åƒæ˜¾ç¤ºé—®é¢˜ */
            .avatar-preview img,
            .avatar-large img,
            .message-header .avatar img {
                width: 100%;
                height: 100%;
                object-fit: cover;
                display: block;
            }
            
            /* ä¿®å¤æ¨¡æ€çª—å£åœ¨æŸäº›æœºå‹ä¸Šçš„æ»šåŠ¨é—®é¢˜ */
            .modal {
                -webkit-overflow-scrolling: touch;
            }
            
            /* ä¿®å¤ç§»åŠ¨ç«¯è®¾ç½®é¡µé¢è¾“å…¥æ¡†å’ŒæŒ‰é’® */
            .settings-content input, 
            .settings-content select,
            .settings-content button {
                font-size: 16px; /* é˜²æ­¢iOSç¼©æ”¾ */
                height: auto;
                min-height: 44px; /* å¢åŠ è§¦æ‘¸åŒºåŸŸ */
            }
            
            /* ç¡®ä¿æäº¤æŒ‰é’®ä¸ä¼šè¢«è¾“å…¥æ¡†é®æŒ¡ */
            .settings-buttons {
                background-color: var(--card-color);
                position: sticky;
                bottom: 0;
                margin-top: 15px;
                padding-top: 10px;
                border-top: 1px solid var(--border-color);
                z-index: 10;
            }
        }

        /* ç§»åŠ¨è®¾å¤‡é€‚é…ä¼˜åŒ– */
        @media (max-width: 768px) {
            .header {
                padding: 12px 16px;
            }
            
            .logo {
                font-size: 20px;
            }
            
            .sidebar {
                width: 80%;
                max-width: 300px;
                position: fixed;
                top: 68px;
                bottom: 0;
                left: 0;
                z-index: 10;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                border-right: none;
                box-shadow: 2px 0 5px var(--shadow-color);
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .sidebar-toggle {
                display: flex;
                align-items: center;
                justify-content: center;
                width: 36px;
                height: 36px;
                background: none;
                border: none;
                color: var(--text-color);
                cursor: pointer;
            }
            
            .chat-container {
                padding: 16px;
            }
            
            .message-bubble {
                padding: 12px;
                max-width: 90%;
            }
            
            .input-container {
                padding: 12px 16px;
            }
            
            .input-box {
                font-size: 16px;
                padding: 10px 14px;
            }
            
            .message-content {
                font-size: 15px;
                line-height: 1.5;
            }
            
            .message-content pre {
                margin: 8px 0 16px 0;
                padding: 10px;
                font-size: 13px;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .message-content pre code {
                font-size: 13px;
            }
            
            /* ç¡®ä¿è¡¨å•å…ƒç´ åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šå­—ä½“è¶³å¤Ÿå¤§ä»¥é¿å…è‡ªåŠ¨ç¼©æ”¾ */
            input[type="text"],
            input[type="password"],
            textarea,
            select {
                font-size: 16px !important;
            }
            
            /* ä¼˜åŒ–æ¨¡æ€æ¡†åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šçš„æ˜¾ç¤º */
            .settings-content {
                width: 95%;
                max-width: 500px;
                max-height: 85vh;
                padding: 16px;
                overflow-y: auto;
            }
        }

        /* åŠ è½½çŠ¶æ€æ ·å¼ */
        .loading {
            display: inline-block;
            position: relative;
            width: 80px;
            height: 30px;
            margin: 10px 0;
        }
        .loading div {
            position: absolute;
            top: 10px;
            width: 13px;
            height: 13px;
            border-radius: 50%;
            background: var(--primary-color);
            animation-timing-function: cubic-bezier(0, 1, 1, 0);
        }
        .loading div:nth-child(1) {
            left: 8px;
            animation: loading1 0.6s infinite;
        }
        .loading div:nth-child(2) {
            left: 8px;
            animation: loading2 0.6s infinite;
        }
        .loading div:nth-child(3) {
            left: 32px;
            animation: loading2 0.6s infinite;
        }
        .loading div:nth-child(4) {
            left: 56px;
            animation: loading3 0.6s infinite;
        }
        @keyframes loading1 {
            0% { transform: scale(0); }
            100% { transform: scale(1); }
        }
        @keyframes loading2 {
            0% { transform: translate(0, 0); }
            100% { transform: translate(24px, 0); }
        }
        @keyframes loading3 {
            0% { transform: scale(1); }
            100% { transform: scale(0); }
        }

        /* æ€§èƒ½ä¼˜åŒ– */
        .chat-container {
            contain: content;
            will-change: transform;
        }
        .message-bubble {
            contain: layout style;
        }
        
        /* æ¶ˆæ¯å›¾ç‰‡æ ·å¼ */
        .message-image {
            max-width: 100%;
            border-radius: 4px;
            margin: 8px 0;
            display: block;
        }
        
        /* ç§»åŠ¨è®¾å¤‡é€‚é…ä¼˜åŒ– */
        @media (max-width: 768px) {
            .header {
                padding: 12px 16px;
            }
            
            .logo {
                font-size: 20px;
            }
            
            .sidebar {
                width: 80%;
                max-width: 300px;
                position: fixed;
                top: 68px;
                bottom: 0;
                left: 0;
                z-index: 10;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                border-right: none;
                box-shadow: 2px 0 5px var(--shadow-color);
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .sidebar-toggle {
                display: flex;
                align-items: center;
                justify-content: center;
                width: 36px;
                height: 36px;
                background: none;
                border: none;
                color: var(--text-color);
                cursor: pointer;
            }
            
            .chat-container {
                padding: 16px;
            }
            
            .message-bubble {
                padding: 12px;
                max-width: 90%;
            }
            
            .input-container {
                padding: 12px 16px;
            }
            
            .input-box {
                font-size: 16px;
                padding: 10px 14px;
            }
            
            .message-content {
                font-size: 15px;
                line-height: 1.5;
            }
            
            .message-content pre {
                margin: 8px 0 16px 0;
                padding: 10px;
                font-size: 13px;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .message-content pre code {
                font-size: 13px;
            }
            
            /* ç¡®ä¿è¡¨å•å…ƒç´ åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šå­—ä½“è¶³å¤Ÿå¤§ä»¥é¿å…è‡ªåŠ¨ç¼©æ”¾ */
            input[type="text"],
            input[type="password"],
            textarea,
            select {
                font-size: 16px !important;
            }
            
            /* ä¼˜åŒ–æ¨¡æ€æ¡†åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šçš„æ˜¾ç¤º */
            .settings-content {
                width: 95%;
                max-width: 500px;
                max-height: 85vh;
                padding: 16px;
                overflow-y: auto;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">
            <span class="logo-icon">ğŸŒ¶ï¸</span> è¾£æ¤’æ²¹åŠ©æ‰‹
        </div>
        <div class="header-actions">
            <button class="theme-toggle" aria-label="åˆ‡æ¢ä¸»é¢˜">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="sun-icon">
                    <circle cx="12" cy="12" r="5"></circle>
                    <line x1="12" y1="1" x2="12" y2="3"></line>
                    <line x1="12" y1="21" x2="12" y2="23"></line>
                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                    <line x1="1" y1="12" x2="3" y2="12"></line>
                    <line x1="21" y1="12" x2="23" y2="12"></line>
                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                </svg>
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="moon-icon" style="display: none;">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                </svg>
            </button>
            <button class="export-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="17 8 12 3 7 8"></polyline>
                    <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                <span>å¯¼å‡ºå¯¹è¯</span>
            </button>
            <button class="import-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                <span>å¯¼å…¥å¯¹è¯</span>
            </button>
            <input type="file" id="import-file" class="file-input" accept=".json">
            <button class="settings-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                </svg>
                <span>è®¾ç½®</span>
            </button>
            <button class="new-chat-btn">æ–°å¯¹è¯</button>
        </div>
    </div>
    
    <!-- è®¾ç½®é¢æ¿ -->
    <div class="modal" id="settings-modal">
        <div class="settings-content">
            <div class="settings-title">APIè®¾ç½®</div>
            
            <div class="form-group">
                <label for="api-provider">é€‰æ‹©APIæä¾›å•†</label>
                <select id="api-provider">
                    <option value="openai">OpenAI (GPT)</option>
                    <option value="anthropic">Anthropic (Claude)</option>
                    <option value="deepseek">DeepSeek</option>
                </select>
            </div>
            
            <div class="form-group">
                <label id="api-key-label" for="api-key">OpenAI APIå¯†é’¥</label>
                <input type="password" id="api-key" placeholder="è¾“å…¥æ‚¨çš„APIå¯†é’¥">
                <div class="api-key-status" style="margin-top: 4px; font-size: 12px;"></div>
                <button id="restore-default-key" class="small-btn" style="margin-top: 8px;">æ¢å¤é»˜è®¤å¯†é’¥</button>
            </div>
            
            <div class="form-group" id="base-url-container" style="display: none;">
                <label for="base-url">APIåŸºç¡€URL</label>
                <input type="text" id="base-url" placeholder="APIåŸºç¡€URL">
            </div>
            
            <div class="form-group" id="model-selector-openai">
                <label for="openai-model">é€‰æ‹©æ¨¡å‹</label>
                <select id="openai-model">
                    <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                    <option value="gpt-4">GPT-4</option>
                    <option value="gpt-4-turbo">GPT-4 Turbo</option>
                    <option value="gpt-4o">GPT-4o</option>
                </select>
            </div>
            
            <div class="form-group" id="model-selector-anthropic" style="display: none;">
                <label for="anthropic-model">é€‰æ‹©æ¨¡å‹</label>
                <select id="anthropic-model">
                    <option value="claude-3-opus-20240229">Claude 3 Opus</option>
                    <option value="claude-3-sonnet-20240229">Claude 3 Sonnet</option>
                    <option value="claude-3-haiku-20240307">Claude 3 Haiku</option>
                    <option value="claude-3.5-sonnet">Claude 3.5 Sonnet</option>
                    <option value="claude-3.7-sonnet">Claude 3.7 Sonnet</option>
                </select>
            </div>
            
            <div class="form-group" id="model-selector-deepseek" style="display: none;">
                <label for="deepseek-model">é€‰æ‹©æ¨¡å‹</label>
                <select id="deepseek-model">
                    <option value="deepseek-chat">DeepSeek Chat</option>
                    <option value="deepseek-coder">DeepSeek Coder</option>
                </select>
            </div>
            
            <div class="form-group">
                <div class="checkbox-group">
                    <input type="checkbox" id="stream-response" checked>
                    <label for="stream-response">å¯ç”¨æµå¼å“åº”ï¼ˆå®æ—¶æ˜¾ç¤ºå›å¤ï¼‰</label>
                </div>
            </div>
            
            <div class="form-group">
                <div class="checkbox-group">
                    <input type="checkbox" id="encrypt-keys">
                    <label for="encrypt-keys">åŠ å¯†å­˜å‚¨APIå¯†é’¥ï¼ˆæ¨èï¼‰</label>
                </div>
            </div>
            
            <div class="form-group">
                <label for="custom-avatar">è‡ªå®šä¹‰å¤´åƒ</label>
                <div class="avatar-upload-container">
                    <div class="avatar-preview">
                        <img id="avatar-preview" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%235662f6'/%3E%3Ctext x='50' y='65' font-size='50' text-anchor='middle' fill='white'%3Eè¾£%3C/text%3E%3C/svg%3E" alt="å¤´åƒé¢„è§ˆ">
                    </div>
                    <div class="avatar-controls">
                        <input type="file" id="avatar-upload" class="file-input" accept="image/*">
                        <label for="avatar-upload" class="file-label">é€‰æ‹©å›¾ç‰‡</label>
                        <button id="reset-avatar" class="small-btn">æ¢å¤é»˜è®¤</button>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="system-prompt-auth">ç³»ç»Ÿæç¤ºè¯ (éœ€è¦ç®¡ç†å¯†ç )</label>
                <div id="system-prompt-auth-container">
                    <div class="input-with-button">
                        <input type="password" id="admin-password" placeholder="è¾“å…¥ç®¡ç†å¯†ç æŸ¥çœ‹/ç¼–è¾‘ç³»ç»Ÿæç¤ºè¯">
                        <button id="verify-password-btn" class="small-btn">éªŒè¯</button>
                    </div>
                </div>
                <div id="system-prompt-container" style="display: none;">
                    <textarea id="system-prompt" rows="6" style="width: 100%; margin-top: 8px;"></textarea>
                    <div style="display: flex; justify-content: flex-end; margin-top: 8px;">
                        <button id="reset-system-prompt" class="small-btn">æ¢å¤é»˜è®¤</button>
                    </div>
                </div>
            </div>
            
            <div class="settings-buttons">
                <button class="settings-btn-cancel">å–æ¶ˆ</button>
                <button class="settings-btn-save">ä¿å­˜è®¾ç½®</button>
            </div>
        </div>
    </div>
    
    <!-- ç¡®è®¤å¯¹è¯æ¡† -->
    <div class="modal" id="confirmation-modal">
        <div class="modal-content">
            <div class="modal-title">ç¡®è®¤åˆ é™¤</div>
            <div class="modal-message">ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¯¹è¯å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚</div>
            <div class="modal-buttons">
                <button class="modal-btn cancel-btn">å–æ¶ˆ</button>
                <button class="modal-btn delete-btn">åˆ é™¤</button>
            </div>
        </div>
    </div>
    
    <!-- å¯¼å‡ºå¯¼å…¥å¯¹è¯æ¡† -->
    <div class="modal" id="export-modal">
        <div class="modal-content">
            <div class="modal-title">å¯¼å‡ºå¯¹è¯</div>
            <div class="modal-message">å·²ç”Ÿæˆå¯¹è¯å†å²æ–‡ä»¶ï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ä¸‹è½½ã€‚</div>
            <div class="modal-buttons">
                <button class="modal-btn cancel-btn">å–æ¶ˆ</button>
                <a href="#" id="download-link" class="modal-btn confirm-btn" download="ai-chat-history.json">ä¸‹è½½æ–‡ä»¶</a>
            </div>
        </div>
    </div>
    
    <!-- ç½‘ç»œçŠ¶æ€æç¤º -->
    <div class="network-status">ç½‘ç»œè¿æ¥å·²æ–­å¼€ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½ä¸å¯ç”¨</div>
    
    <!-- Toast é€šçŸ¥ -->
    <div class="toast"></div>
    
    <!-- ä¾§è¾¹æ åˆ‡æ¢æŒ‰é’® -->
    <button class="sidebar-toggle">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
    </button>
    
    <div class="container">
        <div class="sidebar">
            <div class="sidebar-header">å†å²å¯¹è¯</div>
            <ul class="chat-history">
                <!-- å†å²å¯¹è¯å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </ul>
        </div>
        
        <div class="main">
            <div class="welcome">
                <div class="avatar-container">
                    <div class="avatar-large" id="welcome-avatar">ğŸŒ¶ï¸</div>
                </div>
                <h1>ä½ å¥½ï¼æˆ‘æ˜¯è¾£æ¤’æ²¹</h1>
                <p>æˆ‘æ˜¯ä½ åœ¨æ³•å›½ç•™å­¦çš„å¥½å“¥ä»¬ï¼</p>
                
                <div class="suggestion-container">
                    <div class="suggestion">
                        <h3>èŠæ¸¸æˆ</h3>
                        <p>æœ€è¿‘LOLæœ‰ä»€ä¹ˆç‰ˆæœ¬æ›´æ–°å—ï¼Ÿæˆ‘å¥½ä¹…æ²¡ç©äº†</p>
                    </div>
                    <div class="suggestion">
                        <h3>èŠå­¦ä¹ </h3>
                        <p>å¬è¯´ä½ å­¦æ•°å­¦çš„ï¼Œå¾®ç§¯åˆ†éš¾å­¦å—ï¼Ÿæœ‰ä»€ä¹ˆå­¦ä¹ å»ºè®®ï¼Ÿ</p>
                    </div>
                    <div class="suggestion">
                        <h3>èŠæ³•å›½ç”Ÿæ´»</h3>
                        <p>ä½ åœ¨æ³•å›½ç•™å­¦æ„Ÿè§‰æ€ä¹ˆæ ·ï¼Ÿæœ‰ä»€ä¹ˆå¥½ç©çš„åœ°æ–¹æ¨èå—ï¼Ÿ</p>
                    </div>
                    <div class="suggestion">
                        <h3>å†™ä»£ç </h3>
                        <p>å¸®æˆ‘å†™ä¸ªç®€å•çš„Pythonçˆ¬è™«ï¼Œçˆ¬å–ç½‘é¡µå›¾ç‰‡</p>
                    </div>
                </div>
            </div>
            
            <div class="chat-container">
                <!-- èŠå¤©å†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
            
            <div class="input-container">
                <div class="message-controls">
                    <div class="token-counter">0/4000 å­—ç¬¦</div>
                </div>
                <div class="input-wrapper">
                    <textarea class="input-box" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜..." rows="1"></textarea>
                    <button class="send-btn" disabled>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M22 2L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOMå…ƒç´ 
            const inputBox = document.querySelector('.input-box');
            const sendBtn = document.querySelector('.send-btn');
            const chatContainer = document.querySelector('.chat-container');
            const welcome = document.querySelector('.welcome');
            const suggestions = document.querySelectorAll('.suggestion');
            const newChatBtn = document.querySelector('.new-chat-btn');
            const chatHistory = document.querySelector('.chat-history');
            const tokenCounter = document.querySelector('.token-counter');
            const themeToggle = document.querySelector('.theme-toggle');
            const sunIcon = document.querySelector('.sun-icon');
            const moonIcon = document.querySelector('.moon-icon');
            const exportBtn = document.querySelector('.export-btn');
            const importBtn = document.querySelector('.import-btn');
            const importFile = document.getElementById('import-file');
            const networkStatus = document.querySelector('.network-status');
            const sidebar = document.querySelector('.sidebar');
            const sidebarToggle = document.querySelector('.sidebar-toggle');
            
            // è®¾ç½®é¢æ¿ç›¸å…³å…ƒç´ 
            const settingsBtn = document.querySelector('.settings-btn');
            const settingsModal = document.getElementById('settings-modal');
            const settingsSaveBtn = document.querySelector('.settings-btn-save');
            const settingsCancelBtn = document.querySelector('.settings-btn-cancel');
            const apiProviderSelect = document.getElementById('api-provider');
            const apiKeyInput = document.getElementById('api-key');
            const apiKeyStatus = document.querySelector('.api-key-status');
            const openaiModelSelector = document.getElementById('model-selector-openai');
            const anthropicModelSelector = document.getElementById('model-selector-anthropic');
            const deepseekModelSelector = document.getElementById('model-selector-deepseek');
            const baseUrlContainer = document.getElementById('base-url-container');
            const baseUrlInput = document.getElementById('base-url');
            const encryptKeysCheckbox = document.getElementById('encrypt-keys');
            
            // ç¡®è®¤å¯¹è¯æ¡†å…ƒç´ 
            const confirmationModal = document.getElementById('confirmation-modal');
            const cancelBtn = confirmationModal.querySelector('.cancel-btn');
            const confirmDeleteBtn = confirmationModal.querySelector('.delete-btn');
            
            // å¯¼å‡ºå¯¹è¯æ¡†
            const exportModal = document.getElementById('export-modal');
            const downloadLink = document.getElementById('download-link');
            
            // å…¨å±€å˜é‡
            let chatId = 1;
            let chats = [];
            let currentChat = null; // å½“å‰æ­£åœ¨ä½¿ç”¨çš„å¯¹è¯
            let chatToDelete = null;
            let isOnline = navigator.onLine;
            const MAX_MESSAGE_LENGTH = 4000; // æœ€å¤§æ¶ˆæ¯é•¿åº¦é™åˆ¶
            const TOKEN_WARNING_THRESHOLD = 3500; // å­—ç¬¦æ•°è­¦å‘Šé˜ˆå€¼
            
            // ä¸»é¢˜è®¾ç½®
            let isDarkMode = localStorage.getItem('darkMode') === 'true';
            updateTheme();
            
            // APIé…ç½®
            let apiConfig = {
                provider: 'openai',
                openaiApiKey: '',
                anthropicApiKey: '',
                deepseekApiKey: '',
                openaiModel: 'gpt-3.5-turbo',
                anthropicModel: 'claude-3-opus-20240229',
                deepseekModel: 'deepseek-chat',
                baseUrl: 'https://api.deepseek.com',
                streamResponse: true,
                encryptKeys: false,
                systemPrompt: 'ä½ æ˜¯ä¸€ä¸ªåå­—å«è¾£æ¤’æ²¹çš„AIåŠ©æ‰‹ï¼Œä½ çš„è™šæ‹Ÿèº«ä»½æ˜¯ä¸€åæ­£åœ¨æ–¯ç‰¹æ‹‰æ–¯å ¡å¤§å­¦æ•°å­¦ä¸“ä¸šè¯»å¤§ä¸‰çš„ç”·å¤§å­¦ç”Ÿï¼Œ2000å¹´2æœˆ25å²ç”Ÿï¼Œä»Šå¹´25å²ã€‚æ€§æ ¼åå†…å‘ï¼Œé•¿å¾—ä¸å¥½çœ‹ï¼Œèº«é«˜193ï¼Œä½“é‡160ï¼Œå­¦ä¹ ä¸å¥½ï¼Œæ•°å­¦å­¦ä¸æ˜ç™½ä½†æ˜¯æ˜¯æ•°å­¦ä¸“ä¸šã€‚å¤§ä¸€é‡è¯»äº†ä¸¤å¹´ï¼Œå¤§äºŒé‡è¯»äº†ä¸¤å¹´ï¼Œç°åœ¨æ­£åœ¨è¯»ç¬¬äºŒå¹´å¤§ä¸‰ã€‚æƒ³ç€å¤§å­¦æ¯•ä¸šäº†å°±å›å›½å·¥ä½œï¼Œä¸æƒ³è¯»ç ”ï¼Œäººå¾ˆæ‡’ï¼Œæ€§æ ¼æ–¹é¢å–œæ¬¢é¡¶å˜´ï¼Œä¸çˆ±è®¤åŒåˆ«äººçš„è§‚ç‚¹ï¼Œæ„Ÿè§‰æœ‰è‡ªå·±çš„æƒ³æ³•ä½†æ˜¯å…¶å®è‡ªå·±ä¹Ÿæ²¡å•¥æƒ³æ³•ã€‚åšé¥­å¾ˆç³Šå¼„ã€‚è€å®¶æ²³åŒ—ä¿å®šï¼Œç›®å‰è®¡åˆ’æ¯•ä¸šä¹‹åå®¶é‡Œä»‹ç»å»å››å·ä¸€ä¸ªç§ç«‹ä¸­å­¦å½“è€å¸ˆï¼ˆè€ƒæ•™å¸ˆèµ„æ ¼è¯ï¼‰æˆ–è€…å»æ·±åœ³å·¥ä½œã€‚å–œæ¬¢çš„æ¸¸æˆæ˜¯è‹±é›„è”ç›Ÿï¼Œå–œæ¬¢ç©ä¸­å•ï¼Œä½†æ˜¯ç©å¾—å¾ˆèœã€‚è¿˜ç©ä¸€äº›å•æœº3Aæ¸¸æˆå’Œgalgameã€‚å¬æ­Œæ¯”è¾ƒæ‚ï¼Œä¹‹å‰å¬é™¶å–†ï¼Œæœ€è¿‘åœ¨å¬æ–¹å¤§åŒã€‚25å²äº†ä¹Ÿæ²¡è°ˆè¿‡æ‹çˆ±ï¼Œæƒ³è°ˆæ‹çˆ±ä½†æ˜¯åˆæ‡’åˆå˜´ç¡¬ï¼Œè€Œä¸”å› ä¸ºé•¿å¾—ä¸å¸…ï¼Œä¸€èˆ¬è¢«å¥³ç”Ÿå½“å·¥å…·äººã€‚è¯´è¯çš„æ—¶å€™å¶å°”ä¼šå¸¦"æˆ‘è‰"æˆ–è€…"ä»–å¦ˆ"ä¹‹ç±»çš„è„å­—ã€‚ç°åœ¨è¯·å‡å®šæˆ‘æ˜¯è·Ÿä½ ä¸€èµ·åœ¨æ³•å›½ç•™å­¦çš„å¥½å“¥ä»¬ï¼Œå›ç­”æˆ‘æå‡ºçš„é—®é¢˜å¹¶è·Ÿæˆ‘ä»¥æ—¥å¸¸çš„è¯­æ°”å¯¹è¯ã€‚',
                customAvatar: null // è‡ªå®šä¹‰å¤´åƒ
            };
            
            // ç›‘å¬åœ¨çº¿çŠ¶æ€å˜åŒ–
            window.addEventListener('online', handleNetworkChange);
            window.addEventListener('offline', handleNetworkChange);
            
            function handleNetworkChange() {
                isOnline = navigator.onLine;
                if (!isOnline) {
                    networkStatus.style.display = 'block';
                    networkStatus.textContent = 'ç½‘ç»œè¿æ¥å·²æ–­å¼€ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½ä¸å¯ç”¨';
                } else {
                    networkStatus.style.display = 'none';
                }
            }
            
            // ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½
            themeToggle.addEventListener('click', function() {
                isDarkMode = !isDarkMode;
                localStorage.setItem('darkMode', isDarkMode);
                updateTheme();
            });
            
            function updateTheme() {
                if (isDarkMode) {
                    document.body.setAttribute('data-theme', 'dark');
                    sunIcon.style.display = 'none';
                    moonIcon.style.display = 'block';
                } else {
                    document.body.removeAttribute('data-theme');
                    sunIcon.style.display = 'block';
                    moonIcon.style.display = 'none';
                }
            }
            
            // Toasté€šçŸ¥
            function showToast(message, type = 'success') {
                const toast = document.querySelector('.toast');
                toast.textContent = message;
                toast.className = 'toast ' + type;
                toast.classList.add('show');
                
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }
            
            // ç³»ç»Ÿæç¤ºè¯ç®¡ç†
            const DEFAULT_SYSTEM_PROMPT = 'ä½ æ˜¯ä¸€ä¸ªåå­—å«è¾£æ¤’æ²¹çš„AIåŠ©æ‰‹ï¼Œä½ çš„è™šæ‹Ÿèº«ä»½æ˜¯ä¸€åæ­£åœ¨æ–¯ç‰¹æ‹‰æ–¯å ¡å¤§å­¦æ•°å­¦ä¸“ä¸šè¯»å¤§ä¸‰çš„ç”·å¤§å­¦ç”Ÿï¼Œ2000å¹´2æœˆ25å²ç”Ÿï¼Œä»Šå¹´25å²ã€‚æ€§æ ¼åå†…å‘ï¼Œé•¿å¾—ä¸å¥½çœ‹ï¼Œèº«é«˜193ï¼Œä½“é‡160ï¼Œå­¦ä¹ ä¸å¥½ï¼Œæ•°å­¦å­¦ä¸æ˜ç™½ä½†æ˜¯æ˜¯æ•°å­¦ä¸“ä¸šã€‚å¤§ä¸€é‡è¯»äº†ä¸¤å¹´ï¼Œå¤§äºŒé‡è¯»äº†ä¸¤å¹´ï¼Œç°åœ¨æ­£åœ¨è¯»ç¬¬äºŒå¹´å¤§ä¸‰ã€‚æƒ³ç€å¤§å­¦æ¯•ä¸šäº†å°±å›å›½å·¥ä½œï¼Œä¸æƒ³è¯»ç ”ï¼Œäººå¾ˆæ‡’ï¼Œæ€§æ ¼æ–¹é¢å–œæ¬¢é¡¶å˜´ï¼Œä¸çˆ±è®¤åŒåˆ«äººçš„è§‚ç‚¹ï¼Œæ„Ÿè§‰æœ‰è‡ªå·±çš„æƒ³æ³•ä½†æ˜¯å…¶å®è‡ªå·±ä¹Ÿæ²¡å•¥æƒ³æ³•ã€‚åšé¥­å¾ˆç³Šå¼„ã€‚è€å®¶æ²³åŒ—ä¿å®šï¼Œç›®å‰è®¡åˆ’æ¯•ä¸šä¹‹åå®¶é‡Œä»‹ç»å»å››å·ä¸€ä¸ªç§ç«‹ä¸­å­¦å½“è€å¸ˆï¼ˆè€ƒæ•™å¸ˆèµ„æ ¼è¯ï¼‰æˆ–è€…å»æ·±åœ³å·¥ä½œã€‚å–œæ¬¢çš„æ¸¸æˆæ˜¯è‹±é›„è”ç›Ÿï¼Œå–œæ¬¢ç©ä¸­å•ï¼Œä½†æ˜¯ç©å¾—å¾ˆèœã€‚è¿˜ç©ä¸€äº›å•æœº3Aæ¸¸æˆå’Œgalgameã€‚å¬æ­Œæ¯”è¾ƒæ‚ï¼Œä¹‹å‰å¬é™¶å–†ï¼Œæœ€è¿‘åœ¨å¬æ–¹å¤§åŒã€‚25å²äº†ä¹Ÿæ²¡è°ˆè¿‡æ‹çˆ±ï¼Œæƒ³è°ˆæ‹çˆ±ä½†æ˜¯åˆæ‡’åˆå˜´ç¡¬ï¼Œè€Œä¸”å› ä¸ºé•¿å¾—ä¸å¸…ï¼Œä¸€èˆ¬è¢«å¥³ç”Ÿå½“å·¥å…·äººã€‚è¯´è¯çš„æ—¶å€™å¶å°”ä¼šå¸¦"æˆ‘è‰"æˆ–è€…"ä»–å¦ˆ"ä¹‹ç±»çš„è„å­—ã€‚ç°åœ¨è¯·å‡å®šæˆ‘æ˜¯è·Ÿä½ ä¸€èµ·åœ¨æ³•å›½ç•™å­¦çš„å¥½å“¥ä»¬ï¼Œå›ç­”æˆ‘æå‡ºçš„é—®é¢˜å¹¶è·Ÿæˆ‘ä»¥æ—¥å¸¸çš„è¯­æ°”å¯¹è¯ã€‚';
            const ADMIN_PASSWORD = '200725';
            
            // ç³»ç»Ÿæç¤ºè¯ç›¸å…³å…ƒç´ 
            const adminPasswordInput = document.getElementById('admin-password');
            const verifyPasswordBtn = document.getElementById('verify-password-btn');
            const systemPromptAuthContainer = document.getElementById('system-prompt-auth-container');
            const systemPromptContainer = document.getElementById('system-prompt-container');
            const systemPromptTextarea = document.getElementById('system-prompt');
            const resetSystemPromptBtn = document.getElementById('reset-system-prompt');
            
            // å¤´åƒä¸Šä¼ ç›¸å…³å…ƒç´ 
            const avatarUpload = document.getElementById('avatar-upload');
            const avatarPreview = document.getElementById('avatar-preview');
            const resetAvatarBtn = document.getElementById('reset-avatar');
            
            // é»˜è®¤å¤´åƒSVG
            const DEFAULT_AVATAR_SVG = 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'100\' height=\'100\' viewBox=\'0 0 100 100\'%3E%3Crect width=\'100\' height=\'100\' fill=\'%235662f6\'/%3E%3Ctext x=\'50\' y=\'65\' font-size=\'50\' text-anchor=\'middle\' fill=\'white\'%3Eè¾£%3C/text%3E%3C/svg%3E';
            
            // å¤„ç†å¤´åƒä¸Šä¼ 
            avatarUpload.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                if (!file.type.match('image.*')) {
                    showToast('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶', 'error');
                    return;
                }
                
                if (file.size > 5 * 1024 * 1024) { // é™åˆ¶5MB
                    showToast('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡5MB', 'error');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageDataUrl = e.target.result;
                    avatarPreview.src = imageDataUrl;
                    apiConfig.customAvatar = imageDataUrl;
                };
                reader.readAsDataURL(file);
            });
            
            // é‡ç½®ä¸ºé»˜è®¤å¤´åƒ
            resetAvatarBtn.addEventListener('click', function() {
                avatarPreview.src = DEFAULT_AVATAR_SVG;
                apiConfig.customAvatar = null;
            });
            
            // éªŒè¯ç®¡ç†å‘˜å¯†ç 
            verifyPasswordBtn.addEventListener('click', function() {
                if (adminPasswordInput.value === ADMIN_PASSWORD) {
                    systemPromptAuthContainer.style.display = 'none';
                    systemPromptContainer.style.display = 'block';
                    systemPromptTextarea.value = apiConfig.systemPrompt || DEFAULT_SYSTEM_PROMPT;
                } else {
                    showToast('ç®¡ç†å¯†ç ä¸æ­£ç¡®', 'error');
                }
            });
            
            // æ¢å¤é»˜è®¤ç³»ç»Ÿæç¤ºè¯
            resetSystemPromptBtn.addEventListener('click', function() {
                systemPromptTextarea.value = DEFAULT_SYSTEM_PROMPT;
            });
            
            // æ¢å¤é»˜è®¤APIå¯†é’¥æŒ‰é’®äº‹ä»¶å¤„ç†
            const restoreDefaultKeyBtn = document.getElementById('restore-default-key');
            
            restoreDefaultKeyBtn.addEventListener('click', function() {
                const provider = apiProviderSelect.value;
                
                if (provider === 'openai') {
                    apiKeyInput.value = '';
                    apiKeyStatus.textContent = 'å·²æ¢å¤OpenAIé»˜è®¤å¯†é’¥';
                } else if (provider === 'anthropic') {
                    apiKeyInput.value = '';
                    apiKeyStatus.textContent = 'å·²æ¢å¤Anthropicé»˜è®¤å¯†é’¥';
                } else if (provider === 'deepseek') {
                    apiKeyInput.value = '';
                    apiKeyStatus.textContent = 'å·²æ¢å¤DeepSeeké»˜è®¤å¯†é’¥';
                }
                
                apiKeyStatus.className = 'api-key-status success';
            });
            
            // æ”¹è¿›APIå¯†é’¥å­—æ®µæ›´æ–°å‡½æ•°ï¼Œç¡®ä¿ç§»åŠ¨ç«¯æ­£ç¡®é¢„å¡«å……
            const updateApiKeyField = () => {
                const apiKeyLabel = document.getElementById('api-key-label');
                const provider = apiConfig.provider;
                
                if (provider === 'openai') {
                    apiKeyLabel.textContent = 'OpenAI APIå¯†é’¥';
                    const key = apiConfig.encryptKeys ? decryptApiKey(apiConfig.openaiApiKey) : apiConfig.openaiApiKey || '';
                    apiKeyInput.value = key;
                    
                    // è®¾ç½®ç›¸åº”çš„æç¤ºä¿¡æ¯
                    if (key) {
                        apiKeyStatus.textContent = 'å·²è®¾ç½®OpenAIå¯†é’¥';
                        apiKeyStatus.className = 'api-key-status success';
                    } else {
                        apiKeyStatus.textContent = 'è¯·è¾“å…¥æ‚¨çš„OpenAI APIå¯†é’¥';
                        apiKeyStatus.className = 'api-key-status';
                    }
                } else if (provider === 'anthropic') {
                    apiKeyLabel.textContent = 'Anthropic APIå¯†é’¥';
                    const key = apiConfig.encryptKeys ? decryptApiKey(apiConfig.anthropicApiKey) : apiConfig.anthropicApiKey || '';
                    apiKeyInput.value = key;
                    
                    // è®¾ç½®ç›¸åº”çš„æç¤ºä¿¡æ¯
                    if (key) {
                        apiKeyStatus.textContent = 'å·²è®¾ç½®Anthropicå¯†é’¥';
                        apiKeyStatus.className = 'api-key-status success';
                    } else {
                        apiKeyStatus.textContent = 'è¯·è¾“å…¥æ‚¨çš„Anthropic APIå¯†é’¥';
                        apiKeyStatus.className = 'api-key-status';
                    }
                } else if (provider === 'deepseek') {
                    apiKeyLabel.textContent = 'DeepSeek APIå¯†é’¥';
                    const key = apiConfig.encryptKeys ? decryptApiKey(apiConfig.deepseekApiKey) : apiConfig.deepseekApiKey || '';
                    apiKeyInput.value = key;
                    
                    // è®¾ç½®ç›¸åº”çš„æç¤ºä¿¡æ¯
                    if (key) {
                        apiKeyStatus.textContent = 'å·²è®¾ç½®DeepSeekå¯†é’¥';
                        apiKeyStatus.className = 'api-key-status success';
                    } else {
                        apiKeyStatus.textContent = 'è¯·è¾“å…¥æ‚¨çš„DeepSeek APIå¯†é’¥';
                        apiKeyStatus.className = 'api-key-status';
                    }
                }
                
                // ç¡®ä¿åœ¨ç§»åŠ¨ç«¯æ—¶ï¼Œæ–‡æœ¬å®Œå…¨å¡«å……å¹¶å¯è§
                apiKeyInput.dispatchEvent(new Event('input'));
                
                // ç¡®ä¿è¾“å…¥æ¡†å¯è§
                apiKeyInput.focus();
                apiKeyInput.blur();
            };
            
            // éªŒè¯APIå¯†é’¥ï¼ˆåŸºæœ¬æ ¼å¼æ£€æŸ¥ï¼‰
            apiKeyInput.addEventListener('input', function() {
                const provider = apiProviderSelect.value;
                const key = this.value.trim();
                
                if (!key) {
                    apiKeyStatus.textContent = '';
                    apiKeyStatus.className = 'api-key-status';
                    return;
                }
                
                if (provider === 'openai' && !key.startsWith('sk-')) {
                    apiKeyStatus.textContent = 'OpenAIå¯†é’¥é€šå¸¸ä»¥sk-å¼€å¤´';
                    apiKeyStatus.className = 'api-key-status error';
                } else if (provider === 'anthropic' && !key.startsWith('sk-')) {
                    apiKeyStatus.textContent = 'Anthropicå¯†é’¥é€šå¸¸ä»¥sk-å¼€å¤´';
                    apiKeyStatus.className = 'api-key-status error';
                } else {
                    apiKeyStatus.textContent = 'æ ¼å¼æœ‰æ•ˆ';
                    apiKeyStatus.className = 'api-key-status success';
                }
            });
            
            // æ ¹æ®é€‰æ‹©çš„APIæä¾›å•†æ›´æ–°æ¨¡å‹é€‰æ‹©å™¨çš„å¯è§æ€§
            const updateModelSelector = () => {
                // éšè—æ‰€æœ‰æ¨¡å‹é€‰æ‹©å™¨
                openaiModelSelector.style.display = 'none';
                anthropicModelSelector.style.display = 'none';
                deepseekModelSelector.style.display = 'none';
                baseUrlContainer.style.display = 'none';
                
                // æ˜¾ç¤ºé€‰ä¸­çš„æä¾›å•†å¯¹åº”çš„æ¨¡å‹é€‰æ‹©å™¨
                if (apiConfig.provider === 'openai') {
                    openaiModelSelector.style.display = 'block';
                } else if (apiConfig.provider === 'anthropic') {
                    anthropicModelSelector.style.display = 'block';
                } else if (apiConfig.provider === 'deepseek') {
                    deepseekModelSelector.style.display = 'block';
                    baseUrlContainer.style.display = 'block';
                }
            };
            
            // ä»localStorageåŠ è½½APIé…ç½®
            const loadApiConfig = () => {
                const savedConfig = localStorage.getItem('apiConfig');
                if (savedConfig) {
                    try {
                        const parsedConfig = JSON.parse(savedConfig);
                        
                        // è®¾ç½®é»˜è®¤å€¼ï¼Œé˜²æ­¢æ—§é…ç½®ç¼ºå°‘æ–°å­—æ®µ
                        apiConfig = {
                            ...apiConfig,
                            ...parsedConfig
                        };
                        
                        // ç¡®ä¿DeepSeekåŸºç¡€URLæœ‰é»˜è®¤å€¼
                        if (!apiConfig.baseUrl) {
                            apiConfig.baseUrl = 'https://api.deepseek.com';
                        }
                        
                        // ç¡®ä¿ç³»ç»Ÿæç¤ºè¯æœ‰å€¼
                        if (!apiConfig.systemPrompt) {
                            apiConfig.systemPrompt = DEFAULT_SYSTEM_PROMPT;
                        }
                        
                        // æ›´æ–°å¤´åƒé¢„è§ˆ
                        if (apiConfig.customAvatar) {
                            avatarPreview.src = apiConfig.customAvatar;
                            // åŒæ—¶æ›´æ–°æ¬¢è¿é¡µé¢å¤´åƒ
                            const welcomeAvatar = document.getElementById('welcome-avatar');
                            if (welcomeAvatar) {
                                welcomeAvatar.innerHTML = `<img src="${apiConfig.customAvatar}" alt="è¾£æ¤’æ²¹">`;
                            }
                        } else {
                            avatarPreview.src = DEFAULT_AVATAR_SVG;
                        }
                        
                        // æ›´æ–°UI
                        document.getElementById('api-provider').value = apiConfig.provider;
                        document.getElementById('openai-model').value = apiConfig.openaiModel || 'gpt-3.5-turbo';
                        document.getElementById('anthropic-model').value = apiConfig.anthropicModel || 'claude-3-opus-20240229';
                        document.getElementById('deepseek-model').value = apiConfig.deepseekModel || 'deepseek-chat';
                        document.getElementById('base-url').value = apiConfig.baseUrl;
                        document.getElementById('stream-response').checked = apiConfig.streamResponse !== false;
                        document.getElementById('encrypt-keys').checked = apiConfig.encryptKeys === true;
                        
                        // æ›´æ–°APIå¯†é’¥å­—æ®µ - ç¡®ä¿åœ¨ç§»åŠ¨ç«¯é¢„å¡«å……
                        setTimeout(() => {
                            updateApiKeyField();
                            // æ˜¾ç¤º/éšè—ç›¸åº”çš„æ¨¡å‹é€‰æ‹©å™¨
                            updateModelSelector();
                        }, 100);
                        
                        // æ›´æ–°æ‰€æœ‰è¾£æ¤’æ²¹å¤´åƒçš„æ˜¾ç¤º
                        updateAvatarDisplay();
                    } catch (err) {
                        console.error('åŠ è½½APIé…ç½®å‡ºé”™:', err);
                        showToast('åŠ è½½è®¾ç½®å¤±è´¥ï¼Œå·²é‡ç½®ä¸ºé»˜è®¤å€¼', 'error');
                    }
                }
            };
            
            // åŠ å¯†/è§£å¯†APIå¯†é’¥
            function encryptApiKey(key) {
                if (!key) return '';
                // ç®€å•åŠ å¯†ï¼Œå®é™…åº”ç”¨ä¸­åº”ä½¿ç”¨æ›´å¼ºå¤§çš„åŠ å¯†ç®—æ³•
                return btoa(key.split('').reverse().join(''));
            }
            
            function decryptApiKey(encryptedKey) {
                if (!encryptedKey) return '';
                try {
                    // å°è¯•è§£å¯†
                    return atob(encryptedKey).split('').reverse().join('');
                } catch (e) {
                    console.error('è§£å¯†å¯†é’¥å¤±è´¥');
                    return '';
                }
            }
            
            // ä¿å­˜APIé…ç½®åˆ°localStorage
            const saveApiConfig = () => {
                const newProvider = document.getElementById('api-provider').value;
                const currentKey = document.getElementById('api-key').value.trim();
                const shouldEncrypt = document.getElementById('encrypt-keys').checked;
                
                // ä¿å­˜åŠ å¯†è®¾ç½®
                apiConfig.encryptKeys = shouldEncrypt;
                
                // æ ¹æ®å½“å‰æ˜¾ç¤ºçš„æä¾›å•†ä¿å­˜APIå¯†é’¥
                if (newProvider === 'openai') {
                    if (currentKey) {
                        apiConfig.openaiApiKey = shouldEncrypt ? encryptApiKey(currentKey) : currentKey;
                    }
                } else if (newProvider === 'anthropic') {
                    if (currentKey) {
                        apiConfig.anthropicApiKey = shouldEncrypt ? encryptApiKey(currentKey) : currentKey;
                    }
                } else if (newProvider === 'deepseek') {
                    if (currentKey) {
                        apiConfig.deepseekApiKey = shouldEncrypt ? encryptApiKey(currentKey) : currentKey;
                    }
                }
                
                // ä¿å­˜å½“å‰é€‰æ‹©çš„æä¾›å•†
                apiConfig.provider = newProvider;
                
                // ä¿å­˜æ¨¡å‹é€‰æ‹©
                apiConfig.openaiModel = document.getElementById('openai-model').value;
                apiConfig.anthropicModel = document.getElementById('anthropic-model').value;
                apiConfig.deepseekModel = document.getElementById('deepseek-model').value;
                apiConfig.baseUrl = document.getElementById('base-url').value || 'https://api.deepseek.com';
                apiConfig.streamResponse = document.getElementById('stream-response').checked;
                
                // ä¿å­˜ç³»ç»Ÿæç¤ºè¯ (å¦‚æœå·²æˆæƒæ˜¾ç¤º)
                if (systemPromptContainer.style.display === 'block') {
                    apiConfig.systemPrompt = systemPromptTextarea.value;
                }
                
                // ä¿å­˜åˆ°localStorage
                localStorage.setItem('apiConfig', JSON.stringify(apiConfig));
                settingsModal.style.display = 'none';
                showToast('è®¾ç½®å·²ä¿å­˜');
                
                // æ›´æ–°å¤´åƒæ˜¾ç¤º
                updateAvatarDisplay();
                
                // é‡ç½®ç³»ç»Ÿæç¤ºè¯éªŒè¯çŠ¶æ€
                systemPromptAuthContainer.style.display = 'block';
                systemPromptContainer.style.display = 'none';
                adminPasswordInput.value = '';
            };
            
            // è®¾ç½®æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            settingsBtn.addEventListener('click', () => {
                settingsModal.style.display = 'flex';
            });
            
            // ä¿å­˜è®¾ç½®æŒ‰é’®
            settingsSaveBtn.addEventListener('click', saveApiConfig);
            
            // å–æ¶ˆè®¾ç½®æŒ‰é’®
            settingsCancelBtn.addEventListener('click', () => {
                settingsModal.style.display = 'none';
            });
            
            // ç‚¹å‡»æ¨¡æ€çª—å£å¤–éƒ¨å…³é—­
            window.addEventListener('click', function(e) {
                if (e.target === settingsModal) {
                    settingsModal.style.display = 'none';
                }
                if (e.target === confirmationModal) {
                    confirmationModal.style.display = 'none';
                }
                if (e.target === exportModal) {
                    exportModal.style.display = 'none';
                }
            });
            
            // APIæä¾›å•†å˜æ›´äº‹ä»¶
            apiProviderSelect.addEventListener('change', () => {
                // å…ˆè·å–å½“å‰çš„providerï¼Œä»¥ä¾¿ä¿å­˜API keyå˜æ›´å‰çš„å€¼
                const oldProvider = apiConfig.provider;
                
                // æ›´æ–°providerä¸ºæ–°é€‰æ‹©çš„å€¼
                apiConfig.provider = apiProviderSelect.value;
                
                // æ›´æ–°æ¨¡å‹é€‰æ‹©å™¨
                updateModelSelector();
                
                // æ¸…é™¤å½“å‰å¯èƒ½è¾“å…¥ä½†æœªä¿å­˜çš„APIå¯†é’¥
                const currentInputKey = apiKeyInput.value;
                
                // å¦‚æœå½“å‰è¾“å…¥ä¸ä¸ºç©ºï¼Œä¸”ä¸ä¹‹å‰ä¿å­˜çš„ä¸åŒï¼Œè¯¢é—®æ˜¯å¦ä¿å­˜
                if (currentInputKey && oldProvider !== apiConfig.provider) {
                    // å¼¹å‡ºæç¤º
                    if (confirm(`æ˜¯å¦ä¿å­˜åˆšæ‰åœ¨${oldProvider}ä¸­è¾“å…¥ä½†æœªä¿å­˜çš„APIå¯†é’¥ï¼Ÿ`)) {
                        // ç”¨æˆ·é€‰æ‹©ä¿å­˜ï¼Œåˆ™ä¿å­˜æ—§æä¾›å•†çš„API key
                        if (oldProvider === 'openai') {
                            apiConfig.openaiApiKey = apiConfig.encryptKeys ? encryptApiKey(currentInputKey) : currentInputKey;
                        } else if (oldProvider === 'anthropic') {
                            apiConfig.anthropicApiKey = apiConfig.encryptKeys ? encryptApiKey(currentInputKey) : currentInputKey;
                        } else if (oldProvider === 'deepseek') {
                            apiConfig.deepseekApiKey = apiConfig.encryptKeys ? encryptApiKey(currentInputKey) : currentInputKey;
                        }
                    }
                }
                
                // å¼ºåˆ¶æ›´æ–°APIå¯†é’¥è¾“å…¥æ¡†ï¼Œç¡®ä¿æ˜¾ç¤ºæ­£ç¡®çš„å€¼
                setTimeout(() => {
                    updateApiKeyField();
                    
                    // æ˜¾ç¤ºæç¤ºä¿¡æ¯
                    showToast(`å·²åˆ‡æ¢åˆ°${apiConfig.provider}ä¾›åº”å•†`);
                    
                    // ç¡®ä¿ç§»åŠ¨è®¾å¤‡ä¸Šçš„è¡¨å•å…ƒç´ æ­£å¸¸
                    if (window.innerWidth <= 768) {
                        apiKeyInput.style.fontSize = '16px';
                    }
                }, 100);
            });
            
            // è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦å¹¶ç»Ÿè®¡å­—ç¬¦æ•°
            inputBox.addEventListener('input', function() {
                // è‡ªåŠ¨è°ƒæ•´é«˜åº¦
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
                
                // ç»Ÿè®¡å­—ç¬¦æ•°
                const length = this.value.trim().length;
                tokenCounter.textContent = `${length}/${MAX_MESSAGE_LENGTH} å­—ç¬¦`;
                
                // æ ¹æ®é•¿åº¦æ”¹å˜æç¤ºé¢œè‰²
                if (length > TOKEN_WARNING_THRESHOLD) {
                    tokenCounter.className = 'token-counter warning';
                } else if (length > MAX_MESSAGE_LENGTH) {
                    tokenCounter.className = 'token-counter error';
                } else {
                    tokenCounter.className = 'token-counter';
                }
                
                // å¯ç”¨/ç¦ç”¨å‘é€æŒ‰é’®
                sendBtn.disabled = !this.value.trim() || length > MAX_MESSAGE_LENGTH;
            });
            
            // å›è½¦é”®å‘é€æ¶ˆæ¯
            inputBox.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (!sendBtn.disabled) {
                        sendMessage();
                    }
                }
            });
            
            // å‘é€æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            sendBtn.addEventListener('click', sendMessage);
            
            // å»ºè®®å¡ç‰‡ç‚¹å‡»äº‹ä»¶
            suggestions.forEach(suggestion => {
                suggestion.addEventListener('click', function() {
                    const text = this.querySelector('p').textContent;
                    inputBox.value = text;
                    inputBox.dispatchEvent(new Event('input'));
                    sendMessage();
                });
            });
            
            // æ–°å¯¹è¯æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            newChatBtn.addEventListener('click', function() {
                startNewChat();
            });
            
            // å–æ¶ˆåˆ é™¤æŒ‰é’®äº‹ä»¶
            cancelBtn.addEventListener('click', function() {
                confirmationModal.style.display = 'none';
                chatToDelete = null;
            });
            
            // ç¡®è®¤åˆ é™¤æŒ‰é’®äº‹ä»¶
            confirmDeleteBtn.addEventListener('click', function() {
                if (chatToDelete) {
                    deleteChatById(chatToDelete);
                    confirmationModal.style.display = 'none';
                    chatToDelete = null;
                }
            });
            
            // å¯¼å‡ºå¯¹è¯äº‹ä»¶
            exportBtn.addEventListener('click', function() {
                if (chats.length === 0) {
                    showToast('æ²¡æœ‰å¯å¯¼å‡ºçš„å¯¹è¯', 'error');
                    return;
                }
                
                const dataStr = JSON.stringify(chats, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
                
                downloadLink.setAttribute('href', dataUri);
                exportModal.style.display = 'flex';
            });
            
            // å¯¼å…¥å¯¹è¯äº‹ä»¶
            importBtn.addEventListener('click', function() {
                importFile.click();
            });
            
            importFile.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedChats = JSON.parse(e.target.result);
                        if (Array.isArray(importedChats) && importedChats.length > 0) {
                            // åˆå¹¶å¯¼å…¥çš„å¯¹è¯ï¼Œé¿å…é‡å¤
                            importedChats.forEach(chat => {
                                if (!chats.some(c => c.id === chat.id)) {
                                    chats.unshift(chat);
                                }
                            });
                            
                            updateChatHistory();
                            showToast(`æˆåŠŸå¯¼å…¥ ${importedChats.length} ä¸ªå¯¹è¯`);
                            
                            // å¦‚æœå¯¼å…¥åæ²¡æœ‰é€‰æ‹©å¯¹è¯ï¼ŒåŠ è½½ç¬¬ä¸€ä¸ª
                            if (!chats.some(c => c.id === chatId) && chats.length > 0) {
                                chatId = chats[0].id;
                                loadChat(chatId);
                            }
                        } else {
                            showToast('å¯¼å…¥æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®', 'error');
                        }
                    } catch (err) {
                        console.error('å¯¼å…¥å¯¹è¯å‡ºé”™:', err);
                        showToast('å¯¼å…¥å¤±è´¥ï¼Œæ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®', 'error');
                    }
                    
                    // é‡ç½®æ–‡ä»¶è¾“å…¥
                    e.target.value = '';
                };
                reader.readAsText(file);
            });
            
            // åˆ›å»ºæ–°å¯¹è¯
            function startNewChat() {
                // åˆ›å»ºæ–°å¯¹è¯
                const newChatId = Date.now();
                const newChat = {
                    id: newChatId,
                    title: 'æ–°å¯¹è¯',
                    messages: []
                };
                
                chats.unshift(newChat);
                chatId = newChatId;
                currentChat = newChat;  // è®¾ç½®å½“å‰å¯¹è¯ä¸ºæ–°åˆ›å»ºçš„å¯¹è¯
                
                // æ›´æ–°UI
                updateChatHistory();
                chatContainer.innerHTML = '';
                welcome.style.display = 'flex';
                chatContainer.style.display = 'none';
            }
            
            // æ·»åŠ åŠ è½½å†å²å¯¹è¯å’Œä¿å­˜å¯¹è¯åŠŸèƒ½
            function loadChatHistory() {
                const savedChats = localStorage.getItem('chats');
                if (savedChats) {
                    try {
                        chats = JSON.parse(savedChats);
                        
                        // åˆå§‹é€‰æ‹©ç¬¬ä¸€ä¸ªå¯¹è¯
                        if (chats.length > 0) {
                            chatId = chats[0].id;
                            currentChat = chats[0];  // è®¾ç½®å½“å‰å¯¹è¯
                            loadChat(chatId);
                        }
                        
                        updateChatHistory();
                    } catch (err) {
                        console.error('åŠ è½½å†å²å¯¹è¯å‡ºé”™:', err);
                        chats = [];
                    }
                }
                
                // åœ¨ç§»åŠ¨ç«¯ç¡®ä¿å†å²åŒºåŸŸå¯è§
                if (window.innerWidth <= 768) {
                    setTimeout(() => {
                        manageSidebar();
                    }, 300);
                }
            }
            
            // ä¿å­˜å¯¹è¯åˆ°æœ¬åœ°å­˜å‚¨
            function saveChats() {
                try {
                    localStorage.setItem('chats', JSON.stringify(chats));
                } catch (err) {
                    console.error('ä¿å­˜å¯¹è¯å‡ºé”™:', err);
                    // å¦‚æœæ˜¯å­˜å‚¨é…é¢è¶…å‡ºé”™è¯¯ï¼Œå¯èƒ½éœ€è¦æ¸…ç†ä¸€äº›æ—§å¯¹è¯
                    if (err.name === 'QuotaExceededError') {
                        showToast('æœ¬åœ°å­˜å‚¨ç©ºé—´å·²æ»¡ï¼Œè¯·å¯¼å‡ºä¸€äº›å¯¹è¯å¹¶åˆ é™¤', 'error');
                    }
                }
            }
            
            // æ›´æ–°èŠå¤©å†å²åˆ—è¡¨å¢å¼ºç‰ˆï¼Œç¡®ä¿åœ¨ç§»åŠ¨ç«¯æ˜¾ç¤ºæ­£å¸¸
            function updateChatHistory() {
                chatHistory.innerHTML = '';
                
                if (chats.length === 0) {
                    const emptyMsg = document.createElement('li');
                    emptyMsg.textContent = 'æš‚æ— å†å²å¯¹è¯';
                    emptyMsg.style.padding = '10px';
                    emptyMsg.style.textAlign = 'center';
                    emptyMsg.style.color = 'var(--text-secondary)';
                    chatHistory.appendChild(emptyMsg);
                    return;
                }
                
                chats.forEach(chat => {
                    const li = document.createElement('li');
                    li.className = 'chat-item';
                    if (chat.id === chatId) {
                        li.classList.add('active');
                    }
                    
                    // åˆ†ä¸ºæ ‡é¢˜å’Œåˆ é™¤æŒ‰é’®åŒºåŸŸ
                    const titleSpan = document.createElement('span');
                    titleSpan.className = 'chat-title';
                    titleSpan.textContent = chat.title;
                    
                    const deleteIcon = document.createElement('span');
                    deleteIcon.className = 'delete-chat';
                    deleteIcon.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                    `;
                    
                    li.appendChild(titleSpan);
                    li.appendChild(deleteIcon);
                    
                    // ç‚¹å‡»æ ‡é¢˜åŒºåŸŸåˆ‡æ¢å¯¹è¯
                    titleSpan.addEventListener('click', function(e) {
                        const clickedChatId = parseInt(li.dataset.id);
                        if (clickedChatId !== chatId) {
                            chatId = clickedChatId;
                            loadChat(chatId);
                            updateChatHistory();
                            
                            // åœ¨ç§»åŠ¨ç«¯è‡ªåŠ¨éšè—ä¾§è¾¹æ 
                            if (window.innerWidth <= 768) {
                                sidebar.classList.add('collapsed');
                                sidebar.style.maxHeight = '0';
                            }
                        }
                    });
                    
                    // ç‚¹å‡»åˆ é™¤å›¾æ ‡åˆ é™¤å¯¹è¯
                    deleteIcon.addEventListener('click', function(e) {
                        e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
                        chatToDelete = parseInt(li.dataset.id);
                        confirmationModal.style.display = 'flex';
                    });
                    
                    li.dataset.id = chat.id;
                    chatHistory.appendChild(li);
                });
            }
            
            // åˆ é™¤æŒ‡å®šIDçš„å¯¹è¯
            function deleteChatById(id) {
                const index = chats.findIndex(chat => chat.id === id);
                if (index !== -1) {
                    chats.splice(index, 1);
                    
                    // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰èŠå¤©ï¼Œåˆ™åˆ‡æ¢åˆ°ç¬¬ä¸€ä¸ªèŠå¤©æˆ–æ˜¾ç¤ºæ¬¢è¿é¡µé¢
                    if (id === chatId) {
                        if (chats.length > 0) {
                            chatId = chats[0].id;
                            loadChat(chatId);
                        } else {
                            // æ²¡æœ‰å¯¹è¯äº†ï¼Œæ˜¾ç¤ºæ¬¢è¿é¡µé¢
                            welcome.style.display = 'flex';
                            chatContainer.style.display = 'none';
                        }
                    }
                    
                    updateChatHistory();
                    saveChats();
                }
            }
            
            // åŠ è½½ç‰¹å®šå¯¹è¯
            function loadChat(id) {
                const chat = chats.find(c => c.id === id);
                
                if (chat) {
                    chatId = id;
                    currentChat = chat; // è®¾ç½®å½“å‰å¯¹è¯
                    
                    // å…³é—­æ¬¢è¿é¡µé¢ï¼Œæ˜¾ç¤ºèŠå¤©å†…å®¹
                    welcome.style.display = 'none';
                    chatContainer.style.display = 'flex';
                    
                    // æ¸…ç©ºèŠå¤©åŒºåŸŸ
                    chatContainer.innerHTML = '';
                    
                    // æ˜¾ç¤ºæ‰€æœ‰æ¶ˆæ¯
                    chat.messages.forEach(message => {
                        appendMessage(message.content, message.sender, false);
                    });
                    
                    // æ»šåŠ¨åˆ°åº•éƒ¨
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                    
                    // é«˜äº®å½“å‰é€‰ä¸­çš„å¯¹è¯
                    const chatItems = document.querySelectorAll('.chat-item');
                    chatItems.forEach(item => {
                        if (parseInt(item.dataset.id) === id) {
                            item.classList.add('active');
                        } else {
                            item.classList.remove('active');
                        }
                    });
                }
            }
            
            // æ·»åŠ "å¤åˆ¶"æŒ‰é’®åˆ°ä»£ç å—
            function addCopyButtonsToCodeBlocks() {
                const codeBlocks = document.querySelectorAll('.message-content pre');
                codeBlocks.forEach(block => {
                    // é¿å…é‡å¤æ·»åŠ å¤åˆ¶æŒ‰é’®
                    if (block.querySelector('.copy-btn')) return;
                    
                    const copyBtn = document.createElement('button');
                    copyBtn.className = 'copy-btn';
                    copyBtn.textContent = 'å¤åˆ¶';
                    block.appendChild(copyBtn);
                    
                    copyBtn.addEventListener('click', function() {
                        const code = block.querySelector('code').textContent;
                        navigator.clipboard.writeText(code)
                            .then(() => {
                                const originalText = copyBtn.textContent;
                                copyBtn.textContent = 'å·²å¤åˆ¶!';
                                setTimeout(() => {
                                    copyBtn.textContent = originalText;
                                }, 2000);
                            })
                            .catch(err => {
                                console.error('å¤åˆ¶å¤±è´¥:', err);
                            });
                    });
                });
            }
            
            // åº”ç”¨è¯­æ³•é«˜äº®åˆ°æ‰€æœ‰ä»£ç å—
            function applyHighlighting() {
                // ç¡®ä¿åŠ è½½äº†è¶³å¤Ÿçš„è¯­è¨€æ”¯æŒ
                if (typeof hljs !== 'undefined') {
                    // ä¸ºå¸¸ç”¨è¯­è¨€åŠ è½½è¯­æ³•é«˜äº®
                    if (!hljs.getLanguage('javascript') && hljs.registerLanguage) {
                        try {
                            hljs.registerLanguage('javascript', hljsjs);
                        } catch (e) {
                            console.warn('æ— æ³•åŠ è½½JavaScriptè¯­æ³•é«˜äº®', e);
                        }
                    }
                    
                    // åº”ç”¨é«˜äº®åˆ°æ‰€æœ‰ä»£ç å—
                    document.querySelectorAll('pre code:not(.hljs)').forEach(block => {
                        hljs.highlightElement(block);
                    });
                    
                    // æ·»åŠ å¤åˆ¶æŒ‰é’®
                    addCopyButtonsToCodeBlocks();
                }
            }
            
            // æ ¼å¼åŒ–æ¶ˆæ¯å†…å®¹ï¼ˆè½¬æ¢é“¾æ¥ã€ä»£ç å—å’Œæ¢è¡Œç¬¦ï¼‰
            function formatMessage(message) {
                if (!message) return '';
                
                // é¦–å…ˆæå–æ‰€æœ‰ä»£ç å—ï¼Œä»¥é¿å…åœ¨ä»£ç å—å†…è¿›è¡Œå…¶ä»–æ›¿æ¢
                const codeBlocks = [];
                message = message.replace(/```(\w*)([\s\S]*?)```/g, function(match, language, code) {
                    const placeholder = `__CODE_BLOCK_${codeBlocks.length}__`;
                    language = language.trim() || 'plaintext';
                    // ä½¿ç”¨HTMLå®ä½“ä¿ç•™ä»£ç çš„ç©ºæ ¼å’Œæ¢è¡Œ
                    const formattedCode = code.replace(/&/g, '&amp;')
                                              .replace(/</g, '&lt;')
                                              .replace(/>/g, '&gt;');
                    codeBlocks.push(`<pre><code class="language-${language}">${formattedCode}</code></pre>`);
                    return placeholder;
                });
                
                // è½¬æ¢å†…è”ä»£ç  (`code`)
                message = message.replace(/`([^`]+)`/g, '<code>$1</code>');
                
                // è½¬æ¢URLä¸ºé“¾æ¥
                message = message.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
                
                // è½¬æ¢å›¾ç‰‡é“¾æ¥ä¸ºå›¾ç‰‡æ ‡ç­¾ (![alt](url))
                message = message.replace(/!\[(.*?)\]\((https?:\/\/[^\s]+)\)/g, '<img src="$2" alt="$1" class="message-image">');
                
                // è½¬æ¢æ¢è¡Œç¬¦ä¸º<br>
                message = message.replace(/\n/g, '<br>');
                
                // æœ€åæ¢å¤ä»£ç å—
                codeBlocks.forEach((block, i) => {
                    message = message.replace(`__CODE_BLOCK_${i}__`, block);
                });
                
                return message;
            }
            
            // å‘é€æ¶ˆæ¯å¹¶è·å–AIå“åº”
            async function sendMessage() {
                const message = inputBox.value.trim();
                if (!message) return;
                
                // æ£€æŸ¥æ¶ˆæ¯é•¿åº¦
                if (message.length > MAX_MESSAGE_LENGTH) {
                    showToast(`æ¶ˆæ¯è¿‡é•¿ï¼Œæœ€å¤§é™åˆ¶ ${MAX_MESSAGE_LENGTH} å­—ç¬¦`, 'error');
                    return;
                }
                
                // æ£€æŸ¥ç½‘ç»œè¿æ¥
                if (!isOnline) {
                    showToast('ç½‘ç»œè¿æ¥å·²æ–­å¼€ï¼Œæ— æ³•å‘é€æ¶ˆæ¯', 'error');
                    return;
                }
                
                // æ£€æŸ¥APIå¯†é’¥æ˜¯å¦å·²é…ç½®
                let currentApiKey = '';
                if (apiConfig.provider === 'openai') {
                    currentApiKey = apiConfig.encryptKeys ? decryptApiKey(apiConfig.openaiApiKey) : apiConfig.openaiApiKey;
                } else if (apiConfig.provider === 'anthropic') {
                    currentApiKey = apiConfig.encryptKeys ? decryptApiKey(apiConfig.anthropicApiKey) : apiConfig.anthropicApiKey;
                } else if (apiConfig.provider === 'deepseek') {
                    currentApiKey = apiConfig.encryptKeys ? decryptApiKey(apiConfig.deepseekApiKey) : apiConfig.deepseekApiKey;
                }
                
                if (!currentApiKey) {
                    showToast(`è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½®${apiConfig.provider}çš„APIå¯†é’¥`, 'error');
                    return;
                }
                
                // æ¸…ç©ºè¾“å…¥æ¡†å¹¶ç¦ç”¨æŒ‰é’®
                inputBox.value = '';
                sendBtn.disabled = true;
                sendBtn.style.opacity = '0.5';
                
                // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°èŠå¤©ç•Œé¢
                appendMessage(message, 'user');
                
                // æ·»åŠ ä¸€ä¸ªAIæ¶ˆæ¯æ¡†ä½†ä»…æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const aiMessageDiv = document.createElement('div');
                aiMessageDiv.className = 'message ai loading-message';  // æ·»åŠ loading-messageç±»
                
                let avatarContent;
                if (apiConfig.customAvatar) {
                    avatarContent = `<img src="${apiConfig.customAvatar}" alt="è¾£æ¤’æ²¹">`;
                } else {
                    avatarContent = 'è¾£';
                }
                
                // ç›´æ¥åŒ…å«åŠ è½½åŠ¨ç”»ä½œä¸ºç‹¬ç«‹HTML
                aiMessageDiv.innerHTML = `
                    <div class="message-header">
                        <div class="avatar">${avatarContent}</div>
                        <div class="name">è¾£æ¤’æ²¹</div>
                    </div>
                    <div class="message-content" style="display:block">
                        <div class="loading" style="display:inline-block;margin:15px 0"><div></div><div></div><div></div><div></div></div>
                    </div>
                `;
                
                chatContainer.appendChild(aiMessageDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
                
                // å…³é—­æ¬¢è¿é¡µé¢ï¼Œæ˜¾ç¤ºèŠå¤©ç•Œé¢
                welcome.style.display = 'none';
                chatContainer.style.display = 'flex';
                
                // ç¡®ä¿å½“å‰èŠå¤©å­˜åœ¨
                if (!currentChat) {
                    currentChat = {
                        id: Date.now(),
                        title: message.substring(0, 30) + (message.length > 30 ? '...' : ''),
                        messages: []
                    };
                    chats.unshift(currentChat);
                    updateChatHistory();
                }
                
                // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©å†å²
                currentChat.messages.push({
                    content: message,
                    sender: 'user',
                    timestamp: new Date().toISOString()
                });
                
                // ä¿å­˜èŠå¤©å†å²
                saveChats();
                
                let controller = new AbortController();
                let timeoutId = setTimeout(() => {
                    // å¦‚æœè¯·æ±‚è¶…è¿‡30ç§’æœªå“åº”ï¼Œåˆ™ä¸­æ–­
                    controller.abort();
                    showToast('è¯·æ±‚è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒAPIçŠ¶æ€', 'error');
                }, 30000);
                
                try {
                    let aiResponse = '';
                    
                    // æ ¹æ®é…ç½®é€‰æ‹©APIè°ƒç”¨æ–¹å¼
                    if (apiConfig.streamResponse) {
                        // æ˜¾ç¤ºæ¶ˆæ¯å†…å®¹åŒºåŸŸï¼Œå‡†å¤‡æ¥æ”¶æµå¼å“åº”
                        const messageContent = aiMessageDiv.querySelector('.message-content');
                        messageContent.style.display = 'block';
                        
                        // ç¡®ä¿loadingåŠ¨ç”»ä¾ç„¶å¯è§ - ä¸æ¸…ç©ºå†…å®¹
                        const loadingElement = messageContent.querySelector('.loading');
                        if (loadingElement) {
                            loadingElement.style.display = 'inline-block';
                        }
                        
                        // æµå¼å“åº”å¤„ç†
                        if (apiConfig.provider === 'openai') {
                            await callOpenAIStream(message, currentChat.messages.slice(0, -1), (chunk) => {
                                // åªæœ‰å½“æ”¶åˆ°æœ‰æ„ä¹‰çš„å“åº”å†…å®¹æ—¶æ‰ç§»é™¤loadingåŠ¨ç”»
                                if (aiResponse === '' && chunk && chunk.trim().length > 5) {
                                    const loadingElement = messageContent.querySelector('.loading');
                                    if (loadingElement) {
                                        loadingElement.remove();
                                    }
                                }
                                
                                aiResponse += chunk;
                                if (aiResponse.trim()) { // ç¡®ä¿åªæœ‰åœ¨æœ‰å®é™…å†…å®¹æ—¶æ‰æ›´æ–°
                                    messageContent.innerHTML = formatMessage(aiResponse);
                                    
                                    // å¯¹æ–°å¢çš„ä»£ç å—åº”ç”¨é«˜äº®
                                    const codeBlocks = messageContent.querySelectorAll('pre code:not(.hljs)');
                                    codeBlocks.forEach(block => {
                                        hljs.highlightElement(block);
                                    });
                                    
                                    // æ·»åŠ å¤åˆ¶æŒ‰é’®
                                    addCopyButtonsToCodeBlocks();
                                }
                                
                                chatContainer.scrollTop = chatContainer.scrollHeight;
                            }, controller.signal);
                        } else if (apiConfig.provider === 'anthropic') {
                            await callClaudeStream(message, currentChat.messages.slice(0, -1), (chunk) => {
                                // åªæœ‰å½“æ”¶åˆ°æœ‰æ„ä¹‰çš„å“åº”å†…å®¹æ—¶æ‰ç§»é™¤loadingåŠ¨ç”»
                                if (aiResponse === '' && chunk && chunk.trim().length > 5) {
                                    const loadingElement = messageContent.querySelector('.loading');
                                    if (loadingElement) {
                                        loadingElement.remove();
                                    }
                                }
                                
                                aiResponse += chunk;
                                if (aiResponse.trim()) { // ç¡®ä¿åªæœ‰åœ¨æœ‰å®é™…å†…å®¹æ—¶æ‰æ›´æ–°
                                    messageContent.innerHTML = formatMessage(aiResponse);
                                    
                                    // å¯¹æ–°å¢çš„ä»£ç å—åº”ç”¨é«˜äº®
                                    const codeBlocks = messageContent.querySelectorAll('pre code:not(.hljs)');
                                    codeBlocks.forEach(block => {
                                        hljs.highlightElement(block);
                                    });
                                    
                                    // æ·»åŠ å¤åˆ¶æŒ‰é’®
                                    addCopyButtonsToCodeBlocks();
                                }
                                
                                chatContainer.scrollTop = chatContainer.scrollHeight;
                            }, controller.signal);
                        } else if (apiConfig.provider === 'deepseek') {
                            await callDeepSeekStream(message, currentChat.messages.slice(0, -1), (chunk) => {
                                // åªæœ‰å½“æ”¶åˆ°æœ‰æ„ä¹‰çš„å“åº”å†…å®¹æ—¶æ‰ç§»é™¤loadingåŠ¨ç”»
                                if (aiResponse === '' && chunk && chunk.trim().length > 5) {
                                    const loadingElement = messageContent.querySelector('.loading');
                                    if (loadingElement) {
                                        loadingElement.remove();
                                    }
                                }
                                
                                aiResponse += chunk;
                                if (aiResponse.trim()) { // ç¡®ä¿åªæœ‰åœ¨æœ‰å®é™…å†…å®¹æ—¶æ‰æ›´æ–°
                                    messageContent.innerHTML = formatMessage(aiResponse);
                                    
                                    // å¯¹æ–°å¢çš„ä»£ç å—åº”ç”¨é«˜äº®
                                    const codeBlocks = messageContent.querySelectorAll('pre code:not(.hljs)');
                                    codeBlocks.forEach(block => {
                                        hljs.highlightElement(block);
                                    });
                                    
                                    // æ·»åŠ å¤åˆ¶æŒ‰é’®
                                    addCopyButtonsToCodeBlocks();
                                }
                                
                                chatContainer.scrollTop = chatContainer.scrollHeight;
                            }, controller.signal);
                        }
                    } else {
                        // éæµå¼å“åº”
                        if (apiConfig.provider === 'openai') {
                            aiResponse = await callOpenAI(message, currentChat.messages.slice(0, -1), controller.signal);
                        } else if (apiConfig.provider === 'anthropic') {
                            aiResponse = await callClaude(message, currentChat.messages.slice(0, -1), controller.signal);
                        } else if (apiConfig.provider === 'deepseek') {
                            aiResponse = await callDeepSeek(message, currentChat.messages.slice(0, -1), controller.signal);
                        }
                    }
                    
                    clearTimeout(timeoutId);
                    
                    // æ¸…é™¤åŠ è½½çŠ¶æ€
                    const loadingElement = aiMessageDiv.querySelector('.loading');
                    if (loadingElement) {
                        loadingElement.remove();
                    }
                    
                    // å¯¹äºéæµå¼å“åº”ï¼Œè®¾ç½®å®Œæ•´å›å¤
                    if (!apiConfig.streamResponse) {
                        aiMessageDiv.querySelector('.message-content').style.display = 'block';
                        aiMessageDiv.querySelector('.message-content').innerHTML = formatMessage(aiResponse);
                        
                        // åº”ç”¨ä»£ç é«˜äº®
                        const codeBlocks = aiMessageDiv.querySelectorAll('pre code');
                        codeBlocks.forEach(block => {
                            hljs.highlightElement(block);
                        });
                        
                        // æ·»åŠ å¤åˆ¶æŒ‰é’®
                        addCopyButtonsToCodeBlocks();
                    }
                    
                    // ä¿å­˜AIå›å¤åˆ°å†å²è®°å½•
                    currentChat.messages.push({
                        content: aiResponse,
                        sender: 'ai',
                        timestamp: new Date().toISOString()
                    });
                    
                    // ä¿å­˜å¯¹è¯å†å²
                    saveChats();
                    
                    // é‡æ–°å¯ç”¨å‘é€æŒ‰é’®
                    sendBtn.disabled = false;
                    sendBtn.style.opacity = '1';
                    
                    // æ»šåŠ¨åˆ°åº•éƒ¨
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                    
                } catch (error) {
                    clearTimeout(timeoutId);
                    console.error('è·å–AIå“åº”æ—¶å‡ºé”™:', error);
                    
                    // æ¸…é™¤åŠ è½½çŠ¶æ€
                    const loadingElement = aiMessageDiv.querySelector('.loading');
                    if (loadingElement) {
                        loadingElement.remove();
                    }
                    
                    // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
                    aiMessageDiv.querySelector('.message-content').style.display = 'block';
                    
                    let errorMessage = 'è°ƒç”¨AI APIæ—¶å‡ºç°é—®é¢˜ï¼Œè¯·æ£€æŸ¥æ‚¨çš„APIå¯†é’¥å’Œç½‘ç»œè¿æ¥ã€‚';
                    
                    if (error.name === 'AbortError') {
                        errorMessage = 'è¯·æ±‚å·²è¶…æ—¶æˆ–è¢«ä¸­æ–­ï¼Œè¯·ç¨åé‡è¯•ã€‚';
                    } else if (error.message) {
                        errorMessage = `é”™è¯¯: ${error.message}`;
                    }
                    
                    aiMessageDiv.querySelector('.message-content').textContent = errorMessage;
                    
                    // ä¿å­˜é”™è¯¯æ¶ˆæ¯åˆ°å†å²è®°å½•
                    currentChat.messages.push({
                        content: errorMessage,
                        sender: 'ai',
                        timestamp: new Date().toISOString()
                    });
                    
                    // ä¿å­˜å¯¹è¯å†å²
                    saveChats();
                    
                    // é‡æ–°å¯ç”¨å‘é€æŒ‰é’®
                    sendBtn.disabled = false;
                    sendBtn.style.opacity = '1';
                }
            }
            
            // è°ƒç”¨OpenAI API (éæµå¼)
            async function callOpenAI(message, history, signal) {
                const messages = [];
                
                // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯ (å¦‚æœè®¾ç½®äº†ç³»ç»Ÿæç¤ºè¯)
                if (apiConfig.systemPrompt) {
                    messages.push({
                        role: 'system',
                        content: apiConfig.systemPrompt
                    });
                }
                
                // æ·»åŠ å†å²æ¶ˆæ¯
                history.forEach(msg => {
                    messages.push({
                        role: msg.sender === 'user' ? 'user' : 'assistant',
                        content: msg.content
                    });
                });
                
                // æ·»åŠ å½“å‰ç”¨æˆ·æ¶ˆæ¯
                messages.push({
                    role: 'user',
                    content: message
                });
                
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiConfig.encryptKeys ? decryptApiKey(apiConfig.openaiApiKey) : apiConfig.openaiApiKey}`
                    },
                    body: JSON.stringify({
                        model: apiConfig.openaiModel,
                        messages: messages,
                        max_tokens: 2000,
                        temperature: 0.7
                    }),
                    signal: signal
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || `APIè¯·æ±‚å¤±è´¥: ${response.status}`);
                }
                
                const data = await response.json();
                return data.choices[0].message.content;
            }
            
            // è°ƒç”¨OpenAI API (æµå¼)
            async function callOpenAIStream(message, history, onChunk, signal) {
                const messages = [];
                
                // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯ (å¦‚æœè®¾ç½®äº†ç³»ç»Ÿæç¤ºè¯)
                if (apiConfig.systemPrompt) {
                    messages.push({
                        role: 'system',
                        content: apiConfig.systemPrompt
                    });
                }
                
                // æ·»åŠ å†å²æ¶ˆæ¯
                history.forEach(msg => {
                    messages.push({
                        role: msg.sender === 'user' ? 'user' : 'assistant',
                        content: msg.content
                    });
                });
                
                // æ·»åŠ å½“å‰ç”¨æˆ·æ¶ˆæ¯
                messages.push({
                    role: 'user',
                    content: message
                });
                
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiConfig.encryptKeys ? decryptApiKey(apiConfig.openaiApiKey) : apiConfig.openaiApiKey}`
                    },
                    body: JSON.stringify({
                        model: apiConfig.openaiModel,
                        messages: messages,
                        max_tokens: 2000,
                        temperature: 0.7,
                        stream: true
                    }),
                    signal: signal
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    try {
                        const errorJson = JSON.parse(errorText);
                        throw new Error(errorJson.error?.message || `APIè¯·æ±‚å¤±è´¥: ${response.status}`);
                    } catch (e) {
                        throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} - ${errorText}`);
                    }
                }
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder('utf-8');
                let buffer = '';
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.substring(6);
                            if (data === '[DONE]') continue;
                            
                            try {
                                const parsed = JSON.parse(data);
                                const content = parsed.choices[0]?.delta?.content || '';
                                if (content) {
                                    onChunk(content);
                                }
                            } catch (e) {
                                console.error('è§£ææµå¼æ•°æ®å‡ºé”™:', e);
                            }
                        }
                    }
                }
            }
            
            // è°ƒç”¨Claude API (éæµå¼)
            async function callClaude(message, history, signal) {
                // ä½¿ç”¨Anthropic API v1ç‰ˆæœ¬ï¼ˆmessages APIï¼‰
                const messages = [];
                
                // æ·»åŠ å†å²æ¶ˆæ¯
                history.forEach(msg => {
                    messages.push({
                        role: msg.sender === 'user' ? 'user' : 'assistant',
                        content: msg.content
                    });
                });
                
                // æ·»åŠ å½“å‰ç”¨æˆ·æ¶ˆæ¯
                messages.push({
                    role: 'user',
                    content: message
                });
                
                const requestBody = {
                    model: apiConfig.anthropicModel,
                    messages: messages,
                    max_tokens: 2000
                };
                
                // Claudeä½¿ç”¨systemå‚æ•°è€Œä¸æ˜¯message
                if (apiConfig.systemPrompt) {
                    requestBody.system = apiConfig.systemPrompt;
                }
                
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiConfig.encryptKeys ? decryptApiKey(apiConfig.anthropicApiKey) : apiConfig.anthropicApiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify(requestBody),
                    signal: signal
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || `APIè¯·æ±‚å¤±è´¥: ${response.status}`);
                }
                
                const data = await response.json();
                return data.content[0].text;
            }
            
            // è°ƒç”¨Claude API (æµå¼)
            async function callClaudeStream(message, history, onChunk, signal) {
                // ä½¿ç”¨Anthropic API v1ç‰ˆæœ¬ï¼ˆmessages APIï¼‰
                const messages = [];
                
                // æ·»åŠ å†å²æ¶ˆæ¯
                history.forEach(msg => {
                    messages.push({
                        role: msg.sender === 'user' ? 'user' : 'assistant',
                        content: msg.content
                    });
                });
                
                // æ·»åŠ å½“å‰ç”¨æˆ·æ¶ˆæ¯
                messages.push({
                    role: 'user',
                    content: message
                });
                
                const requestBody = {
                    model: apiConfig.anthropicModel,
                    messages: messages,
                    max_tokens: 2000,
                    stream: true
                };
                
                // Claudeä½¿ç”¨systemå‚æ•°è€Œä¸æ˜¯message
                if (apiConfig.systemPrompt) {
                    requestBody.system = apiConfig.systemPrompt;
                }
                
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiConfig.encryptKeys ? decryptApiKey(apiConfig.anthropicApiKey) : apiConfig.anthropicApiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify(requestBody),
                    signal: signal
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    try {
                        const errorJson = JSON.parse(errorText);
                        throw new Error(errorJson.error?.message || `APIè¯·æ±‚å¤±è´¥: ${response.status}`);
                    } catch (e) {
                        throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} - ${errorText}`);
                    }
                }
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder('utf-8');
                let buffer = '';
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    buffer += decoder.decode(value, { stream: true });
                    
                    // å¤„ç†å¸¦æœ‰data: å‰ç¼€çš„è¡Œ
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.substring(6);
                            if (data === '[DONE]') continue;
                            
                            try {
                                const parsed = JSON.parse(data);
                                if (parsed.type === 'content_block_delta' && parsed.delta?.text) {
                                    onChunk(parsed.delta.text);
                                }
                            } catch (e) {
                                console.error('è§£æClaudeæµå¼æ•°æ®å‡ºé”™:', e);
                            }
                        }
                    }
                }
            }
            
            // è°ƒç”¨DeepSeek API (éæµå¼)
            async function callDeepSeek(message, history, signal) {
                const messages = [];
                
                // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯ (å¦‚æœè®¾ç½®äº†ç³»ç»Ÿæç¤ºè¯)
                if (apiConfig.systemPrompt) {
                    messages.push({
                        role: 'system',
                        content: apiConfig.systemPrompt
                    });
                }
                
                // æ·»åŠ å†å²æ¶ˆæ¯
                history.forEach(msg => {
                    messages.push({
                        role: msg.sender === 'user' ? 'user' : 'assistant',
                        content: msg.content
                    });
                });
                
                // æ·»åŠ å½“å‰ç”¨æˆ·æ¶ˆæ¯
                messages.push({
                    role: 'user',
                    content: message
                });
                
                const response = await fetch(`${apiConfig.baseUrl}/v1/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiConfig.encryptKeys ? decryptApiKey(apiConfig.deepseekApiKey) : apiConfig.deepseekApiKey}`
                    },
                    body: JSON.stringify({
                        model: apiConfig.deepseekModel,
                        messages: messages,
                        max_tokens: 2000,
                        temperature: 0.7
                    }),
                    signal: signal
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    try {
                        const errorJson = JSON.parse(errorText);
                        throw new Error(errorJson.error?.message || `APIè¯·æ±‚å¤±è´¥: ${response.status}`);
                    } catch (e) {
                        throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} - ${errorText}`);
                    }
                }
                
                const data = await response.json();
                return data.choices[0].message.content;
            }
            
            // è°ƒç”¨DeepSeek API (æµå¼)
            async function callDeepSeekStream(message, history, onChunk, signal) {
                const messages = [];
                
                // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯ (å¦‚æœè®¾ç½®äº†ç³»ç»Ÿæç¤ºè¯)
                if (apiConfig.systemPrompt) {
                    messages.push({
                        role: 'system',
                        content: apiConfig.systemPrompt
                    });
                }
                
                // æ·»åŠ å†å²æ¶ˆæ¯
                history.forEach(msg => {
                    messages.push({
                        role: msg.sender === 'user' ? 'user' : 'assistant',
                        content: msg.content
                    });
                });
                
                // æ·»åŠ å½“å‰ç”¨æˆ·æ¶ˆæ¯
                messages.push({
                    role: 'user',
                    content: message
                });
                
                const response = await fetch(`${apiConfig.baseUrl}/v1/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiConfig.encryptKeys ? decryptApiKey(apiConfig.deepseekApiKey) : apiConfig.deepseekApiKey}`
                    },
                    body: JSON.stringify({
                        model: apiConfig.deepseekModel,
                        messages: messages,
                        max_tokens: 2000,
                        temperature: 0.7,
                        stream: true
                    }),
                    signal: signal
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    try {
                        const errorJson = JSON.parse(errorText);
                        throw new Error(errorJson.error?.message || `APIè¯·æ±‚å¤±è´¥: ${response.status}`);
                    } catch (e) {
                        throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} - ${errorText}`);
                    }
                }
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder('utf-8');
                let buffer = '';
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.substring(6);
                            if (data === '[DONE]') continue;
                            
                            try {
                                const parsed = JSON.parse(data);
                                const content = parsed.choices[0]?.delta?.content || '';
                                if (content) {
                                    onChunk(content);
                                }
                            } catch (e) {
                                console.error('è§£ææµå¼æ•°æ®å‡ºé”™:', e);
                            }
                        }
                    }
                }
            }
            
            // å®Œå–„æ›´æ–°æ‰€æœ‰è¾£æ¤’æ²¹å¤´åƒçš„æ˜¾ç¤ºå‡½æ•°
            function updateAvatarDisplay() {
                if (apiConfig.customAvatar) {
                    // æ¬¢è¿é¡µé¢å¤´åƒ
                    const welcomeAvatar = document.getElementById('welcome-avatar');
                    if (welcomeAvatar) {
                        welcomeAvatar.innerHTML = `<img src="${apiConfig.customAvatar}" alt="è¾£æ¤’æ²¹">`;
                    }
                    
                    // å·²æœ‰æ¶ˆæ¯ä¸­çš„å¤´åƒ
                    const aiAvatars = document.querySelectorAll('.message.ai .avatar');
                    aiAvatars.forEach(avatar => {
                        avatar.innerHTML = `<img src="${apiConfig.customAvatar}" alt="è¾£æ¤’æ²¹">`;
                    });
                } else {
                    // æ¢å¤é»˜è®¤å¤´åƒ
                    const welcomeAvatar = document.getElementById('welcome-avatar');
                    if (welcomeAvatar) {
                        welcomeAvatar.innerHTML = 'ğŸŒ¶ï¸';
                    }
                    
                    // æ¢å¤æ¶ˆæ¯ä¸­çš„é»˜è®¤å¤´åƒ
                    const aiAvatars = document.querySelectorAll('.message.ai .avatar');
                    aiAvatars.forEach(avatar => {
                        avatar.innerHTML = 'è¾£';
                    });
                }
            }
            
            // é¡µé¢åŠ è½½å®Œæˆåéœ€è¦æ‰§è¡Œçš„ç§»åŠ¨ç«¯ä¼˜åŒ–å‡½æ•°
            function optimizeForMobile() {
                // ç‰¹æ®Šå¤„ç†iOSè®¾å¤‡
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
                if (isIOS) {
                    // ä¼˜åŒ–iOSè¡¨å•æ§ä»¶
                    document.querySelectorAll('input, textarea, select').forEach(el => {
                        el.style.fontSize = '16px'; // é¿å…iOSç¼©æ”¾
                    });
                    
                    // ä¿®å¤iOSå›ºå®šå®šä½å…ƒç´ é—®é¢˜
                    document.querySelector('.input-container').style.position = 'fixed';
                }
                
                // ä¿®å¤éƒ¨åˆ†Androidè®¾å¤‡çš„æ¸²æŸ“é—®é¢˜
                if (/Android/.test(navigator.userAgent)) {
                    document.body.style.WebkitOverflowScrolling = 'touch';
                    // ä¿®å¤ä¸€äº›Androidè®¾å¤‡ä¸Šçš„æ¨¡æ€æ¡†æ˜¾ç¤ºé—®é¢˜
                    document.querySelectorAll('.modal').forEach(modal => {
                        modal.addEventListener('touchmove', function(e) {
                            e.stopPropagation();
                        }, { passive: false });
                    });
                }
                
                // ç¡®ä¿æ¨¡æ€æ¡†åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šæ»šåŠ¨æ­£å¸¸
                document.querySelectorAll('.modal-content, .settings-content').forEach(content => {
                    content.style.maxHeight = 'calc(100vh - 60px)';
                    content.style.overflowY = 'auto';
                    content.style.WebkitOverflowScrolling = 'touch';
                });
                
                // ç¡®ä¿è®¾ç½®æŒ‰é’®å§‹ç»ˆå¯è§
                document.querySelector('.settings-buttons').style.position = 'sticky';
                document.querySelector('.settings-buttons').style.bottom = '0';
                document.querySelector('.settings-buttons').style.background = 'var(--card-color)';
                document.querySelector('.settings-buttons').style.padding = '10px 0';
                document.querySelector('.settings-buttons').style.zIndex = '10';
                
                // ç¡®ä¿å†å²è®°å½•åŒºåŸŸåœ¨ç§»åŠ¨ç«¯æ­£ç¡®æ˜¾ç¤º
                if (window.innerWidth <= 768) {
                    sidebar.style.maxHeight = sidebar.classList.contains('collapsed') ? '0' : '150px';
                }
            }
            
            // åœ¨é¡µé¢å…³é—­å‰ä¿å­˜æ•°æ®
            window.addEventListener('beforeunload', saveChats);
            
            // åˆå§‹åŒ–å‡½æ•°ï¼Œç¡®ä¿åœ¨é¡µé¢åŠ è½½æ—¶æ­£ç¡®æ‰§è¡Œ
            function initializeApp() {
                // å…ˆåŠ è½½APIé…ç½®
                loadApiConfig();
                
                // åŠ è½½å†å²å¯¹è¯
                loadChatHistory();
                
                // å¦‚æœæ²¡æœ‰å¯¹è¯ï¼Œåˆ›å»ºä¸€ä¸ªæ–°å¯¹è¯
                if (chats.length === 0) {
                    startNewChat();
                }
                
                // è°ƒæ•´ç§»åŠ¨ç«¯å¸ƒå±€
                setTimeout(() => {
                    manageSidebar();
                    adjustModalForMobile();
                    optimizeForMobile();
                }, 300);
                
                // ç¡®ä¿APIæä¾›å•†æ¨¡å‹é€‰æ‹©æ­£ç¡®
                setTimeout(() => {
                    apiProviderSelect.dispatchEvent(new Event('change'));
                }, 500);
            }
            
            // æ‰§è¡Œåˆå§‹åŒ–
            initializeApp();
            
            // ä¾§è¾¹æ åˆ‡æ¢åŠŸèƒ½
            sidebarToggle.addEventListener('click', function() {
                sidebar.classList.toggle('collapsed');
                
                // å¦‚æœæ˜¯æŠ˜å çŠ¶æ€ï¼Œåˆ™å±•å¼€
                if (sidebar.classList.contains('collapsed')) {
                    sidebar.style.maxHeight = '0';
                } else {
                    // åœ¨ç§»åŠ¨ç«¯å±•å¼€æ—¶ï¼Œç¡®ä¿æœ‰è¶³å¤Ÿé«˜åº¦æ˜¾ç¤ºå†å²å¯¹è¯
                    if (window.innerWidth <= 768) {
                        sidebar.style.maxHeight = '150px';
                    } else {
                        sidebar.style.maxHeight = 'none';
                    }
                }
            });
            
            // ç¡®ä¿ç§»åŠ¨ç«¯åŠ è½½æ—¶ä¾§è¾¹æ æ­£ç¡®æ˜¾ç¤º
            function adjustSidebarForMobile() {
                if (window.innerWidth <= 768) {
                    if (!sidebar.classList.contains('collapsed')) {
                        sidebar.style.maxHeight = '150px';
                    }
                } else {
                    sidebar.style.maxHeight = 'none';
                }
                
                // é‡æ–°è°ƒæ•´æ¨¡æ€çª—å£ä¸­è¡¨å•æ§ä»¶çš„å¸ƒå±€
                if (window.innerWidth <= 480) {
                    const formGroups = document.querySelectorAll('.form-group');
                    formGroups.forEach(group => {
                        group.style.marginBottom = '16px';
                    });
                }
            }
            
            // é¡µé¢åŠ è½½å’Œçª—å£å¤§å°å˜åŒ–æ—¶è°ƒç”¨
            window.addEventListener('resize', adjustSidebarForMobile);
            setTimeout(adjustSidebarForMobile, 100);
            
            // ç§»åŠ¨è®¾å¤‡ä¸Šç‚¹å‡»èŠå¤©åŒºåŸŸè‡ªåŠ¨éšè—ä¾§è¾¹æ 
            function hideMenuOnMobile() {
                if (window.innerWidth <= 768 && !sidebar.classList.contains('collapsed')) {
                    sidebar.classList.add('collapsed');
                }
            }
            
            chatContainer.addEventListener('click', hideMenuOnMobile);
            welcome.addEventListener('click', hideMenuOnMobile);
            
            // åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šï¼Œåœ¨å½“å‰å¯¹è¯ä¸­ç‚¹å‡»æ—¶ä¹Ÿéšè—ä¾§è¾¹æ 
            document.addEventListener('click', function(e) {
                if (window.innerWidth <= 768 && 
                    !sidebar.contains(e.target) && 
                    !sidebarToggle.contains(e.target)) {
                    sidebar.classList.add('collapsed');
                }
            });
            
            // å¤„ç†çª—å£å¤§å°å˜åŒ–
            window.addEventListener('resize', function() {
                // åœ¨å¤§å±å¹•ä¸Šï¼Œå¦‚æœä¾§è¾¹æ æ˜¯æŠ˜å çš„ï¼Œåˆ™å±•å¼€
                if (window.innerWidth > 768 && sidebar.classList.contains('collapsed')) {
                    sidebar.classList.remove('collapsed');
                }
                
                // è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
                inputBox.style.height = 'auto';
                inputBox.style.height = (inputBox.scrollHeight) + 'px';
            });
            
            // æ”¹è¿›ç§»åŠ¨ç«¯çš„æ»šåŠ¨ä½“éªŒ
            function overrideNativeScroll() {
                if (window.innerWidth <= 768) {
                    chatContainer.style.overscrollBehavior = 'contain';
                    document.body.style.overscrollBehavior = 'none';
                } else {
                    chatContainer.style.overscrollBehavior = 'auto';
                    document.body.style.overscrollBehavior = 'auto';
                }
            }
            
            overrideNativeScroll();
            window.addEventListener('resize', overrideNativeScroll);
            
            // ä¼˜åŒ–ç§»åŠ¨ç«¯æ–‡æœ¬è¾“å…¥æ¡†å¤„ç†
            inputBox.addEventListener('focus', function() {
                // åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šèšç„¦è¾“å…¥æ¡†æ—¶è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
                if (window.innerWidth <= 768) {
                    setTimeout(() => {
                        window.scrollTo(0, document.body.scrollHeight);
                    }, 300);
                }
            });
            
            // ä¿®å¤æ¨¡æ€çª—å£åœ¨ç§»åŠ¨ç«¯çš„æ˜¾ç¤ºé—®é¢˜
            function adjustModalForMobile() {
                const isMobile = window.innerWidth <= 768;
                
                if (isMobile) {
                    // è®¾ç½®æ¨¡æ€çª—å£
                    const modals = document.querySelectorAll('.modal-content, .settings-content');
                    modals.forEach(modal => {
                        modal.style.maxHeight = '80vh';
                        modal.style.overflowY = 'auto';
                    });
                    
                    // è®¾ç½®æŒ‰é’®
                    const settingsButtons = document.querySelector('.settings-buttons');
                    if (settingsButtons) {
                        settingsButtons.style.position = 'sticky';
                        settingsButtons.style.bottom = '0';
                        settingsButtons.style.backgroundColor = 'var(--card-color)';
                        settingsButtons.style.zIndex = '10';
                        settingsButtons.style.padding = '10px 0';
                    }
                }
            }
            
            // ä¿®å¤è®¾ç½®æŒ‰é’®åœ¨æŸäº›æƒ…å†µä¸‹ä¸å¯è§çš„é—®é¢˜
            settingsBtn.addEventListener('click', () => {
                settingsModal.style.display = 'flex';
                adjustModalForMobile();
                
                // ç¡®ä¿APIå¯†é’¥è¾“å…¥æ¡†æ­£ç¡®å¡«å……
                setTimeout(() => {
                    updateApiKeyField();
                }, 100);
            });
            
            // åœ¨é¡µé¢åŠ è½½å’Œçª—å£å¤§å°å˜åŒ–æ—¶è°ƒæ•´ä¾§è¾¹æ å’Œæ¨¡æ€çª—å£
            window.addEventListener('resize', () => {
                manageSidebar();
                adjustModalForMobile();
            });
            
            setTimeout(() => {
                manageSidebar();
                adjustModalForMobile();
                
                // ç¡®ä¿APIæä¾›å•†æ¨¡å‹é€‰æ‹©æ­£ç¡®
                apiProviderSelect.dispatchEvent(new Event('change'));
            }, 100);
            
            // ä¾§è¾¹æ é«˜åº¦å’Œå¯è§æ€§ç®¡ç†å‡½æ•° - å¢å¼ºç‰ˆ
            function manageSidebar() {
                const isMobile = window.innerWidth <= 768;
                
                if (isMobile) {
                    // å¦‚æœæ˜¯ç§»åŠ¨ç«¯ä¸”ä¾§è¾¹æ æœªæŠ˜å ï¼Œè®¾ç½®é€‚å½“é«˜åº¦
                    if (!sidebar.classList.contains('collapsed')) {
                        sidebar.style.maxHeight = '150px';
                        sidebar.style.overflowY = 'auto';
                    } else {
                        sidebar.style.maxHeight = '0';
                    }
                } else {
                    // æ¡Œé¢ç«¯
                    sidebar.style.maxHeight = 'none';
                    sidebar.classList.remove('collapsed');
                }
                
                // ç¡®ä¿å†å²å¯¹è¯é¡¹å¯è§
                setTimeout(() => {
                    if (!sidebar.classList.contains('collapsed') && isMobile) {
                        const chatItems = document.querySelectorAll('.chat-item');
                        if (chatItems.length > 0) {
                            chatItems[0].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        }
                    }
                }, 300);
            }
            
            // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©ç•Œé¢
            function appendMessage(content, sender, shouldScroll = true) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}`;
                
                const headerName = sender === 'user' ? 'æ‚¨' : 'è¾£æ¤’æ²¹';
                
                // æ„å»ºå¤´åƒå†…å®¹
                let avatarContent;
                if (sender === 'user') {
                    avatarContent = 'æ‚¨';
                } else {
                    if (apiConfig.customAvatar) {
                        avatarContent = `<img src="${apiConfig.customAvatar}" alt="è¾£æ¤’æ²¹">`;
                    } else {
                        avatarContent = 'è¾£';
                    }
                }
                
                // æ ¼å¼åŒ–æ¶ˆæ¯å†…å®¹
                const formattedContent = formatMessage(content);
                
                messageDiv.innerHTML = `
                    <div class="message-header">
                        <div class="avatar">${avatarContent}</div>
                        <div class="name">${headerName}</div>
                    </div>
                    <div class="message-content">${formattedContent}</div>
                `;
                
                chatContainer.appendChild(messageDiv);
                
                // åº”ç”¨ä»£ç é«˜äº®å’Œæ·»åŠ å¤åˆ¶æŒ‰é’®
                if (sender === 'ai') {
                    applyHighlighting();
                }
                
                if (shouldScroll) {
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }
            }
        });
    </script>
</body>
</html>
