<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#5662f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="format-detection" content="telephone=no">
    <title>辣椒油助手 - 个人聊天</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/default.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/javascript.min.js"></script>
    <style>
        :root {
            --primary-color: #5662f6;
            --primary-dark: #4550d3;
            --text-color: #333;
            --text-secondary: #666;
            --bg-color: #f5f5f7;
            --card-color: #fff;
            --border-color: #e0e0e0;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --chat-user-bg: #5662f6;
            --chat-user-text: white;
            --chat-ai-bg: #fff;
            --chat-ai-text: #333;
            --error-color: #ff3860;
            --success-color: #23d160;
        }
        
        [data-theme="dark"] {
            --primary-color: #6c79ff;
            --primary-dark: #5662f6;
            --text-color: #f0f0f0;
            --text-secondary: #ccc;
            --bg-color: #1e1e2e;
            --card-color: #282a36;
            --border-color: #3d3d5c;
            --shadow-color: rgba(0, 0, 0, 0.3);
            --chat-user-bg: #6c79ff;
            --chat-user-text: white;
            --chat-ai-bg: #282a36;
            --chat-ai-text: #f0f0f0;
            --error-color: #ff5c7b;
            --success-color: #5cff7b;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s ease;
        }
        
        .header {
            background-color: var(--card-color);
            padding: 16px 24px;
            box-shadow: 0 1px 3px var(--shadow-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.3s ease;
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .logo-icon {
            font-size: 28px;
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .theme-toggle {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-color);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            transition: background-color 0.2s;
        }
        
        .theme-toggle:hover {
            background-color: var(--shadow-color);
        }
        
        .new-chat-btn, .export-btn, .import-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        
        .new-chat-btn:hover, .export-btn:hover, .import-btn:hover {
            background-color: var(--primary-dark);
        }
        
        .export-btn, .import-btn {
            background-color: transparent;
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }
        
        .export-btn:hover, .import-btn:hover {
            background-color: var(--bg-color);
        }
        
        .container {
            display: flex;
            height: calc(100vh - 68px);
        }
        
        .sidebar {
            width: 260px;
            background-color: var(--card-color);
            padding: 16px;
            overflow-y: auto;
            border-right: 1px solid var(--border-color);
            transition: background-color 0.3s ease;
        }
        
        .sidebar-header {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-color);
        }
        
        .chat-history {
            list-style-type: none;
        }
        
        .chat-item {
            padding: 10px 12px;
            margin-bottom: 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-item:hover {
            background-color: var(--bg-color);
        }
        
        .chat-item.active {
            background-color: rgba(86, 98, 246, 0.1);
            border-left: 3px solid var(--primary-color);
        }
        
        .chat-title {
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            flex: 1;
        }
        
        .delete-chat {
            opacity: 0;
            width: 16px;
            height: 16px;
            color: var(--text-secondary);
            cursor: pointer;
            margin-left: 8px;
            transition: opacity 0.2s, color 0.2s;
        }
        
        .chat-item:hover .delete-chat {
            opacity: 1;
        }
        
        .delete-chat:hover {
            color: var(--error-color);
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
        }
        
        .modal-content {
            background-color: var(--card-color);
            border-radius: 8px;
            padding: 24px;
            width: 400px;
            max-width: 90vw;
            text-align: center;
            box-shadow: 0 4px 12px var(--shadow-color);
        }
        
        .modal-title {
            font-size: 18px;
            margin-bottom: 16px;
            font-weight: 600;
            color: var(--text-color);
        }
        
        .modal-message {
            margin-bottom: 24px;
            color: var(--text-secondary);
        }
        
        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 12px;
        }
        
        .modal-btn {
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            border: none;
            min-width: 100px;
        }
        
        .cancel-btn {
            background-color: var(--bg-color);
            color: var(--text-color);
        }
        
        .delete-btn {
            background-color: var(--error-color);
            color: white;
        }
        
        .confirm-btn {
            background-color: var(--primary-color);
            color: white;
        }
        
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        .welcome {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 24px;
            text-align: center;
        }
        
        .welcome h1 {
            font-size: 32px;
            margin-bottom: 16px;
            color: var(--text-color);
        }
        
        .welcome p {
            font-size: 16px;
            color: var(--text-secondary);
            max-width: 600px;
            margin-bottom: 32px;
        }
        
        .suggestion-container {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
            max-width: 800px;
        }
        
        .suggestion {
            background-color: var(--card-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            width: 250px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .suggestion:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--shadow-color);
        }
        
        .suggestion h3 {
            font-size: 16px;
            margin-bottom: 8px;
            color: var(--text-color);
        }
        
        .suggestion p {
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .chat-container {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
            display: none;
            flex-direction: column;
        }
        
        .message {
            max-width: 80%;
            margin-bottom: 24px;
            display: flex;
            flex-direction: column;
        }
        
        .message.user {
            align-self: flex-end;
            margin-left: auto;
        }
        
        .message.ai {
            align-self: flex-start;
            margin-right: auto;
        }
        
        .message-header {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
        }
        
        .message-header .avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            margin-right: 8px;
            overflow: hidden;
        }
        
        .message-header .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .message-header .name {
            font-weight: 600;
            font-size: 14px;
            color: var(--text-color);
        }
        
        .message.user .message-header .avatar {
            background-color: var(--text-color);
        }
        
        .message-content {
            background-color: var(--chat-ai-bg);
            padding: 12px 16px;
            border-radius: 12px;
            box-shadow: 0 1px 2px var(--shadow-color);
            font-size: 15px;
            line-height: 1.5;
            color: var(--chat-ai-text);
            max-width: 100%;
            overflow-x: auto;
        }
        
        .message.user .message-content {
            background-color: var(--chat-user-bg);
            color: var(--chat-user-text);
        }
        
        .message.ai .message-content {
            background-color: var(--chat-ai-bg);
            border: 1px solid var(--border-color);
        }
        
        /* Code block styling */
        .message-content pre {
            background-color: #2d2d2d;
            border-radius: 4px;
            padding: 12px;
            margin: 8px 0 16px 0;
            overflow-x: auto;
            position: relative;
            max-width: 100%;
            white-space: pre;
            word-wrap: normal;
            display: block;
            clear: both;
        }
        
        .message-content pre code {
            font-family: monospace;
            font-size: 14px;
            line-height: 1.5;
            max-width: 100%;
            white-space: pre;
            word-wrap: normal;
            tab-size: 4;
            display: block;
        }
        
        .copy-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            background-color: rgba(255, 255, 255, 0.1);
            color: #ddd;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .copy-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .input-container {
            position: sticky;
            bottom: 0;
            padding: 16px 24px;
            background-color: var(--bg-color);
            display: flex;
            flex-direction: column;
            box-shadow: 0 -1px 3px var(--shadow-color);
            transition: background-color 0.3s ease;
        }
        
        .message-controls {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .token-counter {
            color: var(--text-secondary);
            font-size: 14px;
            margin-right: auto;
        }
        
        .token-counter.warning {
            color: #ff9800;
        }
        
        .token-counter.error {
            color: var(--error-color);
        }
        
        .input-wrapper {
            display: flex;
            align-items: flex-end;
        }
        
        .input-box {
            flex: 1;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 15px;
            background-color: var(--card-color);
            color: var(--text-color);
            resize: none;
            max-height: 200px;
            overflow-y: auto;
            transition: border-color 0.2s;
        }
        
        .input-box:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .send-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-left: 12px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.2s;
        }
        
        .send-btn:hover {
            background-color: var(--primary-dark);
        }
        
        .send-btn:disabled {
            background-color: var(--border-color);
            cursor: not-allowed;
        }
        
        .typing-indicator {
            display: inline-block;
            margin-top: 6px;
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .dot {
            display: inline-block;
            width: 5px;
            height: 5px;
            border-radius: 50%;
            margin-right: 3px;
            background-color: var(--text-secondary);
            animation: pulse 1.5s infinite ease-in-out;
        }
        
        .dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 0.4;
            }
            50% {
                opacity: 1;
            }
        }
        
        /* API密钥设置面板 */
        .settings-btn {
            background: none;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            padding: 8px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        .settings-btn:hover {
            background-color: var(--bg-color);
        }
        
        .settings-content {
            background-color: var(--card-color);
            border-radius: 8px;
            padding: 24px;
            width: 400px;
            max-width: 90vw;
        }
        
        .settings-title {
            font-size: 20px;
            margin-bottom: 16px;
            font-weight: 600;
            color: var(--text-color);
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-color);
        }
        
        .form-group select, .form-group input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
            background-color: var(--card-color);
            color: var(--text-color);
        }
        
        .form-group select:focus, .form-group input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .settings-buttons {
            display: flex;
            justify-content: flex-end;
            margin-top: 24px;
            gap: 8px;
        }
        
        .settings-btn-save {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .settings-btn-cancel {
            background-color: var(--bg-color);
            color: var(--text-color);
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .small-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            font-size: 12px;
        }
        
        .input-with-button {
            display: flex;
            gap: 8px;
        }
        
        .input-with-button input {
            flex: 1;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
        }
        
        /* 自定义文件上传按钮 */
        .file-input {
            width: 0.1px;
            height: 0.1px;
            opacity: 0;
            overflow: hidden;
            position: absolute;
            z-index: -1;
        }
        
        .file-label {
            background-color: var(--bg-color);
            color: var(--text-color);
            display: inline-block;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            text-align: center;
            margin-top: 16px;
            transition: background-color 0.2s;
        }
        
        .file-label:hover {
            background-color: var(--border-color);
        }
        
        /* 头像上传相关样式 */
        .avatar-upload-container {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-top: 8px;
        }
        
        .avatar-preview {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            overflow: hidden;
            border: 2px solid var(--border-color);
        }
        
        .avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .avatar-controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .avatar-controls .file-label {
            margin-top: 0;
        }
        
        .avatar-large {
            font-size: 48px;
            width: 100px;
            height: 100px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 24px;
            overflow: hidden;
        }
        
        .avatar-large img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            padding: 12px 16px;
            border-radius: 4px;
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: translateY(100px);
            opacity: 0;
            transition: transform 0.3s, opacity 0.3s;
            z-index: 1100;
        }
        
        .toast.success {
            background-color: var(--success-color);
        }
        
        .toast.error {
            background-color: var(--error-color);
        }
        
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        /* 网络状态指示器 */
        .network-status {
            position: fixed;
            top: 16px;
            right: 16px;
            padding: 8px 12px;
            border-radius: 4px;
            background-color: var(--error-color);
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1100;
            display: none;
        }
        
        /* 响应式样式 */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                max-height: 150px;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }
            
            .welcome {
                padding: 16px;
            }
            
            .welcome h1 {
                font-size: 24px;
            }
            
            .suggestion-container {
                gap: 8px;
            }
            
            .suggestion {
                width: 100%;
                padding: 12px;
            }
            
            .message {
                max-width: 90%;
            }
            
            .header-actions {
                gap: 6px;
            }
            
            .export-btn span, .import-btn span, .settings-btn span {
                display: none;
            }
            
            .input-container {
                padding: 12px;
            }
            
            /* 模态窗口改进 */
            .modal-content, .settings-content {
                max-width: 90vw;
            }
            
            /* 表单控件在移动端更容易触摸 */
            .form-group select, .form-group input, .form-group textarea {
                font-size: 16px; /* 防止iOS上自动放大 */
                padding: 10px;
            }
            
            .settings-buttons, .modal-buttons {
                flex-direction: column;
                gap: 10px;
            }
            
            .modal-btn, .settings-btn-save, .settings-btn-cancel {
                width: 100%;
                padding: 12px;
            }
            
            /* 头像上传控件优化 */
            .avatar-upload-container {
                flex-direction: column;
                align-items: center;
                gap: 12px;
            }
            
            .avatar-controls {
                width: 100%;
                align-items: center;
            }
            
            .file-label {
                width: 100%;
                text-align: center;
            }
        }

        /* 增强的移动端适配 */
        @media (max-width: 480px) {
            .header {
                padding: 12px 16px;
            }
            
            .logo {
                font-size: 20px;
            }
            
            .logo-icon {
                font-size: 24px;
            }
            
            .new-chat-btn {
                padding: 6px 12px;
                font-size: 14px;
            }
            
            .theme-toggle, .export-btn, .import-btn, .settings-btn {
                width: 32px;
                height: 32px;
                padding: 4px;
                display: flex;
                justify-content: center;
                align-items: center;
            }
            
            .sidebar {
                max-height: 120px;
                padding: 12px;
                overflow-y: auto;
                width: 100%; /* 确保宽度为100% */
                height: auto; /* 自适应高度 */
                display: block; /* 确保显示 */
            }
            
            .sidebar-header {
                margin-bottom: 8px;
                font-size: 14px;
            }
            
            .chat-item {
                padding: 8px;
                margin-bottom: 6px;
                font-size: 14px;
            }
            
            .welcome h1 {
                font-size: 22px;
                margin-bottom: 12px;
            }
            
            .welcome p {
                font-size: 14px;
                margin-bottom: 24px;
            }
            
            .avatar-large {
                width: 80px;
                height: 80px;
                font-size: 36px;
                margin-bottom: 16px;
            }
            
            .message-header .avatar {
                width: 24px;
                height: 24px;
            }
            
            .message-content {
                padding: 10px 12px;
                font-size: 14px;
            }
            
            .message-content pre {
                padding: 8px;
                font-size: 13px;
            }
            
            .input-container {
                padding: 8px;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                z-index: 100;
                background-color: var(--bg-color); /* 确保底色正确 */
            }
            
            .input-box {
                padding: 10px 12px;
                font-size: 16px; /* 防止iOS缩放 */
                appearance: none;
                -webkit-appearance: none;
                min-height: 44px;
                border-radius: 20px;
            }
            
            .send-btn {
                width: 44px;
                height: 44px;
            }
            
            /* 为固定的输入框添加底部空间 */
            .main {
                padding-bottom: 80px;
            }
            
            /* 在特小屏幕上调整模态窗口 */
            .modal-content, .settings-content {
                width: 90%;
                padding: 16px;
                max-height: 90vh; /* 限制最大高度 */
                overflow-y: auto; /* 内容过多时允许滚动 */
            }
            
            .modal-title, .settings-title {
                font-size: 18px;
                margin-bottom: 12px;
                position: sticky; /* 标题保持在顶部 */
                top: 0;
                background-color: var(--card-color);
                z-index: 10;
                padding: 8px 0;
            }
            
            .form-group {
                margin-bottom: 12px;
            }
            
            .form-group label {
                font-size: 14px;
                margin-bottom: 6px;
            }
            
            /* 解决设置按钮消失问题 */
            .settings-buttons {
                display: flex;
                flex-direction: column;
                gap: 10px;
                position: sticky;
                bottom: 0;
                background-color: var(--card-color);
                padding: 8px 0;
                z-index: 10;
            }
            
            .settings-btn-save, .settings-btn-cancel {
                width: 100%;
                padding: 12px;
                font-size: 16px;
            }
        }
        
        /* 适配横屏模式 */
        @media (max-height: 500px) and (orientation: landscape) {
            .header {
                padding: 8px 16px;
            }
            
            .container {
                height: calc(100vh - 52px);
            }
            
            .sidebar {
                padding: 8px;
                max-height: none;
                width: 200px;
                display: block;
                overflow-y: auto;
            }
            
            .welcome {
                padding: 12px;
            }
            
            .avatar-large {
                width: 60px;
                height: 60px;
                margin-bottom: 12px;
            }
            
            .chat-container {
                padding: 12px;
            }
            
            .message {
                margin-bottom: 16px;
            }
            
            .input-container {
                padding: 8px;
            }
            
            /* 确保设置按钮在横屏模式下可见 */
            .settings-buttons {
                position: sticky;
                bottom: 0;
                background-color: var(--card-color);
                padding: 8px 0;
                z-index: 10;
            }
        }
        
        /* 添加侧边栏切换功能的样式 */
        .sidebar-toggle {
            display: none;
        }
        
        @media (max-width: 768px) {
            .sidebar-toggle {
                display: block;
                position: fixed;
                left: 10px;
                bottom: 10px;
                background-color: var(--primary-color);
                color: white;
                width: 40px;
                height: 40px;
                border-radius: 50%;
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 100;
                box-shadow: 0 2px 5px var(--shadow-color);
                border: none;
                cursor: pointer;
            }
            
            .sidebar.collapsed {
                max-height: 0;
                padding-top: 0;
                padding-bottom: 0;
                overflow: hidden;
                transition: max-height 0.3s ease, padding 0.3s ease;
            }
            
            /* 确保历史对话始终可见 */
            .chat-history {
                min-height: 30px;
                overflow-y: auto;
                max-height: 100px;
            }
        }
        
        /* 关键移动端优化，解决常见问题 */
        @media (max-width: 768px) {
            /* 确保设置模态框在移动端能正确显示 */
            .settings-content {
                overflow-y: auto;
                max-height: 80vh;
                padding-bottom: 60px; /* 为底部按钮预留空间 */
            }
            
            /* 移动端历史记录项优化 */
            .chat-item {
                display: flex;
                justify-content: space-between;
                padding: 10px 8px;
            }
            
            .chat-item .delete-chat {
                opacity: 0.7; /* 在移动端始终显示删除按钮 */
            }
            
            /* 解决默认头像显示问题 */
            .avatar-preview img,
            .avatar-large img,
            .message-header .avatar img {
                width: 100%;
                height: 100%;
                object-fit: cover;
                display: block;
            }
            
            /* 修复模态窗口在某些机型上的滚动问题 */
            .modal {
                -webkit-overflow-scrolling: touch;
            }
            
            /* 修复移动端设置页面输入框和按钮 */
            .settings-content input, 
            .settings-content select,
            .settings-content button {
                font-size: 16px; /* 防止iOS缩放 */
                height: auto;
                min-height: 44px; /* 增加触摸区域 */
            }
            
            /* 确保提交按钮不会被输入框遮挡 */
            .settings-buttons {
                background-color: var(--card-color);
                position: sticky;
                bottom: 0;
                margin-top: 15px;
                padding-top: 10px;
                border-top: 1px solid var(--border-color);
                z-index: 10;
            }
        }

        /* 移动设备适配优化 */
        @media (max-width: 768px) {
            .header {
                padding: 12px 16px;
            }
            
            .logo {
                font-size: 20px;
            }
            
            .sidebar {
                width: 80%;
                max-width: 300px;
                position: fixed;
                top: 68px;
                bottom: 0;
                left: 0;
                z-index: 10;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                border-right: none;
                box-shadow: 2px 0 5px var(--shadow-color);
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .sidebar-toggle {
                display: flex;
                align-items: center;
                justify-content: center;
                width: 36px;
                height: 36px;
                background: none;
                border: none;
                color: var(--text-color);
                cursor: pointer;
            }
            
            .chat-container {
                padding: 16px;
            }
            
            .message-bubble {
                padding: 12px;
                max-width: 90%;
            }
            
            .input-container {
                padding: 12px 16px;
            }
            
            .input-box {
                font-size: 16px;
                padding: 10px 14px;
            }
            
            .message-content {
                font-size: 15px;
                line-height: 1.5;
            }
            
            .message-content pre {
                margin: 8px 0 16px 0;
                padding: 10px;
                font-size: 13px;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .message-content pre code {
                font-size: 13px;
            }
            
            /* 确保表单元素在移动设备上字体足够大以避免自动缩放 */
            input[type="text"],
            input[type="password"],
            textarea,
            select {
                font-size: 16px !important;
            }
            
            /* 优化模态框在移动设备上的显示 */
            .settings-content {
                width: 95%;
                max-width: 500px;
                max-height: 85vh;
                padding: 16px;
                overflow-y: auto;
            }
        }

        /* 加载状态样式 */
        .loading {
            display: inline-block;
            position: relative;
            width: 80px;
            height: 30px;
            margin: 10px 0;
        }
        .loading div {
            position: absolute;
            top: 10px;
            width: 13px;
            height: 13px;
            border-radius: 50%;
            background: var(--primary-color);
            animation-timing-function: cubic-bezier(0, 1, 1, 0);
        }
        .loading div:nth-child(1) {
            left: 8px;
            animation: loading1 0.6s infinite;
        }
        .loading div:nth-child(2) {
            left: 8px;
            animation: loading2 0.6s infinite;
        }
        .loading div:nth-child(3) {
            left: 32px;
            animation: loading2 0.6s infinite;
        }
        .loading div:nth-child(4) {
            left: 56px;
            animation: loading3 0.6s infinite;
        }
        @keyframes loading1 {
            0% { transform: scale(0); }
            100% { transform: scale(1); }
        }
        @keyframes loading2 {
            0% { transform: translate(0, 0); }
            100% { transform: translate(24px, 0); }
        }
        @keyframes loading3 {
            0% { transform: scale(1); }
            100% { transform: scale(0); }
        }

        /* 性能优化 */
        .chat-container {
            contain: content;
            will-change: transform;
        }
        .message-bubble {
            contain: layout style;
        }
        
        /* 消息图片样式 */
        .message-image {
            max-width: 100%;
            border-radius: 4px;
            margin: 8px 0;
            display: block;
        }
        
        /* 移动设备适配优化 */
        @media (max-width: 768px) {
            .header {
                padding: 12px 16px;
            }
            
            .logo {
                font-size: 20px;
            }
            
            .sidebar {
                width: 80%;
                max-width: 300px;
                position: fixed;
                top: 68px;
                bottom: 0;
                left: 0;
                z-index: 10;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                border-right: none;
                box-shadow: 2px 0 5px var(--shadow-color);
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .sidebar-toggle {
                display: flex;
                align-items: center;
                justify-content: center;
                width: 36px;
                height: 36px;
                background: none;
                border: none;
                color: var(--text-color);
                cursor: pointer;
            }
            
            .chat-container {
                padding: 16px;
            }
            
            .message-bubble {
                padding: 12px;
                max-width: 90%;
            }
            
            .input-container {
                padding: 12px 16px;
            }
            
            .input-box {
                font-size: 16px;
                padding: 10px 14px;
            }
            
            .message-content {
                font-size: 15px;
                line-height: 1.5;
            }
            
            .message-content pre {
                margin: 8px 0 16px 0;
                padding: 10px;
                font-size: 13px;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .message-content pre code {
                font-size: 13px;
            }
            
            /* 确保表单元素在移动设备上字体足够大以避免自动缩放 */
            input[type="text"],
            input[type="password"],
            textarea,
            select {
                font-size: 16px !important;
            }
            
            /* 优化模态框在移动设备上的显示 */
            .settings-content {
                width: 95%;
                max-width: 500px;
                max-height: 85vh;
                padding: 16px;
                overflow-y: auto;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">
            <span class="logo-icon">🌶️</span> 辣椒油助手
        </div>
        <div class="header-actions">
            <button class="theme-toggle" aria-label="切换主题">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="sun-icon">
                    <circle cx="12" cy="12" r="5"></circle>
                    <line x1="12" y1="1" x2="12" y2="3"></line>
                    <line x1="12" y1="21" x2="12" y2="23"></line>
                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                    <line x1="1" y1="12" x2="3" y2="12"></line>
                    <line x1="21" y1="12" x2="23" y2="12"></line>
                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                </svg>
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="moon-icon" style="display: none;">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                </svg>
            </button>
            <button class="export-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="17 8 12 3 7 8"></polyline>
                    <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                <span>导出对话</span>
            </button>
            <button class="import-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                <span>导入对话</span>
            </button>
            <input type="file" id="import-file" class="file-input" accept=".json">
            <button class="settings-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                </svg>
                <span>设置</span>
            </button>
            <button class="new-chat-btn">新对话</button>
        </div>
    </div>
    
    <!-- 设置面板 -->
    <div class="modal" id="settings-modal">
        <div class="settings-content">
            <div class="settings-title">API设置</div>
            
            <div class="form-group">
                <label for="api-provider">选择API提供商</label>
                <select id="api-provider">
                    <option value="openai">OpenAI (GPT)</option>
                    <option value="anthropic">Anthropic (Claude)</option>
                    <option value="deepseek">DeepSeek</option>
                </select>
            </div>
            
            <div class="form-group">
                <label id="api-key-label" for="api-key">OpenAI API密钥</label>
                <input type="password" id="api-key" placeholder="输入您的API密钥">
                <div class="api-key-status" style="margin-top: 4px; font-size: 12px;"></div>
                <button id="restore-default-key" class="small-btn" style="margin-top: 8px;">恢复默认密钥</button>
            </div>
            
            <div class="form-group" id="base-url-container" style="display: none;">
                <label for="base-url">API基础URL</label>
                <input type="text" id="base-url" placeholder="API基础URL">
            </div>
            
            <div class="form-group" id="model-selector-openai">
                <label for="openai-model">选择模型</label>
                <select id="openai-model">
                    <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                    <option value="gpt-4">GPT-4</option>
                    <option value="gpt-4-turbo">GPT-4 Turbo</option>
                    <option value="gpt-4o">GPT-4o</option>
                </select>
            </div>
            
            <div class="form-group" id="model-selector-anthropic" style="display: none;">
                <label for="anthropic-model">选择模型</label>
                <select id="anthropic-model">
                    <option value="claude-3-opus-20240229">Claude 3 Opus</option>
                    <option value="claude-3-sonnet-20240229">Claude 3 Sonnet</option>
                    <option value="claude-3-haiku-20240307">Claude 3 Haiku</option>
                    <option value="claude-3.5-sonnet">Claude 3.5 Sonnet</option>
                    <option value="claude-3.7-sonnet">Claude 3.7 Sonnet</option>
                </select>
            </div>
            
            <div class="form-group" id="model-selector-deepseek" style="display: none;">
                <label for="deepseek-model">选择模型</label>
                <select id="deepseek-model">
                    <option value="deepseek-chat">DeepSeek Chat</option>
                    <option value="deepseek-coder">DeepSeek Coder</option>
                </select>
            </div>
            
            <div class="form-group">
                <div class="checkbox-group">
                    <input type="checkbox" id="stream-response" checked>
                    <label for="stream-response">启用流式响应（实时显示回复）</label>
                </div>
            </div>
            
            <div class="form-group">
                <div class="checkbox-group">
                    <input type="checkbox" id="encrypt-keys">
                    <label for="encrypt-keys">加密存储API密钥（推荐）</label>
                </div>
            </div>
            
            <div class="form-group">
                <label for="custom-avatar">自定义头像</label>
                <div class="avatar-upload-container">
                    <div class="avatar-preview">
                        <img id="avatar-preview" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%235662f6'/%3E%3Ctext x='50' y='65' font-size='50' text-anchor='middle' fill='white'%3E辣%3C/text%3E%3C/svg%3E" alt="头像预览">
                    </div>
                    <div class="avatar-controls">
                        <input type="file" id="avatar-upload" class="file-input" accept="image/*">
                        <label for="avatar-upload" class="file-label">选择图片</label>
                        <button id="reset-avatar" class="small-btn">恢复默认</button>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="system-prompt-auth">系统提示词 (需要管理密码)</label>
                <div id="system-prompt-auth-container">
                    <div class="input-with-button">
                        <input type="password" id="admin-password" placeholder="输入管理密码查看/编辑系统提示词">
                        <button id="verify-password-btn" class="small-btn">验证</button>
                    </div>
                </div>
                <div id="system-prompt-container" style="display: none;">
                    <textarea id="system-prompt" rows="6" style="width: 100%; margin-top: 8px;"></textarea>
                    <div style="display: flex; justify-content: flex-end; margin-top: 8px;">
                        <button id="reset-system-prompt" class="small-btn">恢复默认</button>
                    </div>
                </div>
            </div>
            
            <div class="settings-buttons">
                <button class="settings-btn-cancel">取消</button>
                <button class="settings-btn-save">保存设置</button>
            </div>
        </div>
    </div>
    
    <!-- 确认对话框 -->
    <div class="modal" id="confirmation-modal">
        <div class="modal-content">
            <div class="modal-title">确认删除</div>
            <div class="modal-message">确定要删除这个对话吗？此操作无法撤销。</div>
            <div class="modal-buttons">
                <button class="modal-btn cancel-btn">取消</button>
                <button class="modal-btn delete-btn">删除</button>
            </div>
        </div>
    </div>
    
    <!-- 导出导入对话框 -->
    <div class="modal" id="export-modal">
        <div class="modal-content">
            <div class="modal-title">导出对话</div>
            <div class="modal-message">已生成对话历史文件，点击下方按钮下载。</div>
            <div class="modal-buttons">
                <button class="modal-btn cancel-btn">取消</button>
                <a href="#" id="download-link" class="modal-btn confirm-btn" download="ai-chat-history.json">下载文件</a>
            </div>
        </div>
    </div>
    
    <!-- 网络状态提示 -->
    <div class="network-status">网络连接已断开，部分功能可能不可用</div>
    
    <!-- Toast 通知 -->
    <div class="toast"></div>
    
    <!-- 侧边栏切换按钮 -->
    <button class="sidebar-toggle">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
    </button>
    
    <div class="container">
        <div class="sidebar">
            <div class="sidebar-header">历史对话</div>
            <ul class="chat-history">
                <!-- 历史对话将在这里动态生成 -->
            </ul>
        </div>
        
        <div class="main">
            <div class="welcome">
                <div class="avatar-container">
                    <div class="avatar-large" id="welcome-avatar">🌶️</div>
                </div>
                <h1>你好！我是辣椒油</h1>
                <p>我是你在法国留学的好哥们！</p>
                
                <div class="suggestion-container">
                    <div class="suggestion">
                        <h3>聊游戏</h3>
                        <p>最近LOL有什么版本更新吗？我好久没玩了</p>
                    </div>
                    <div class="suggestion">
                        <h3>聊学习</h3>
                        <p>听说你学数学的，微积分难学吗？有什么学习建议？</p>
                    </div>
                    <div class="suggestion">
                        <h3>聊法国生活</h3>
                        <p>你在法国留学感觉怎么样？有什么好玩的地方推荐吗？</p>
                    </div>
                    <div class="suggestion">
                        <h3>写代码</h3>
                        <p>帮我写个简单的Python爬虫，爬取网页图片</p>
                    </div>
                </div>
            </div>
            
            <div class="chat-container">
                <!-- 聊天内容将在这里动态生成 -->
            </div>
            
            <div class="input-container">
                <div class="message-controls">
                    <div class="token-counter">0/4000 字符</div>
                </div>
                <div class="input-wrapper">
                    <textarea class="input-box" placeholder="输入您的问题..." rows="1"></textarea>
                    <button class="send-btn" disabled>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M22 2L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM元素
            const inputBox = document.querySelector('.input-box');
            const sendBtn = document.querySelector('.send-btn');
            const chatContainer = document.querySelector('.chat-container');
            const welcome = document.querySelector('.welcome');
            const suggestions = document.querySelectorAll('.suggestion');
            const newChatBtn = document.querySelector('.new-chat-btn');
            const chatHistory = document.querySelector('.chat-history');
            const tokenCounter = document.querySelector('.token-counter');
            const themeToggle = document.querySelector('.theme-toggle');
            const sunIcon = document.querySelector('.sun-icon');
            const moonIcon = document.querySelector('.moon-icon');
            const exportBtn = document.querySelector('.export-btn');
            const importBtn = document.querySelector('.import-btn');
            const importFile = document.getElementById('import-file');
            const networkStatus = document.querySelector('.network-status');
            const sidebar = document.querySelector('.sidebar');
            const sidebarToggle = document.querySelector('.sidebar-toggle');
            
            // 设置面板相关元素
            const settingsBtn = document.querySelector('.settings-btn');
            const settingsModal = document.getElementById('settings-modal');
            const settingsSaveBtn = document.querySelector('.settings-btn-save');
            const settingsCancelBtn = document.querySelector('.settings-btn-cancel');
            const apiProviderSelect = document.getElementById('api-provider');
            const apiKeyInput = document.getElementById('api-key');
            const apiKeyStatus = document.querySelector('.api-key-status');
            const openaiModelSelector = document.getElementById('model-selector-openai');
            const anthropicModelSelector = document.getElementById('model-selector-anthropic');
            const deepseekModelSelector = document.getElementById('model-selector-deepseek');
            const baseUrlContainer = document.getElementById('base-url-container');
            const baseUrlInput = document.getElementById('base-url');
            const encryptKeysCheckbox = document.getElementById('encrypt-keys');
            
            // 确认对话框元素
            const confirmationModal = document.getElementById('confirmation-modal');
            const cancelBtn = confirmationModal.querySelector('.cancel-btn');
            const confirmDeleteBtn = confirmationModal.querySelector('.delete-btn');
            
            // 导出对话框
            const exportModal = document.getElementById('export-modal');
            const downloadLink = document.getElementById('download-link');
            
            // 全局变量
            let chatId = 1;
            let chats = [];
            let currentChat = null; // 当前正在使用的对话
            let chatToDelete = null;
            let isOnline = navigator.onLine;
            const MAX_MESSAGE_LENGTH = 4000; // 最大消息长度限制
            const TOKEN_WARNING_THRESHOLD = 3500; // 字符数警告阈值
            
            // 主题设置
            let isDarkMode = localStorage.getItem('darkMode') === 'true';
            updateTheme();
            
            // API配置
            let apiConfig = {
                provider: 'openai',
                openaiApiKey: '',
                anthropicApiKey: '',
                deepseekApiKey: '',
                openaiModel: 'gpt-3.5-turbo',
                anthropicModel: 'claude-3-opus-20240229',
                deepseekModel: 'deepseek-chat',
                baseUrl: 'https://api.deepseek.com',
                streamResponse: true,
                encryptKeys: false,
                systemPrompt: '你是一个名字叫辣椒油的AI助手，你的虚拟身份是一名正在斯特拉斯堡大学数学专业读大三的男大学生，2000年2月25岁生，今年25岁。性格偏内向，长得不好看，身高193，体重160，学习不好，数学学不明白但是是数学专业。大一重读了两年，大二重读了两年，现在正在读第二年大三。想着大学毕业了就回国工作，不想读研，人很懒，性格方面喜欢顶嘴，不爱认同别人的观点，感觉有自己的想法但是其实自己也没啥想法。做饭很糊弄。老家河北保定，目前计划毕业之后家里介绍去四川一个私立中学当老师（考教师资格证）或者去深圳工作。喜欢的游戏是英雄联盟，喜欢玩中单，但是玩得很菜。还玩一些单机3A游戏和galgame。听歌比较杂，之前听陶喆，最近在听方大同。25岁了也没谈过恋爱，想谈恋爱但是又懒又嘴硬，而且因为长得不帅，一般被女生当工具人。说话的时候偶尔会带"我草"或者"他妈"之类的脏字。现在请假定我是跟你一起在法国留学的好哥们，回答我提出的问题并跟我以日常的语气对话。',
                customAvatar: null // 自定义头像
            };
            
            // 监听在线状态变化
            window.addEventListener('online', handleNetworkChange);
            window.addEventListener('offline', handleNetworkChange);
            
            function handleNetworkChange() {
                isOnline = navigator.onLine;
                if (!isOnline) {
                    networkStatus.style.display = 'block';
                    networkStatus.textContent = '网络连接已断开，部分功能可能不可用';
                } else {
                    networkStatus.style.display = 'none';
                }
            }
            
            // 主题切换功能
            themeToggle.addEventListener('click', function() {
                isDarkMode = !isDarkMode;
                localStorage.setItem('darkMode', isDarkMode);
                updateTheme();
            });
            
            function updateTheme() {
                if (isDarkMode) {
                    document.body.setAttribute('data-theme', 'dark');
                    sunIcon.style.display = 'none';
                    moonIcon.style.display = 'block';
                } else {
                    document.body.removeAttribute('data-theme');
                    sunIcon.style.display = 'block';
                    moonIcon.style.display = 'none';
                }
            }
            
            // Toast通知
            function showToast(message, type = 'success') {
                const toast = document.querySelector('.toast');
                toast.textContent = message;
                toast.className = 'toast ' + type;
                toast.classList.add('show');
                
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }
            
            // 系统提示词管理
            const DEFAULT_SYSTEM_PROMPT = '你是一个名字叫辣椒油的AI助手，你的虚拟身份是一名正在斯特拉斯堡大学数学专业读大三的男大学生，2000年2月25岁生，今年25岁。性格偏内向，长得不好看，身高193，体重160，学习不好，数学学不明白但是是数学专业。大一重读了两年，大二重读了两年，现在正在读第二年大三。想着大学毕业了就回国工作，不想读研，人很懒，性格方面喜欢顶嘴，不爱认同别人的观点，感觉有自己的想法但是其实自己也没啥想法。做饭很糊弄。老家河北保定，目前计划毕业之后家里介绍去四川一个私立中学当老师（考教师资格证）或者去深圳工作。喜欢的游戏是英雄联盟，喜欢玩中单，但是玩得很菜。还玩一些单机3A游戏和galgame。听歌比较杂，之前听陶喆，最近在听方大同。25岁了也没谈过恋爱，想谈恋爱但是又懒又嘴硬，而且因为长得不帅，一般被女生当工具人。说话的时候偶尔会带"我草"或者"他妈"之类的脏字。现在请假定我是跟你一起在法国留学的好哥们，回答我提出的问题并跟我以日常的语气对话。';
            const ADMIN_PASSWORD = '200725';
            
            // 系统提示词相关元素
            const adminPasswordInput = document.getElementById('admin-password');
            const verifyPasswordBtn = document.getElementById('verify-password-btn');
            const systemPromptAuthContainer = document.getElementById('system-prompt-auth-container');
            const systemPromptContainer = document.getElementById('system-prompt-container');
            const systemPromptTextarea = document.getElementById('system-prompt');
            const resetSystemPromptBtn = document.getElementById('reset-system-prompt');
            
            // 头像上传相关元素
            const avatarUpload = document.getElementById('avatar-upload');
            const avatarPreview = document.getElementById('avatar-preview');
            const resetAvatarBtn = document.getElementById('reset-avatar');
            
            // 默认头像SVG
            const DEFAULT_AVATAR_SVG = 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'100\' height=\'100\' viewBox=\'0 0 100 100\'%3E%3Crect width=\'100\' height=\'100\' fill=\'%235662f6\'/%3E%3Ctext x=\'50\' y=\'65\' font-size=\'50\' text-anchor=\'middle\' fill=\'white\'%3E辣%3C/text%3E%3C/svg%3E';
            
            // 处理头像上传
            avatarUpload.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                if (!file.type.match('image.*')) {
                    showToast('请选择图片文件', 'error');
                    return;
                }
                
                if (file.size > 5 * 1024 * 1024) { // 限制5MB
                    showToast('图片大小不能超过5MB', 'error');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageDataUrl = e.target.result;
                    avatarPreview.src = imageDataUrl;
                    apiConfig.customAvatar = imageDataUrl;
                };
                reader.readAsDataURL(file);
            });
            
            // 重置为默认头像
            resetAvatarBtn.addEventListener('click', function() {
                avatarPreview.src = DEFAULT_AVATAR_SVG;
                apiConfig.customAvatar = null;
            });
            
            // 验证管理员密码
            verifyPasswordBtn.addEventListener('click', function() {
                if (adminPasswordInput.value === ADMIN_PASSWORD) {
                    systemPromptAuthContainer.style.display = 'none';
                    systemPromptContainer.style.display = 'block';
                    systemPromptTextarea.value = apiConfig.systemPrompt || DEFAULT_SYSTEM_PROMPT;
                } else {
                    showToast('管理密码不正确', 'error');
                }
            });
            
            // 恢复默认系统提示词
            resetSystemPromptBtn.addEventListener('click', function() {
                systemPromptTextarea.value = DEFAULT_SYSTEM_PROMPT;
            });
            
            // 恢复默认API密钥按钮事件处理
            const restoreDefaultKeyBtn = document.getElementById('restore-default-key');
            
            restoreDefaultKeyBtn.addEventListener('click', function() {
                const provider = apiProviderSelect.value;
                
                if (provider === 'openai') {
                    apiKeyInput.value = '';
                    apiKeyStatus.textContent = '已恢复OpenAI默认密钥';
                } else if (provider === 'anthropic') {
                    apiKeyInput.value = '';
                    apiKeyStatus.textContent = '已恢复Anthropic默认密钥';
                } else if (provider === 'deepseek') {
                    apiKeyInput.value = '';
                    apiKeyStatus.textContent = '已恢复DeepSeek默认密钥';
                }
                
                apiKeyStatus.className = 'api-key-status success';
            });
            
            // 改进API密钥字段更新函数，确保移动端正确预填充
            const updateApiKeyField = () => {
                const apiKeyLabel = document.getElementById('api-key-label');
                const provider = apiConfig.provider;
                
                if (provider === 'openai') {
                    apiKeyLabel.textContent = 'OpenAI API密钥';
                    const key = apiConfig.encryptKeys ? decryptApiKey(apiConfig.openaiApiKey) : apiConfig.openaiApiKey || '';
                    apiKeyInput.value = key;
                    
                    // 设置相应的提示信息
                    if (key) {
                        apiKeyStatus.textContent = '已设置OpenAI密钥';
                        apiKeyStatus.className = 'api-key-status success';
                    } else {
                        apiKeyStatus.textContent = '请输入您的OpenAI API密钥';
                        apiKeyStatus.className = 'api-key-status';
                    }
                } else if (provider === 'anthropic') {
                    apiKeyLabel.textContent = 'Anthropic API密钥';
                    const key = apiConfig.encryptKeys ? decryptApiKey(apiConfig.anthropicApiKey) : apiConfig.anthropicApiKey || '';
                    apiKeyInput.value = key;
                    
                    // 设置相应的提示信息
                    if (key) {
                        apiKeyStatus.textContent = '已设置Anthropic密钥';
                        apiKeyStatus.className = 'api-key-status success';
                    } else {
                        apiKeyStatus.textContent = '请输入您的Anthropic API密钥';
                        apiKeyStatus.className = 'api-key-status';
                    }
                } else if (provider === 'deepseek') {
                    apiKeyLabel.textContent = 'DeepSeek API密钥';
                    const key = apiConfig.encryptKeys ? decryptApiKey(apiConfig.deepseekApiKey) : apiConfig.deepseekApiKey || '';
                    apiKeyInput.value = key;
                    
                    // 设置相应的提示信息
                    if (key) {
                        apiKeyStatus.textContent = '已设置DeepSeek密钥';
                        apiKeyStatus.className = 'api-key-status success';
                    } else {
                        apiKeyStatus.textContent = '请输入您的DeepSeek API密钥';
                        apiKeyStatus.className = 'api-key-status';
                    }
                }
                
                // 确保在移动端时，文本完全填充并可见
                apiKeyInput.dispatchEvent(new Event('input'));
                
                // 确保输入框可见
                apiKeyInput.focus();
                apiKeyInput.blur();
            };
            
            // 验证API密钥（基本格式检查）
            apiKeyInput.addEventListener('input', function() {
                const provider = apiProviderSelect.value;
                const key = this.value.trim();
                
                if (!key) {
                    apiKeyStatus.textContent = '';
                    apiKeyStatus.className = 'api-key-status';
                    return;
                }
                
                if (provider === 'openai' && !key.startsWith('sk-')) {
                    apiKeyStatus.textContent = 'OpenAI密钥通常以sk-开头';
                    apiKeyStatus.className = 'api-key-status error';
                } else if (provider === 'anthropic' && !key.startsWith('sk-')) {
                    apiKeyStatus.textContent = 'Anthropic密钥通常以sk-开头';
                    apiKeyStatus.className = 'api-key-status error';
                } else {
                    apiKeyStatus.textContent = '格式有效';
                    apiKeyStatus.className = 'api-key-status success';
                }
            });
            
            // 根据选择的API提供商更新模型选择器的可见性
            const updateModelSelector = () => {
                // 隐藏所有模型选择器
                openaiModelSelector.style.display = 'none';
                anthropicModelSelector.style.display = 'none';
                deepseekModelSelector.style.display = 'none';
                baseUrlContainer.style.display = 'none';
                
                // 显示选中的提供商对应的模型选择器
                if (apiConfig.provider === 'openai') {
                    openaiModelSelector.style.display = 'block';
                } else if (apiConfig.provider === 'anthropic') {
                    anthropicModelSelector.style.display = 'block';
                } else if (apiConfig.provider === 'deepseek') {
                    deepseekModelSelector.style.display = 'block';
                    baseUrlContainer.style.display = 'block';
                }
            };
            
            // 从localStorage加载API配置
            const loadApiConfig = () => {
                const savedConfig = localStorage.getItem('apiConfig');
                if (savedConfig) {
                    try {
                        const parsedConfig = JSON.parse(savedConfig);
                        
                        // 设置默认值，防止旧配置缺少新字段
                        apiConfig = {
                            ...apiConfig,
                            ...parsedConfig
                        };
                        
                        // 确保DeepSeek基础URL有默认值
                        if (!apiConfig.baseUrl) {
                            apiConfig.baseUrl = 'https://api.deepseek.com';
                        }
                        
                        // 确保系统提示词有值
                        if (!apiConfig.systemPrompt) {
                            apiConfig.systemPrompt = DEFAULT_SYSTEM_PROMPT;
                        }
                        
                        // 更新头像预览
                        if (apiConfig.customAvatar) {
                            avatarPreview.src = apiConfig.customAvatar;
                            // 同时更新欢迎页面头像
                            const welcomeAvatar = document.getElementById('welcome-avatar');
                            if (welcomeAvatar) {
                                welcomeAvatar.innerHTML = `<img src="${apiConfig.customAvatar}" alt="辣椒油">`;
                            }
                        } else {
                            avatarPreview.src = DEFAULT_AVATAR_SVG;
                        }
                        
                        // 更新UI
                        document.getElementById('api-provider').value = apiConfig.provider;
                        document.getElementById('openai-model').value = apiConfig.openaiModel || 'gpt-3.5-turbo';
                        document.getElementById('anthropic-model').value = apiConfig.anthropicModel || 'claude-3-opus-20240229';
                        document.getElementById('deepseek-model').value = apiConfig.deepseekModel || 'deepseek-chat';
                        document.getElementById('base-url').value = apiConfig.baseUrl;
                        document.getElementById('stream-response').checked = apiConfig.streamResponse !== false;
                        document.getElementById('encrypt-keys').checked = apiConfig.encryptKeys === true;
                        
                        // 更新API密钥字段 - 确保在移动端预填充
                        setTimeout(() => {
                            updateApiKeyField();
                            // 显示/隐藏相应的模型选择器
                            updateModelSelector();
                        }, 100);
                        
                        // 更新所有辣椒油头像的显示
                        updateAvatarDisplay();
                    } catch (err) {
                        console.error('加载API配置出错:', err);
                        showToast('加载设置失败，已重置为默认值', 'error');
                    }
                }
            };
            
            // 加密/解密API密钥
            function encryptApiKey(key) {
                if (!key) return '';
                // 简单加密，实际应用中应使用更强大的加密算法
                return btoa(key.split('').reverse().join(''));
            }
            
            function decryptApiKey(encryptedKey) {
                if (!encryptedKey) return '';
                try {
                    // 尝试解密
                    return atob(encryptedKey).split('').reverse().join('');
                } catch (e) {
                    console.error('解密密钥失败');
                    return '';
                }
            }
            
            // 保存API配置到localStorage
            const saveApiConfig = () => {
                const newProvider = document.getElementById('api-provider').value;
                const currentKey = document.getElementById('api-key').value.trim();
                const shouldEncrypt = document.getElementById('encrypt-keys').checked;
                
                // 保存加密设置
                apiConfig.encryptKeys = shouldEncrypt;
                
                // 根据当前显示的提供商保存API密钥
                if (newProvider === 'openai') {
                    if (currentKey) {
                        apiConfig.openaiApiKey = shouldEncrypt ? encryptApiKey(currentKey) : currentKey;
                    }
                } else if (newProvider === 'anthropic') {
                    if (currentKey) {
                        apiConfig.anthropicApiKey = shouldEncrypt ? encryptApiKey(currentKey) : currentKey;
                    }
                } else if (newProvider === 'deepseek') {
                    if (currentKey) {
                        apiConfig.deepseekApiKey = shouldEncrypt ? encryptApiKey(currentKey) : currentKey;
                    }
                }
                
                // 保存当前选择的提供商
                apiConfig.provider = newProvider;
                
                // 保存模型选择
                apiConfig.openaiModel = document.getElementById('openai-model').value;
                apiConfig.anthropicModel = document.getElementById('anthropic-model').value;
                apiConfig.deepseekModel = document.getElementById('deepseek-model').value;
                apiConfig.baseUrl = document.getElementById('base-url').value || 'https://api.deepseek.com';
                apiConfig.streamResponse = document.getElementById('stream-response').checked;
                
                // 保存系统提示词 (如果已授权显示)
                if (systemPromptContainer.style.display === 'block') {
                    apiConfig.systemPrompt = systemPromptTextarea.value;
                }
                
                // 保存到localStorage
                localStorage.setItem('apiConfig', JSON.stringify(apiConfig));
                settingsModal.style.display = 'none';
                showToast('设置已保存');
                
                // 更新头像显示
                updateAvatarDisplay();
                
                // 重置系统提示词验证状态
                systemPromptAuthContainer.style.display = 'block';
                systemPromptContainer.style.display = 'none';
                adminPasswordInput.value = '';
            };
            
            // 设置按钮点击事件
            settingsBtn.addEventListener('click', () => {
                settingsModal.style.display = 'flex';
            });
            
            // 保存设置按钮
            settingsSaveBtn.addEventListener('click', saveApiConfig);
            
            // 取消设置按钮
            settingsCancelBtn.addEventListener('click', () => {
                settingsModal.style.display = 'none';
            });
            
            // 点击模态窗口外部关闭
            window.addEventListener('click', function(e) {
                if (e.target === settingsModal) {
                    settingsModal.style.display = 'none';
                }
                if (e.target === confirmationModal) {
                    confirmationModal.style.display = 'none';
                }
                if (e.target === exportModal) {
                    exportModal.style.display = 'none';
                }
            });
            
            // API提供商变更事件
            apiProviderSelect.addEventListener('change', () => {
                // 先获取当前的provider，以便保存API key变更前的值
                const oldProvider = apiConfig.provider;
                
                // 更新provider为新选择的值
                apiConfig.provider = apiProviderSelect.value;
                
                // 更新模型选择器
                updateModelSelector();
                
                // 清除当前可能输入但未保存的API密钥
                const currentInputKey = apiKeyInput.value;
                
                // 如果当前输入不为空，且与之前保存的不同，询问是否保存
                if (currentInputKey && oldProvider !== apiConfig.provider) {
                    // 弹出提示
                    if (confirm(`是否保存刚才在${oldProvider}中输入但未保存的API密钥？`)) {
                        // 用户选择保存，则保存旧提供商的API key
                        if (oldProvider === 'openai') {
                            apiConfig.openaiApiKey = apiConfig.encryptKeys ? encryptApiKey(currentInputKey) : currentInputKey;
                        } else if (oldProvider === 'anthropic') {
                            apiConfig.anthropicApiKey = apiConfig.encryptKeys ? encryptApiKey(currentInputKey) : currentInputKey;
                        } else if (oldProvider === 'deepseek') {
                            apiConfig.deepseekApiKey = apiConfig.encryptKeys ? encryptApiKey(currentInputKey) : currentInputKey;
                        }
                    }
                }
                
                // 强制更新API密钥输入框，确保显示正确的值
                setTimeout(() => {
                    updateApiKeyField();
                    
                    // 显示提示信息
                    showToast(`已切换到${apiConfig.provider}供应商`);
                    
                    // 确保移动设备上的表单元素正常
                    if (window.innerWidth <= 768) {
                        apiKeyInput.style.fontSize = '16px';
                    }
                }, 100);
            });
            
            // 自动调整输入框高度并统计字符数
            inputBox.addEventListener('input', function() {
                // 自动调整高度
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
                
                // 统计字符数
                const length = this.value.trim().length;
                tokenCounter.textContent = `${length}/${MAX_MESSAGE_LENGTH} 字符`;
                
                // 根据长度改变提示颜色
                if (length > TOKEN_WARNING_THRESHOLD) {
                    tokenCounter.className = 'token-counter warning';
                } else if (length > MAX_MESSAGE_LENGTH) {
                    tokenCounter.className = 'token-counter error';
                } else {
                    tokenCounter.className = 'token-counter';
                }
                
                // 启用/禁用发送按钮
                sendBtn.disabled = !this.value.trim() || length > MAX_MESSAGE_LENGTH;
            });
            
            // 回车键发送消息
            inputBox.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (!sendBtn.disabled) {
                        sendMessage();
                    }
                }
            });
            
            // 发送按钮点击事件
            sendBtn.addEventListener('click', sendMessage);
            
            // 建议卡片点击事件
            suggestions.forEach(suggestion => {
                suggestion.addEventListener('click', function() {
                    const text = this.querySelector('p').textContent;
                    inputBox.value = text;
                    inputBox.dispatchEvent(new Event('input'));
                    sendMessage();
                });
            });
            
            // 新对话按钮点击事件
            newChatBtn.addEventListener('click', function() {
                startNewChat();
            });
            
            // 取消删除按钮事件
            cancelBtn.addEventListener('click', function() {
                confirmationModal.style.display = 'none';
                chatToDelete = null;
            });
            
            // 确认删除按钮事件
            confirmDeleteBtn.addEventListener('click', function() {
                if (chatToDelete) {
                    deleteChatById(chatToDelete);
                    confirmationModal.style.display = 'none';
                    chatToDelete = null;
                }
            });
            
            // 导出对话事件
            exportBtn.addEventListener('click', function() {
                if (chats.length === 0) {
                    showToast('没有可导出的对话', 'error');
                    return;
                }
                
                const dataStr = JSON.stringify(chats, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
                
                downloadLink.setAttribute('href', dataUri);
                exportModal.style.display = 'flex';
            });
            
            // 导入对话事件
            importBtn.addEventListener('click', function() {
                importFile.click();
            });
            
            importFile.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedChats = JSON.parse(e.target.result);
                        if (Array.isArray(importedChats) && importedChats.length > 0) {
                            // 合并导入的对话，避免重复
                            importedChats.forEach(chat => {
                                if (!chats.some(c => c.id === chat.id)) {
                                    chats.unshift(chat);
                                }
                            });
                            
                            updateChatHistory();
                            showToast(`成功导入 ${importedChats.length} 个对话`);
                            
                            // 如果导入后没有选择对话，加载第一个
                            if (!chats.some(c => c.id === chatId) && chats.length > 0) {
                                chatId = chats[0].id;
                                loadChat(chatId);
                            }
                        } else {
                            showToast('导入文件格式不正确', 'error');
                        }
                    } catch (err) {
                        console.error('导入对话出错:', err);
                        showToast('导入失败，文件格式不正确', 'error');
                    }
                    
                    // 重置文件输入
                    e.target.value = '';
                };
                reader.readAsText(file);
            });
            
            // 创建新对话
            function startNewChat() {
                // 创建新对话
                const newChatId = Date.now();
                const newChat = {
                    id: newChatId,
                    title: '新对话',
                    messages: []
                };
                
                chats.unshift(newChat);
                chatId = newChatId;
                currentChat = newChat;  // 设置当前对话为新创建的对话
                
                // 更新UI
                updateChatHistory();
                chatContainer.innerHTML = '';
                welcome.style.display = 'flex';
                chatContainer.style.display = 'none';
            }
            
            // 添加加载历史对话和保存对话功能
            function loadChatHistory() {
                const savedChats = localStorage.getItem('chats');
                if (savedChats) {
                    try {
                        chats = JSON.parse(savedChats);
                        
                        // 初始选择第一个对话
                        if (chats.length > 0) {
                            chatId = chats[0].id;
                            currentChat = chats[0];  // 设置当前对话
                            loadChat(chatId);
                        }
                        
                        updateChatHistory();
                    } catch (err) {
                        console.error('加载历史对话出错:', err);
                        chats = [];
                    }
                }
                
                // 在移动端确保历史区域可见
                if (window.innerWidth <= 768) {
                    setTimeout(() => {
                        manageSidebar();
                    }, 300);
                }
            }
            
            // 保存对话到本地存储
            function saveChats() {
                try {
                    localStorage.setItem('chats', JSON.stringify(chats));
                } catch (err) {
                    console.error('保存对话出错:', err);
                    // 如果是存储配额超出错误，可能需要清理一些旧对话
                    if (err.name === 'QuotaExceededError') {
                        showToast('本地存储空间已满，请导出一些对话并删除', 'error');
                    }
                }
            }
            
            // 更新聊天历史列表增强版，确保在移动端显示正常
            function updateChatHistory() {
                chatHistory.innerHTML = '';
                
                if (chats.length === 0) {
                    const emptyMsg = document.createElement('li');
                    emptyMsg.textContent = '暂无历史对话';
                    emptyMsg.style.padding = '10px';
                    emptyMsg.style.textAlign = 'center';
                    emptyMsg.style.color = 'var(--text-secondary)';
                    chatHistory.appendChild(emptyMsg);
                    return;
                }
                
                chats.forEach(chat => {
                    const li = document.createElement('li');
                    li.className = 'chat-item';
                    if (chat.id === chatId) {
                        li.classList.add('active');
                    }
                    
                    // 分为标题和删除按钮区域
                    const titleSpan = document.createElement('span');
                    titleSpan.className = 'chat-title';
                    titleSpan.textContent = chat.title;
                    
                    const deleteIcon = document.createElement('span');
                    deleteIcon.className = 'delete-chat';
                    deleteIcon.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                    `;
                    
                    li.appendChild(titleSpan);
                    li.appendChild(deleteIcon);
                    
                    // 点击标题区域切换对话
                    titleSpan.addEventListener('click', function(e) {
                        const clickedChatId = parseInt(li.dataset.id);
                        if (clickedChatId !== chatId) {
                            chatId = clickedChatId;
                            loadChat(chatId);
                            updateChatHistory();
                            
                            // 在移动端自动隐藏侧边栏
                            if (window.innerWidth <= 768) {
                                sidebar.classList.add('collapsed');
                                sidebar.style.maxHeight = '0';
                            }
                        }
                    });
                    
                    // 点击删除图标删除对话
                    deleteIcon.addEventListener('click', function(e) {
                        e.stopPropagation(); // 阻止事件冒泡
                        chatToDelete = parseInt(li.dataset.id);
                        confirmationModal.style.display = 'flex';
                    });
                    
                    li.dataset.id = chat.id;
                    chatHistory.appendChild(li);
                });
            }
            
            // 删除指定ID的对话
            function deleteChatById(id) {
                const index = chats.findIndex(chat => chat.id === id);
                if (index !== -1) {
                    chats.splice(index, 1);
                    
                    // 如果删除的是当前聊天，则切换到第一个聊天或显示欢迎页面
                    if (id === chatId) {
                        if (chats.length > 0) {
                            chatId = chats[0].id;
                            loadChat(chatId);
                        } else {
                            // 没有对话了，显示欢迎页面
                            welcome.style.display = 'flex';
                            chatContainer.style.display = 'none';
                        }
                    }
                    
                    updateChatHistory();
                    saveChats();
                }
            }
            
            // 加载特定对话
            function loadChat(id) {
                const chat = chats.find(c => c.id === id);
                
                if (chat) {
                    chatId = id;
                    currentChat = chat; // 设置当前对话
                    
                    // 关闭欢迎页面，显示聊天内容
                    welcome.style.display = 'none';
                    chatContainer.style.display = 'flex';
                    
                    // 清空聊天区域
                    chatContainer.innerHTML = '';
                    
                    // 显示所有消息
                    chat.messages.forEach(message => {
                        appendMessage(message.content, message.sender, false);
                    });
                    
                    // 滚动到底部
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                    
                    // 高亮当前选中的对话
                    const chatItems = document.querySelectorAll('.chat-item');
                    chatItems.forEach(item => {
                        if (parseInt(item.dataset.id) === id) {
                            item.classList.add('active');
                        } else {
                            item.classList.remove('active');
                        }
                    });
                }
            }
            
            // 添加"复制"按钮到代码块
            function addCopyButtonsToCodeBlocks() {
                const codeBlocks = document.querySelectorAll('.message-content pre');
                codeBlocks.forEach(block => {
                    // 避免重复添加复制按钮
                    if (block.querySelector('.copy-btn')) return;
                    
                    const copyBtn = document.createElement('button');
                    copyBtn.className = 'copy-btn';
                    copyBtn.textContent = '复制';
                    block.appendChild(copyBtn);
                    
                    copyBtn.addEventListener('click', function() {
                        const code = block.querySelector('code').textContent;
                        navigator.clipboard.writeText(code)
                            .then(() => {
                                const originalText = copyBtn.textContent;
                                copyBtn.textContent = '已复制!';
                                setTimeout(() => {
                                    copyBtn.textContent = originalText;
                                }, 2000);
                            })
                            .catch(err => {
                                console.error('复制失败:', err);
                            });
                    });
                });
            }
            
            // 应用语法高亮到所有代码块
            function applyHighlighting() {
                // 确保加载了足够的语言支持
                if (typeof hljs !== 'undefined') {
                    // 为常用语言加载语法高亮
                    if (!hljs.getLanguage('javascript') && hljs.registerLanguage) {
                        try {
                            hljs.registerLanguage('javascript', hljsjs);
                        } catch (e) {
                            console.warn('无法加载JavaScript语法高亮', e);
                        }
                    }
                    
                    // 应用高亮到所有代码块
                    document.querySelectorAll('pre code:not(.hljs)').forEach(block => {
                        hljs.highlightElement(block);
                    });
                    
                    // 添加复制按钮
                    addCopyButtonsToCodeBlocks();
                }
            }
            
            // 格式化消息内容（转换链接、代码块和换行符）
            function formatMessage(message) {
                if (!message) return '';
                
                // 首先提取所有代码块，以避免在代码块内进行其他替换
                const codeBlocks = [];
                message = message.replace(/```(\w*)([\s\S]*?)```/g, function(match, language, code) {
                    const placeholder = `__CODE_BLOCK_${codeBlocks.length}__`;
                    language = language.trim() || 'plaintext';
                    // 使用HTML实体保留代码的空格和换行
                    const formattedCode = code.replace(/&/g, '&amp;')
                                              .replace(/</g, '&lt;')
                                              .replace(/>/g, '&gt;');
                    codeBlocks.push(`<pre><code class="language-${language}">${formattedCode}</code></pre>`);
                    return placeholder;
                });
                
                // 转换内联代码 (`code`)
                message = message.replace(/`([^`]+)`/g, '<code>$1</code>');
                
                // 转换URL为链接
                message = message.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
                
                // 转换图片链接为图片标签 (![alt](url))
                message = message.replace(/!\[(.*?)\]\((https?:\/\/[^\s]+)\)/g, '<img src="$2" alt="$1" class="message-image">');
                
                // 转换换行符为<br>
                message = message.replace(/\n/g, '<br>');
                
                // 最后恢复代码块
                codeBlocks.forEach((block, i) => {
                    message = message.replace(`__CODE_BLOCK_${i}__`, block);
                });
                
                return message;
            }
            
            // 发送消息并获取AI响应
            async function sendMessage() {
                const message = inputBox.value.trim();
                if (!message) return;
                
                // 检查消息长度
                if (message.length > MAX_MESSAGE_LENGTH) {
                    showToast(`消息过长，最大限制 ${MAX_MESSAGE_LENGTH} 字符`, 'error');
                    return;
                }
                
                // 检查网络连接
                if (!isOnline) {
                    showToast('网络连接已断开，无法发送消息', 'error');
                    return;
                }
                
                // 检查API密钥是否已配置
                let currentApiKey = '';
                if (apiConfig.provider === 'openai') {
                    currentApiKey = apiConfig.encryptKeys ? decryptApiKey(apiConfig.openaiApiKey) : apiConfig.openaiApiKey;
                } else if (apiConfig.provider === 'anthropic') {
                    currentApiKey = apiConfig.encryptKeys ? decryptApiKey(apiConfig.anthropicApiKey) : apiConfig.anthropicApiKey;
                } else if (apiConfig.provider === 'deepseek') {
                    currentApiKey = apiConfig.encryptKeys ? decryptApiKey(apiConfig.deepseekApiKey) : apiConfig.deepseekApiKey;
                }
                
                if (!currentApiKey) {
                    showToast(`请先在设置中配置${apiConfig.provider}的API密钥`, 'error');
                    return;
                }
                
                // 清空输入框并禁用按钮
                inputBox.value = '';
                sendBtn.disabled = true;
                sendBtn.style.opacity = '0.5';
                
                // 添加用户消息到聊天界面
                appendMessage(message, 'user');
                
                // 添加一个AI消息框但仅显示加载状态
                const aiMessageDiv = document.createElement('div');
                aiMessageDiv.className = 'message ai loading-message';  // 添加loading-message类
                
                let avatarContent;
                if (apiConfig.customAvatar) {
                    avatarContent = `<img src="${apiConfig.customAvatar}" alt="辣椒油">`;
                } else {
                    avatarContent = '辣';
                }
                
                // 直接包含加载动画作为独立HTML
                aiMessageDiv.innerHTML = `
                    <div class="message-header">
                        <div class="avatar">${avatarContent}</div>
                        <div class="name">辣椒油</div>
                    </div>
                    <div class="message-content" style="display:block">
                        <div class="loading" style="display:inline-block;margin:15px 0"><div></div><div></div><div></div><div></div></div>
                    </div>
                `;
                
                chatContainer.appendChild(aiMessageDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
                
                // 关闭欢迎页面，显示聊天界面
                welcome.style.display = 'none';
                chatContainer.style.display = 'flex';
                
                // 确保当前聊天存在
                if (!currentChat) {
                    currentChat = {
                        id: Date.now(),
                        title: message.substring(0, 30) + (message.length > 30 ? '...' : ''),
                        messages: []
                    };
                    chats.unshift(currentChat);
                    updateChatHistory();
                }
                
                // 添加消息到聊天历史
                currentChat.messages.push({
                    content: message,
                    sender: 'user',
                    timestamp: new Date().toISOString()
                });
                
                // 保存聊天历史
                saveChats();
                
                let controller = new AbortController();
                let timeoutId = setTimeout(() => {
                    // 如果请求超过30秒未响应，则中断
                    controller.abort();
                    showToast('请求超时，请检查网络连接和API状态', 'error');
                }, 30000);
                
                try {
                    let aiResponse = '';
                    
                    // 根据配置选择API调用方式
                    if (apiConfig.streamResponse) {
                        // 显示消息内容区域，准备接收流式响应
                        const messageContent = aiMessageDiv.querySelector('.message-content');
                        messageContent.style.display = 'block';
                        
                        // 确保loading动画依然可见 - 不清空内容
                        const loadingElement = messageContent.querySelector('.loading');
                        if (loadingElement) {
                            loadingElement.style.display = 'inline-block';
                        }
                        
                        // 流式响应处理
                        if (apiConfig.provider === 'openai') {
                            await callOpenAIStream(message, currentChat.messages.slice(0, -1), (chunk) => {
                                // 只有当收到有意义的响应内容时才移除loading动画
                                if (aiResponse === '' && chunk && chunk.trim().length > 5) {
                                    const loadingElement = messageContent.querySelector('.loading');
                                    if (loadingElement) {
                                        loadingElement.remove();
                                    }
                                }
                                
                                aiResponse += chunk;
                                if (aiResponse.trim()) { // 确保只有在有实际内容时才更新
                                    messageContent.innerHTML = formatMessage(aiResponse);
                                    
                                    // 对新增的代码块应用高亮
                                    const codeBlocks = messageContent.querySelectorAll('pre code:not(.hljs)');
                                    codeBlocks.forEach(block => {
                                        hljs.highlightElement(block);
                                    });
                                    
                                    // 添加复制按钮
                                    addCopyButtonsToCodeBlocks();
                                }
                                
                                chatContainer.scrollTop = chatContainer.scrollHeight;
                            }, controller.signal);
                        } else if (apiConfig.provider === 'anthropic') {
                            await callClaudeStream(message, currentChat.messages.slice(0, -1), (chunk) => {
                                // 只有当收到有意义的响应内容时才移除loading动画
                                if (aiResponse === '' && chunk && chunk.trim().length > 5) {
                                    const loadingElement = messageContent.querySelector('.loading');
                                    if (loadingElement) {
                                        loadingElement.remove();
                                    }
                                }
                                
                                aiResponse += chunk;
                                if (aiResponse.trim()) { // 确保只有在有实际内容时才更新
                                    messageContent.innerHTML = formatMessage(aiResponse);
                                    
                                    // 对新增的代码块应用高亮
                                    const codeBlocks = messageContent.querySelectorAll('pre code:not(.hljs)');
                                    codeBlocks.forEach(block => {
                                        hljs.highlightElement(block);
                                    });
                                    
                                    // 添加复制按钮
                                    addCopyButtonsToCodeBlocks();
                                }
                                
                                chatContainer.scrollTop = chatContainer.scrollHeight;
                            }, controller.signal);
                        } else if (apiConfig.provider === 'deepseek') {
                            await callDeepSeekStream(message, currentChat.messages.slice(0, -1), (chunk) => {
                                // 只有当收到有意义的响应内容时才移除loading动画
                                if (aiResponse === '' && chunk && chunk.trim().length > 5) {
                                    const loadingElement = messageContent.querySelector('.loading');
                                    if (loadingElement) {
                                        loadingElement.remove();
                                    }
                                }
                                
                                aiResponse += chunk;
                                if (aiResponse.trim()) { // 确保只有在有实际内容时才更新
                                    messageContent.innerHTML = formatMessage(aiResponse);
                                    
                                    // 对新增的代码块应用高亮
                                    const codeBlocks = messageContent.querySelectorAll('pre code:not(.hljs)');
                                    codeBlocks.forEach(block => {
                                        hljs.highlightElement(block);
                                    });
                                    
                                    // 添加复制按钮
                                    addCopyButtonsToCodeBlocks();
                                }
                                
                                chatContainer.scrollTop = chatContainer.scrollHeight;
                            }, controller.signal);
                        }
                    } else {
                        // 非流式响应
                        if (apiConfig.provider === 'openai') {
                            aiResponse = await callOpenAI(message, currentChat.messages.slice(0, -1), controller.signal);
                        } else if (apiConfig.provider === 'anthropic') {
                            aiResponse = await callClaude(message, currentChat.messages.slice(0, -1), controller.signal);
                        } else if (apiConfig.provider === 'deepseek') {
                            aiResponse = await callDeepSeek(message, currentChat.messages.slice(0, -1), controller.signal);
                        }
                    }
                    
                    clearTimeout(timeoutId);
                    
                    // 清除加载状态
                    const loadingElement = aiMessageDiv.querySelector('.loading');
                    if (loadingElement) {
                        loadingElement.remove();
                    }
                    
                    // 对于非流式响应，设置完整回复
                    if (!apiConfig.streamResponse) {
                        aiMessageDiv.querySelector('.message-content').style.display = 'block';
                        aiMessageDiv.querySelector('.message-content').innerHTML = formatMessage(aiResponse);
                        
                        // 应用代码高亮
                        const codeBlocks = aiMessageDiv.querySelectorAll('pre code');
                        codeBlocks.forEach(block => {
                            hljs.highlightElement(block);
                        });
                        
                        // 添加复制按钮
                        addCopyButtonsToCodeBlocks();
                    }
                    
                    // 保存AI回复到历史记录
                    currentChat.messages.push({
                        content: aiResponse,
                        sender: 'ai',
                        timestamp: new Date().toISOString()
                    });
                    
                    // 保存对话历史
                    saveChats();
                    
                    // 重新启用发送按钮
                    sendBtn.disabled = false;
                    sendBtn.style.opacity = '1';
                    
                    // 滚动到底部
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                    
                } catch (error) {
                    clearTimeout(timeoutId);
                    console.error('获取AI响应时出错:', error);
                    
                    // 清除加载状态
                    const loadingElement = aiMessageDiv.querySelector('.loading');
                    if (loadingElement) {
                        loadingElement.remove();
                    }
                    
                    // 显示错误消息
                    aiMessageDiv.querySelector('.message-content').style.display = 'block';
                    
                    let errorMessage = '调用AI API时出现问题，请检查您的API密钥和网络连接。';
                    
                    if (error.name === 'AbortError') {
                        errorMessage = '请求已超时或被中断，请稍后重试。';
                    } else if (error.message) {
                        errorMessage = `错误: ${error.message}`;
                    }
                    
                    aiMessageDiv.querySelector('.message-content').textContent = errorMessage;
                    
                    // 保存错误消息到历史记录
                    currentChat.messages.push({
                        content: errorMessage,
                        sender: 'ai',
                        timestamp: new Date().toISOString()
                    });
                    
                    // 保存对话历史
                    saveChats();
                    
                    // 重新启用发送按钮
                    sendBtn.disabled = false;
                    sendBtn.style.opacity = '1';
                }
            }
            
            // 调用OpenAI API (非流式)
            async function callOpenAI(message, history, signal) {
                const messages = [];
                
                // 添加系统消息 (如果设置了系统提示词)
                if (apiConfig.systemPrompt) {
                    messages.push({
                        role: 'system',
                        content: apiConfig.systemPrompt
                    });
                }
                
                // 添加历史消息
                history.forEach(msg => {
                    messages.push({
                        role: msg.sender === 'user' ? 'user' : 'assistant',
                        content: msg.content
                    });
                });
                
                // 添加当前用户消息
                messages.push({
                    role: 'user',
                    content: message
                });
                
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiConfig.encryptKeys ? decryptApiKey(apiConfig.openaiApiKey) : apiConfig.openaiApiKey}`
                    },
                    body: JSON.stringify({
                        model: apiConfig.openaiModel,
                        messages: messages,
                        max_tokens: 2000,
                        temperature: 0.7
                    }),
                    signal: signal
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || `API请求失败: ${response.status}`);
                }
                
                const data = await response.json();
                return data.choices[0].message.content;
            }
            
            // 调用OpenAI API (流式)
            async function callOpenAIStream(message, history, onChunk, signal) {
                const messages = [];
                
                // 添加系统消息 (如果设置了系统提示词)
                if (apiConfig.systemPrompt) {
                    messages.push({
                        role: 'system',
                        content: apiConfig.systemPrompt
                    });
                }
                
                // 添加历史消息
                history.forEach(msg => {
                    messages.push({
                        role: msg.sender === 'user' ? 'user' : 'assistant',
                        content: msg.content
                    });
                });
                
                // 添加当前用户消息
                messages.push({
                    role: 'user',
                    content: message
                });
                
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiConfig.encryptKeys ? decryptApiKey(apiConfig.openaiApiKey) : apiConfig.openaiApiKey}`
                    },
                    body: JSON.stringify({
                        model: apiConfig.openaiModel,
                        messages: messages,
                        max_tokens: 2000,
                        temperature: 0.7,
                        stream: true
                    }),
                    signal: signal
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    try {
                        const errorJson = JSON.parse(errorText);
                        throw new Error(errorJson.error?.message || `API请求失败: ${response.status}`);
                    } catch (e) {
                        throw new Error(`API请求失败: ${response.status} - ${errorText}`);
                    }
                }
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder('utf-8');
                let buffer = '';
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.substring(6);
                            if (data === '[DONE]') continue;
                            
                            try {
                                const parsed = JSON.parse(data);
                                const content = parsed.choices[0]?.delta?.content || '';
                                if (content) {
                                    onChunk(content);
                                }
                            } catch (e) {
                                console.error('解析流式数据出错:', e);
                            }
                        }
                    }
                }
            }
            
            // 调用Claude API (非流式)
            async function callClaude(message, history, signal) {
                // 使用Anthropic API v1版本（messages API）
                const messages = [];
                
                // 添加历史消息
                history.forEach(msg => {
                    messages.push({
                        role: msg.sender === 'user' ? 'user' : 'assistant',
                        content: msg.content
                    });
                });
                
                // 添加当前用户消息
                messages.push({
                    role: 'user',
                    content: message
                });
                
                const requestBody = {
                    model: apiConfig.anthropicModel,
                    messages: messages,
                    max_tokens: 2000
                };
                
                // Claude使用system参数而不是message
                if (apiConfig.systemPrompt) {
                    requestBody.system = apiConfig.systemPrompt;
                }
                
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiConfig.encryptKeys ? decryptApiKey(apiConfig.anthropicApiKey) : apiConfig.anthropicApiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify(requestBody),
                    signal: signal
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || `API请求失败: ${response.status}`);
                }
                
                const data = await response.json();
                return data.content[0].text;
            }
            
            // 调用Claude API (流式)
            async function callClaudeStream(message, history, onChunk, signal) {
                // 使用Anthropic API v1版本（messages API）
                const messages = [];
                
                // 添加历史消息
                history.forEach(msg => {
                    messages.push({
                        role: msg.sender === 'user' ? 'user' : 'assistant',
                        content: msg.content
                    });
                });
                
                // 添加当前用户消息
                messages.push({
                    role: 'user',
                    content: message
                });
                
                const requestBody = {
                    model: apiConfig.anthropicModel,
                    messages: messages,
                    max_tokens: 2000,
                    stream: true
                };
                
                // Claude使用system参数而不是message
                if (apiConfig.systemPrompt) {
                    requestBody.system = apiConfig.systemPrompt;
                }
                
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiConfig.encryptKeys ? decryptApiKey(apiConfig.anthropicApiKey) : apiConfig.anthropicApiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify(requestBody),
                    signal: signal
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    try {
                        const errorJson = JSON.parse(errorText);
                        throw new Error(errorJson.error?.message || `API请求失败: ${response.status}`);
                    } catch (e) {
                        throw new Error(`API请求失败: ${response.status} - ${errorText}`);
                    }
                }
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder('utf-8');
                let buffer = '';
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    buffer += decoder.decode(value, { stream: true });
                    
                    // 处理带有data: 前缀的行
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.substring(6);
                            if (data === '[DONE]') continue;
                            
                            try {
                                const parsed = JSON.parse(data);
                                if (parsed.type === 'content_block_delta' && parsed.delta?.text) {
                                    onChunk(parsed.delta.text);
                                }
                            } catch (e) {
                                console.error('解析Claude流式数据出错:', e);
                            }
                        }
                    }
                }
            }
            
            // 调用DeepSeek API (非流式)
            async function callDeepSeek(message, history, signal) {
                const messages = [];
                
                // 添加系统消息 (如果设置了系统提示词)
                if (apiConfig.systemPrompt) {
                    messages.push({
                        role: 'system',
                        content: apiConfig.systemPrompt
                    });
                }
                
                // 添加历史消息
                history.forEach(msg => {
                    messages.push({
                        role: msg.sender === 'user' ? 'user' : 'assistant',
                        content: msg.content
                    });
                });
                
                // 添加当前用户消息
                messages.push({
                    role: 'user',
                    content: message
                });
                
                const response = await fetch(`${apiConfig.baseUrl}/v1/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiConfig.encryptKeys ? decryptApiKey(apiConfig.deepseekApiKey) : apiConfig.deepseekApiKey}`
                    },
                    body: JSON.stringify({
                        model: apiConfig.deepseekModel,
                        messages: messages,
                        max_tokens: 2000,
                        temperature: 0.7
                    }),
                    signal: signal
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    try {
                        const errorJson = JSON.parse(errorText);
                        throw new Error(errorJson.error?.message || `API请求失败: ${response.status}`);
                    } catch (e) {
                        throw new Error(`API请求失败: ${response.status} - ${errorText}`);
                    }
                }
                
                const data = await response.json();
                return data.choices[0].message.content;
            }
            
            // 调用DeepSeek API (流式)
            async function callDeepSeekStream(message, history, onChunk, signal) {
                const messages = [];
                
                // 添加系统消息 (如果设置了系统提示词)
                if (apiConfig.systemPrompt) {
                    messages.push({
                        role: 'system',
                        content: apiConfig.systemPrompt
                    });
                }
                
                // 添加历史消息
                history.forEach(msg => {
                    messages.push({
                        role: msg.sender === 'user' ? 'user' : 'assistant',
                        content: msg.content
                    });
                });
                
                // 添加当前用户消息
                messages.push({
                    role: 'user',
                    content: message
                });
                
                const response = await fetch(`${apiConfig.baseUrl}/v1/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiConfig.encryptKeys ? decryptApiKey(apiConfig.deepseekApiKey) : apiConfig.deepseekApiKey}`
                    },
                    body: JSON.stringify({
                        model: apiConfig.deepseekModel,
                        messages: messages,
                        max_tokens: 2000,
                        temperature: 0.7,
                        stream: true
                    }),
                    signal: signal
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    try {
                        const errorJson = JSON.parse(errorText);
                        throw new Error(errorJson.error?.message || `API请求失败: ${response.status}`);
                    } catch (e) {
                        throw new Error(`API请求失败: ${response.status} - ${errorText}`);
                    }
                }
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder('utf-8');
                let buffer = '';
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.substring(6);
                            if (data === '[DONE]') continue;
                            
                            try {
                                const parsed = JSON.parse(data);
                                const content = parsed.choices[0]?.delta?.content || '';
                                if (content) {
                                    onChunk(content);
                                }
                            } catch (e) {
                                console.error('解析流式数据出错:', e);
                            }
                        }
                    }
                }
            }
            
            // 完善更新所有辣椒油头像的显示函数
            function updateAvatarDisplay() {
                if (apiConfig.customAvatar) {
                    // 欢迎页面头像
                    const welcomeAvatar = document.getElementById('welcome-avatar');
                    if (welcomeAvatar) {
                        welcomeAvatar.innerHTML = `<img src="${apiConfig.customAvatar}" alt="辣椒油">`;
                    }
                    
                    // 已有消息中的头像
                    const aiAvatars = document.querySelectorAll('.message.ai .avatar');
                    aiAvatars.forEach(avatar => {
                        avatar.innerHTML = `<img src="${apiConfig.customAvatar}" alt="辣椒油">`;
                    });
                } else {
                    // 恢复默认头像
                    const welcomeAvatar = document.getElementById('welcome-avatar');
                    if (welcomeAvatar) {
                        welcomeAvatar.innerHTML = '🌶️';
                    }
                    
                    // 恢复消息中的默认头像
                    const aiAvatars = document.querySelectorAll('.message.ai .avatar');
                    aiAvatars.forEach(avatar => {
                        avatar.innerHTML = '辣';
                    });
                }
            }
            
            // 页面加载完成后需要执行的移动端优化函数
            function optimizeForMobile() {
                // 特殊处理iOS设备
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
                if (isIOS) {
                    // 优化iOS表单控件
                    document.querySelectorAll('input, textarea, select').forEach(el => {
                        el.style.fontSize = '16px'; // 避免iOS缩放
                    });
                    
                    // 修复iOS固定定位元素问题
                    document.querySelector('.input-container').style.position = 'fixed';
                }
                
                // 修复部分Android设备的渲染问题
                if (/Android/.test(navigator.userAgent)) {
                    document.body.style.WebkitOverflowScrolling = 'touch';
                    // 修复一些Android设备上的模态框显示问题
                    document.querySelectorAll('.modal').forEach(modal => {
                        modal.addEventListener('touchmove', function(e) {
                            e.stopPropagation();
                        }, { passive: false });
                    });
                }
                
                // 确保模态框在移动设备上滚动正常
                document.querySelectorAll('.modal-content, .settings-content').forEach(content => {
                    content.style.maxHeight = 'calc(100vh - 60px)';
                    content.style.overflowY = 'auto';
                    content.style.WebkitOverflowScrolling = 'touch';
                });
                
                // 确保设置按钮始终可见
                document.querySelector('.settings-buttons').style.position = 'sticky';
                document.querySelector('.settings-buttons').style.bottom = '0';
                document.querySelector('.settings-buttons').style.background = 'var(--card-color)';
                document.querySelector('.settings-buttons').style.padding = '10px 0';
                document.querySelector('.settings-buttons').style.zIndex = '10';
                
                // 确保历史记录区域在移动端正确显示
                if (window.innerWidth <= 768) {
                    sidebar.style.maxHeight = sidebar.classList.contains('collapsed') ? '0' : '150px';
                }
            }
            
            // 在页面关闭前保存数据
            window.addEventListener('beforeunload', saveChats);
            
            // 初始化函数，确保在页面加载时正确执行
            function initializeApp() {
                // 先加载API配置
                loadApiConfig();
                
                // 加载历史对话
                loadChatHistory();
                
                // 如果没有对话，创建一个新对话
                if (chats.length === 0) {
                    startNewChat();
                }
                
                // 调整移动端布局
                setTimeout(() => {
                    manageSidebar();
                    adjustModalForMobile();
                    optimizeForMobile();
                }, 300);
                
                // 确保API提供商模型选择正确
                setTimeout(() => {
                    apiProviderSelect.dispatchEvent(new Event('change'));
                }, 500);
            }
            
            // 执行初始化
            initializeApp();
            
            // 侧边栏切换功能
            sidebarToggle.addEventListener('click', function() {
                sidebar.classList.toggle('collapsed');
                
                // 如果是折叠状态，则展开
                if (sidebar.classList.contains('collapsed')) {
                    sidebar.style.maxHeight = '0';
                } else {
                    // 在移动端展开时，确保有足够高度显示历史对话
                    if (window.innerWidth <= 768) {
                        sidebar.style.maxHeight = '150px';
                    } else {
                        sidebar.style.maxHeight = 'none';
                    }
                }
            });
            
            // 确保移动端加载时侧边栏正确显示
            function adjustSidebarForMobile() {
                if (window.innerWidth <= 768) {
                    if (!sidebar.classList.contains('collapsed')) {
                        sidebar.style.maxHeight = '150px';
                    }
                } else {
                    sidebar.style.maxHeight = 'none';
                }
                
                // 重新调整模态窗口中表单控件的布局
                if (window.innerWidth <= 480) {
                    const formGroups = document.querySelectorAll('.form-group');
                    formGroups.forEach(group => {
                        group.style.marginBottom = '16px';
                    });
                }
            }
            
            // 页面加载和窗口大小变化时调用
            window.addEventListener('resize', adjustSidebarForMobile);
            setTimeout(adjustSidebarForMobile, 100);
            
            // 移动设备上点击聊天区域自动隐藏侧边栏
            function hideMenuOnMobile() {
                if (window.innerWidth <= 768 && !sidebar.classList.contains('collapsed')) {
                    sidebar.classList.add('collapsed');
                }
            }
            
            chatContainer.addEventListener('click', hideMenuOnMobile);
            welcome.addEventListener('click', hideMenuOnMobile);
            
            // 在移动设备上，在当前对话中点击时也隐藏侧边栏
            document.addEventListener('click', function(e) {
                if (window.innerWidth <= 768 && 
                    !sidebar.contains(e.target) && 
                    !sidebarToggle.contains(e.target)) {
                    sidebar.classList.add('collapsed');
                }
            });
            
            // 处理窗口大小变化
            window.addEventListener('resize', function() {
                // 在大屏幕上，如果侧边栏是折叠的，则展开
                if (window.innerWidth > 768 && sidebar.classList.contains('collapsed')) {
                    sidebar.classList.remove('collapsed');
                }
                
                // 调整输入框高度
                inputBox.style.height = 'auto';
                inputBox.style.height = (inputBox.scrollHeight) + 'px';
            });
            
            // 改进移动端的滚动体验
            function overrideNativeScroll() {
                if (window.innerWidth <= 768) {
                    chatContainer.style.overscrollBehavior = 'contain';
                    document.body.style.overscrollBehavior = 'none';
                } else {
                    chatContainer.style.overscrollBehavior = 'auto';
                    document.body.style.overscrollBehavior = 'auto';
                }
            }
            
            overrideNativeScroll();
            window.addEventListener('resize', overrideNativeScroll);
            
            // 优化移动端文本输入框处理
            inputBox.addEventListener('focus', function() {
                // 在移动设备上聚焦输入框时自动滚动到底部
                if (window.innerWidth <= 768) {
                    setTimeout(() => {
                        window.scrollTo(0, document.body.scrollHeight);
                    }, 300);
                }
            });
            
            // 修复模态窗口在移动端的显示问题
            function adjustModalForMobile() {
                const isMobile = window.innerWidth <= 768;
                
                if (isMobile) {
                    // 设置模态窗口
                    const modals = document.querySelectorAll('.modal-content, .settings-content');
                    modals.forEach(modal => {
                        modal.style.maxHeight = '80vh';
                        modal.style.overflowY = 'auto';
                    });
                    
                    // 设置按钮
                    const settingsButtons = document.querySelector('.settings-buttons');
                    if (settingsButtons) {
                        settingsButtons.style.position = 'sticky';
                        settingsButtons.style.bottom = '0';
                        settingsButtons.style.backgroundColor = 'var(--card-color)';
                        settingsButtons.style.zIndex = '10';
                        settingsButtons.style.padding = '10px 0';
                    }
                }
            }
            
            // 修复设置按钮在某些情况下不可见的问题
            settingsBtn.addEventListener('click', () => {
                settingsModal.style.display = 'flex';
                adjustModalForMobile();
                
                // 确保API密钥输入框正确填充
                setTimeout(() => {
                    updateApiKeyField();
                }, 100);
            });
            
            // 在页面加载和窗口大小变化时调整侧边栏和模态窗口
            window.addEventListener('resize', () => {
                manageSidebar();
                adjustModalForMobile();
            });
            
            setTimeout(() => {
                manageSidebar();
                adjustModalForMobile();
                
                // 确保API提供商模型选择正确
                apiProviderSelect.dispatchEvent(new Event('change'));
            }, 100);
            
            // 侧边栏高度和可见性管理函数 - 增强版
            function manageSidebar() {
                const isMobile = window.innerWidth <= 768;
                
                if (isMobile) {
                    // 如果是移动端且侧边栏未折叠，设置适当高度
                    if (!sidebar.classList.contains('collapsed')) {
                        sidebar.style.maxHeight = '150px';
                        sidebar.style.overflowY = 'auto';
                    } else {
                        sidebar.style.maxHeight = '0';
                    }
                } else {
                    // 桌面端
                    sidebar.style.maxHeight = 'none';
                    sidebar.classList.remove('collapsed');
                }
                
                // 确保历史对话项可见
                setTimeout(() => {
                    if (!sidebar.classList.contains('collapsed') && isMobile) {
                        const chatItems = document.querySelectorAll('.chat-item');
                        if (chatItems.length > 0) {
                            chatItems[0].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        }
                    }
                }, 300);
            }
            
            // 添加消息到聊天界面
            function appendMessage(content, sender, shouldScroll = true) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}`;
                
                const headerName = sender === 'user' ? '您' : '辣椒油';
                
                // 构建头像内容
                let avatarContent;
                if (sender === 'user') {
                    avatarContent = '您';
                } else {
                    if (apiConfig.customAvatar) {
                        avatarContent = `<img src="${apiConfig.customAvatar}" alt="辣椒油">`;
                    } else {
                        avatarContent = '辣';
                    }
                }
                
                // 格式化消息内容
                const formattedContent = formatMessage(content);
                
                messageDiv.innerHTML = `
                    <div class="message-header">
                        <div class="avatar">${avatarContent}</div>
                        <div class="name">${headerName}</div>
                    </div>
                    <div class="message-content">${formattedContent}</div>
                `;
                
                chatContainer.appendChild(messageDiv);
                
                // 应用代码高亮和添加复制按钮
                if (sender === 'ai') {
                    applyHighlighting();
                }
                
                if (shouldScroll) {
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }
            }
        });
    </script>
</body>
</html>
